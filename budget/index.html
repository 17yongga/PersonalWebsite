<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinSync - Couples Finance Made Simple</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #0a0a1a;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-start: #6366f1;
            --accent-end: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --glass-bg: rgba(255, 255, 255, 0.02);
            --glass-border: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* Background Pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(6, 182, 212, 0.1) 0%, transparent 50%);
            z-index: -1;
            pointer-events: none;
        }

        /* Glass Card */
        .glass-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            padding: 24px;
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        /* Layout */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-header h1 {
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 28px;
            font-weight: 700;
            text-align: center;
        }

        .tab-nav {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        .app-content {
            flex: 1;
            padding: 0 20px 40px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .month-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 32px;
        }

        .month-nav button {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .month-nav button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .current-month {
            font-size: 24px;
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-start);
            background: rgba(255, 255, 255, 0.08);
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            background: #1a1a2e;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
        }

        .form-select option,
        select option {
            background: #1a1a2e;
            color: #ffffff;
        }

        .btn {
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            box-shadow: none;
        }

        .btn-danger {
            background: var(--danger);
        }

        /* Quick Add Form */
        .quick-add {
            margin-bottom: 32px;
        }

        .natural-input {
            font-size: 18px;
            padding: 16px 20px;
            margin-bottom: 16px;
        }

        .quick-add-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        /* Expense List */
        .expense-list {
            border-radius: 16px;
            overflow: hidden;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
        }

        .expense-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: between;
            align-items: center;
            gap: 16px;
        }

        .expense-item:last-child {
            border-bottom: none;
        }

        .expense-details {
            flex: 1;
        }

        .expense-amount {
            font-weight: 600;
            font-size: 18px;
        }

        .expense-meta {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }

        .expense-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 8px;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        /* AI Insights */
        .insights-panel {
            margin-bottom: 32px;
        }

        .insight-item {
            padding: 16px;
            margin-bottom: 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            border-left: 4px solid var(--accent-start);
        }

        .insight-item.warning {
            border-left-color: var(--warning);
        }

        .insight-item.danger {
            border-left-color: var(--danger);
        }

        .health-score {
            text-align: center;
            margin-bottom: 20px;
        }

        .health-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            position: relative;
        }

        .health-circle.excellent {
            background: conic-gradient(var(--success) 0deg, var(--success) calc(var(--score) * 3.6deg), var(--glass-bg) calc(var(--score) * 3.6deg));
        }

        .health-circle.good {
            background: conic-gradient(var(--warning) 0deg, var(--warning) calc(var(--score) * 3.6deg), var(--glass-bg) calc(var(--score) * 3.6deg));
        }

        .health-circle.poor {
            background: conic-gradient(var(--danger) 0deg, var(--danger) calc(var(--score) * 3.6deg), var(--glass-bg) calc(var(--score) * 3.6deg));
        }

        /* Settlement */
        .settlement-card {
            text-align: center;
            margin-bottom: 24px;
        }

        .settlement-amount {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .settlement-amount.positive {
            color: var(--success);
        }

        .settlement-amount.negative {
            color: var(--danger);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        /* Progress Bars */
        .progress-bar {
            background: var(--glass-bg);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 0.3s ease;
            background: linear-gradient(90deg, var(--accent-start), var(--accent-end));
        }

        .progress-fill.warning {
            background: var(--warning);
        }

        .progress-fill.danger {
            background: var(--danger);
        }

        /* Budget Items */
        .budget-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .budget-item:last-child {
            border-bottom: none;
        }

        .budget-info {
            flex: 1;
        }

        .budget-category {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .budget-spent {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .budget-amount {
            font-weight: 600;
            min-width: 80px;
            text-align: right;
        }

        /* Mobile Navigation */
        .tab-text {
            margin-left: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-header h1 {
                font-size: 24px;
            }
            
            .tab-nav {
                padding: 16px;
                gap: 8px;
            }
            
            .tab-btn {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .tab-text {
                display: none;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .expense-item {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .expense-actions {
                justify-content: center;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--glass-border);
            border-radius: 50%;
            border-top-color: var(--accent-start);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-input {
            flex: 1;
            min-width: 200px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--glass-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Login/Register System */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(20px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            backdrop-filter: blur(40px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            transform: translateY(20px);
            animation: slideUp 0.5s ease forwards 0.2s;
        }

        @keyframes slideUp {
            to {
                transform: translateY(0);
            }
        }

        .auth-header {
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 16px;
        }

        .auth-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .auth-toggle button {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .auth-toggle button.active {
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            color: white;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .auth-input {
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--accent-start);
            background: rgba(255, 255, 255, 0.1);
        }

        .auth-btn {
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 8px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .partner-inputs {
            display: none;
        }

        .partner-inputs.show {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Onboarding System */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(10, 10, 26, 0.98);
            backdrop-filter: blur(20px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .onboarding-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 48px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            backdrop-filter: blur(40px);
            position: relative;
        }

        .onboarding-progress {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
        }

        .onboarding-step {
            display: none;
        }

        .onboarding-step.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        .onboarding-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .onboarding-text {
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .onboarding-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .skip-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-secondary);
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .skip-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            backdrop-filter: blur(20px);
            z-index: 2000;
            transform: translateX(400px);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: rgba(239, 68, 68, 0.9);
        }

        .toast.warning {
            background: rgba(245, 158, 11, 0.9);
        }

        /* Receipt Scanning Styles */
        .upload-area {
            border: 2px dashed var(--glass-border);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 24px;
        }

        .upload-area:hover {
            border-color: var(--accent-start);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--accent-start);
            background: rgba(99, 102, 241, 0.1);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--text-secondary);
        }

        .upload-text {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .upload-hint {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 8px;
            opacity: 0.7;
        }

        .image-preview {
            margin-bottom: 24px;
            text-align: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .scan-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 32px;
        }

        .scan-loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .scan-loading.show {
            display: block;
        }

        .scan-results {
            display: none;
        }

        .scan-results.show {
            display: block;
        }

        .scan-result-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .scan-result-item.selected {
            border-color: var(--accent-start);
            background: rgba(99, 102, 241, 0.05);
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .result-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .result-fields {
            display: grid;
            grid-template-columns: 2fr 1fr 1.5fr 1fr;
            gap: 12px;
            align-items: center;
        }

        .result-field {
            display: flex;
            flex-direction: column;
        }

        .result-field label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .result-field input,
        .result-field select {
            padding: 8px 12px;
            background: #1a1a2e;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .result-field select option {
            background: #1a1a2e;
            color: #ffffff;
        }

        .result-field input:focus,
        .result-field select:focus {
            outline: none;
            border-color: var(--accent-start);
        }

        .shared-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }

        .shared-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .scan-summary {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }

        .summary-total {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-start);
            margin-bottom: 8px;
        }

        .summary-count {
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .api-key-input {
            position: relative;
        }

        .api-key-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
        }

        .api-status {
            margin-top: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .api-status.set {
            color: var(--success);
        }

        .api-status.not-set {
            color: var(--warning);
        }

        @media (max-width: 768px) {
            .result-fields {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .upload-area {
                padding: 30px 15px;
            }
            
            .upload-icon {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <!-- Login/Register Overlay -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-card">
            <h1 class="auth-header">FinSync</h1>
            <p class="auth-subtitle">Couples Finance Made Simple</p>
            
            <div class="auth-toggle">
                <button type="button" class="active" id="loginToggle">Login</button>
                <button type="button" id="registerToggle">Register</button>
            </div>

            <form class="auth-form" id="authForm">
                <input type="email" class="auth-input" id="authEmail" placeholder="Email" required>
                <input type="password" class="auth-input" id="authPassword" placeholder="Password" required>
                
                <div class="partner-inputs" id="partnerInputs">
                    <input type="text" class="auth-input" id="partner1Input" placeholder="Your Name" required>
                    <input type="text" class="auth-input" id="partner2Input" placeholder="Partner's Name" required>
                </div>
                
                <button type="submit" class="auth-btn" id="authSubmit">Login</button>
            </form>
        </div>
    </div>

    <!-- Onboarding Overlay -->
    <div class="onboarding-overlay" id="onboardingOverlay" style="display: none;">
        <div class="onboarding-card">
            <div class="onboarding-progress">
                <div class="progress-dot active" data-step="1"></div>
                <div class="progress-dot" data-step="2"></div>
                <div class="progress-dot" data-step="3"></div>
                <div class="progress-dot" data-step="4"></div>
            </div>

            <!-- Step 1: Welcome -->
            <div class="onboarding-step active" data-step="1">
                <h2 class="onboarding-title">Welcome to FinSync! üéâ</h2>
                <p class="onboarding-text">Your new favorite way to manage finances as a couple. Track expenses, set budgets, and stay balanced together.</p>
                <div class="onboarding-actions">
                    <button class="skip-btn" onclick="skipOnboarding()">Skip</button>
                    <button class="auth-btn" onclick="nextOnboardingStep()">Get Started</button>
                </div>
            </div>

            <!-- Step 2: Budget -->
            <div class="onboarding-step" data-step="2">
                <h2 class="onboarding-title">Set Your Budget üí∞</h2>
                <p class="onboarding-text">How much do you plan to spend together this month?</p>
                <input type="number" class="auth-input" id="onboardingBudget" placeholder="Monthly Budget (e.g., 2000)" style="margin-bottom: 24px;">
                <div class="onboarding-actions">
                    <button class="skip-btn" onclick="prevOnboardingStep()">Back</button>
                    <button class="auth-btn" onclick="nextOnboardingStep()">Continue</button>
                </div>
            </div>

            <!-- Step 3: First Expense -->
            <div class="onboarding-step" data-step="3">
                <h2 class="onboarding-title">Add Your First Expense üìù</h2>
                <p class="onboarding-text">Try our natural language input! Just describe your expense.</p>
                <input type="text" class="auth-input" id="onboardingExpense" placeholder="Try: 'lunch at chipotle $18' or 'groceries $45 split'" style="margin-bottom: 24px;">
                <div class="onboarding-actions">
                    <button class="skip-btn" onclick="prevOnboardingStep()">Back</button>
                    <button class="auth-btn" onclick="nextOnboardingStep()">Add Expense</button>
                </div>
            </div>

            <!-- Step 4: Complete -->
            <div class="onboarding-step" data-step="4">
                <h2 class="onboarding-title">You're All Set! üöÄ</h2>
                <p class="onboarding-text">Welcome to FinSync! Your budget is set and you're ready to track expenses together. Happy budgeting!</p>
                <div class="onboarding-actions">
                    <button class="auth-btn" onclick="completeOnboarding()">Start Using FinSync</button>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer" style="display: none;">
        <header class="app-header">
            <h1>FinSync</h1>
        </header>

        <nav class="tab-nav">
            <button class="tab-btn active" data-tab="dashboard">üìä<span class="tab-text"> Dashboard</span></button>
            <button class="tab-btn" data-tab="add-expense">‚ûï<span class="tab-text"> Add Expense</span></button>
            <button class="tab-btn" data-tab="scan-receipt">üì∑<span class="tab-text"> Scan</span></button>
            <button class="tab-btn" data-tab="transactions">üí≥<span class="tab-text"> Transactions</span></button>
            <button class="tab-btn" data-tab="budget">üí∞<span class="tab-text"> Budget</span></button>
            <button class="tab-btn" data-tab="analytics">üìà<span class="tab-text"> Analytics</span></button>
            <button class="tab-btn" data-tab="settlement">ü§ù<span class="tab-text"> Settlement</span></button>
            <button class="tab-btn" data-tab="settings">‚öôÔ∏è<span class="tab-text"> Settings</span></button>
        </nav>

        <main class="app-content">
            <!-- Dashboard Tab -->
            <div class="tab-content active" id="dashboard">
                <div class="month-nav">
                    <button id="prevMonth">‚Äπ</button>
                    <div class="current-month" id="currentMonth">February 2026</div>
                    <button id="nextMonth">‚Ä∫</button>
                </div>

                <div class="dashboard-grid">
                    <div class="glass-card stat-card">
                        <div class="stat-value" id="totalSpent">$0</div>
                        <div class="stat-label">Total Spent</div>
                    </div>
                    <div class="glass-card stat-card">
                        <div class="stat-value" id="budgetRemaining">$0</div>
                        <div class="stat-label">Budget Remaining</div>
                    </div>
                    <div class="glass-card stat-card">
                        <div class="stat-value" id="partnerBalance">$0</div>
                        <div class="stat-label">Balance</div>
                    </div>
                </div>

                <div class="glass-card insights-panel">
                    <h3 style="margin-bottom: 20px;">ü§ñ AI Insights</h3>
                    <div class="health-score">
                        <div class="health-circle excellent" id="healthCircle" style="--score: 85">
                            <span id="healthScore">85</span>
                        </div>
                        <div class="stat-label">Budget Health Score</div>
                    </div>
                    <div id="aiInsights"></div>
                </div>

                <div class="glass-card">
                    <h3 style="margin-bottom: 20px;">üìà Top Categories</h3>
                    <div id="topCategories"></div>
                </div>
            </div>

            <!-- Add Expense Tab -->
            <div class="tab-content" id="add-expense">
                <div class="glass-card quick-add">
                    <h3 style="margin-bottom: 20px;">üí¨ Quick Add</h3>
                    <input type="text" class="form-input natural-input" id="naturalInput" 
                           placeholder="Try: 'lunch at chipotle $18 gary' or 'groceries $45 split'">
                    <button class="btn" onclick="parseNaturalInput()">Parse & Add</button>
                </div>

                <div class="glass-card">
                    <h3 style="margin-bottom: 20px;">üìù Manual Entry</h3>
                    <form id="expenseForm">
                        <div class="quick-add-grid">
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-input" id="amount" placeholder="0.00" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="category" required>
                                    <option value="">Select category</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Who Paid</label>
                                <select class="form-select" id="whoPaid" required>
                                    <option value="partner1">Partner 1</option>
                                    <option value="partner2">Partner 2</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="isShared" checked style="margin-right: 8px;">
                                    Shared with partner
                                </label>
                            </div>
                            <div class="form-group" id="splitTypeGroup">
                                <label class="form-label">Split Type</label>
                                <select class="form-select" id="splitType" required>
                                    <option value="50/50">50/50</option>
                                    <option value="custom">Custom %</option>
                                    <option value="single">One Person</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group" id="customSplitGroup" style="display: none;">
                            <label class="form-label">Partner 1 Percentage</label>
                            <input type="number" class="form-input" id="customSplit" min="0" max="100" value="50">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input" id="expenseDate" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <input type="text" class="form-input" id="notes" placeholder="Optional notes">
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="isRecurring">
                                <span>Recurring expense</span>
                            </label>
                        </div>

                        <button type="submit" class="btn">üíæ Add Expense</button>
                    </form>
                </div>
            </div>

            <!-- Scan Receipt Tab -->
            <div class="tab-content" id="scan-receipt">
                <div class="glass-card" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px;">üì∑ Scan Receipt</h3>
                    
                    <!-- Upload Area -->
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('receiptFile').click()">
                        <div style="font-size: 48px; margin-bottom: 12px;">üì∑</div>
                        <div style="font-size: 16px; margin-bottom: 8px;">Click to select or drag & drop your receipt</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">Supports JPG, PNG, WebP ‚Ä¢ Max 10MB</div>
                    </div>
                    
                    <input type="file" id="receiptFile" accept="image/*" style="display: none;" onchange="handleReceiptFile(event)">
                    
                    <!-- Image Preview -->
                    <div id="receiptPreview" style="display: none;">
                        <img id="previewImage" style="width: 100%; max-height: 400px; object-fit: contain; border-radius: 12px; margin-bottom: 16px;" alt="Receipt preview">
                        <div style="display: flex; gap: 12px;">
                            <button class="btn" onclick="scanReceipt()">üîç Scan Receipt</button>
                            <button class="btn btn-secondary" onclick="clearReceipt()">‚ùå Remove</button>
                        </div>
                    </div>
                    
                    <!-- Loading -->
                    <div id="scanLoading" style="display: none; text-align: center; padding: 40px 0;">
                        <div class="loading" style="margin: 0 auto 16px;"></div>
                        <div>ü©∫ Dr.Molt is analyzing your receipt...</div>
                        <div style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">This may take a few seconds</div>
                    </div>
                </div>
                    
                <!-- Results -->
                <div class="scan-results" id="scanResults">
                    <div class="glass-card">
                        <h3 style="margin-bottom: 20px;">üìã Review & Edit</h3>
                        
                        <div id="scanResultsList"></div>

                        <div class="scan-summary" id="scanSummary" style="margin-top: 20px;">
                            <div class="summary-total" id="summaryTotal">$0.00</div>
                            <div class="summary-count" id="summaryCount">0 items selected</div>
                            <button class="btn" onclick="addSelectedExpenses()">‚ûï Add Selected Items</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div class="tab-content" id="transactions">
                <div class="filters">
                    <input type="text" class="form-input filter-input" id="searchFilter" placeholder="üîç Search transactions...">
                    <select class="form-select" id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                    <select class="form-select" id="personFilter">
                        <option value="">All People</option>
                        <option value="partner1">Partner 1</option>
                        <option value="partner2">Partner 2</option>
                    </select>
                    <select class="form-select" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="shared">Shared</option>
                        <option value="individual">Individual</option>
                    </select>
                    <select class="form-select" id="monthFilter">
                        <option value="">All Months</option>
                    </select>
                </div>

                <div class="glass-card">
                    <div id="expensesList"></div>
                </div>
            </div>

            <!-- Budget Tab -->
            <div class="tab-content" id="budget">
                <div class="month-nav">
                    <button onclick="changeMonth(-1)">‚Äπ</button>
                    <div class="current-month" id="budgetMonth">February 2026</div>
                    <button onclick="changeMonth(1)">‚Ä∫</button>
                </div>

                <div class="glass-card" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px;">üë• Shared Budget</h3>
                    <div class="form-group">
                        <label class="form-label">Monthly Shared Budget</label>
                        <input type="number" class="form-input" id="sharedBudget" placeholder="Enter shared budget" step="0.01">
                        <button class="btn" onclick="saveBudgets()" style="margin-top: 12px;">Save</button>
                    </div>
                </div>

                <div class="glass-card" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px;" id="partner1BudgetTitle">üë§ Gary's Personal Budget</h3>
                    <div class="form-group">
                        <label class="form-label">Monthly Personal Budget</label>
                        <input type="number" class="form-input" id="partner1Budget" placeholder="Enter personal budget" step="0.01">
                        <button class="btn" onclick="saveBudgets()" style="margin-top: 12px;">Save</button>
                    </div>
                </div>

                <div class="glass-card" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px;" id="partner2BudgetTitle">üë§ Emily's Personal Budget</h3>
                    <div class="form-group">
                        <label class="form-label">Monthly Personal Budget</label>
                        <input type="number" class="form-input" id="partner2Budget" placeholder="Enter personal budget" step="0.01">
                        <button class="btn" onclick="saveBudgets()" style="margin-top: 12px;">Save</button>
                    </div>
                </div>

                <div class="glass-card">
                    <h3 style="margin-bottom: 20px;">üìä Category Budgets</h3>
                    <div id="budgetCategories"></div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="tab-content" id="analytics">
                <div class="month-nav">
                    <button onclick="changeMonth(-1)">‚Äπ</button>
                    <div class="current-month" id="analyticsMonth">February 2026</div>
                    <button onclick="changeMonth(1)">‚Ä∫</button>
                </div>

                <div style="display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; justify-content: center;">
                    <button class="tab-btn active" data-view="combined" onclick="setAnalyticsView('combined', this)">üìä Combined</button>
                    <button class="tab-btn" data-view="shared" onclick="setAnalyticsView('shared', this)">üë• Shared Only</button>
                    <button class="tab-btn" data-view="partner1" onclick="setAnalyticsView('partner1', this)" id="viewPartner1Btn">üë§ Gary</button>
                    <button class="tab-btn" data-view="partner2" onclick="setAnalyticsView('partner2', this)" id="viewPartner2Btn">üë§ Emily</button>
                </div>

                <div class="chart-grid">
                    <div class="glass-card">
                        <h3 style="margin-bottom: 20px;">ü•ß Spending by Category</h3>
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    <div class="glass-card">
                        <h3 style="margin-bottom: 20px;">üë• Partner Split</h3>
                        <div class="chart-container">
                            <canvas id="partnerChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="chart-grid">
                    <div class="glass-card">
                        <h3 style="margin-bottom: 20px;">üìà Monthly Comparison</h3>
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                    <div class="glass-card">
                        <h3 style="margin-bottom: 20px;">üìÖ Daily Spending</h3>
                        <div class="chart-container">
                            <canvas id="dailyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settlement Tab -->
            <div class="tab-content" id="settlement">
                <div class="glass-card settlement-card">
                    <h3 style="margin-bottom: 20px;">ü§ù Settlement Summary</h3>
                    <div class="settlement-amount" id="settlementAmount">$0.00</div>
                    <div class="stat-label" id="settlementLabel">No settlement needed</div>
                    <button class="btn" onclick="settleUp()" style="margin-top: 20px;" id="settleButton">‚úÖ Mark as Settled</button>
                </div>

                <div class="glass-card">
                    <h3 style="margin-bottom: 20px;">üìä Payment Breakdown</h3>
                    <div id="paymentBreakdown"></div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settings">
                <div class="glass-card" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px;">üîê Account</h3>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px;">
                        <span style="color: var(--text-secondary);">Logged in as: <strong id="currentUserEmail"></strong></span>
                    </div>
                    <button class="btn btn-secondary" onclick="logout()" style="margin-bottom: 20px;">üö™ Logout</button>
                </div>

                <div class="glass-card" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px;">üë• Partner Names</h3>
                    <div class="form-group">
                        <label class="form-label">Partner 1 Name</label>
                        <input type="text" class="form-input" id="partner1Name" placeholder="Enter name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Partner 2 Name</label>
                        <input type="text" class="form-input" id="partner2Name" placeholder="Enter name">
                    </div>
                    <button class="btn" onclick="savePartnerNames()">üíæ Save Names</button>
                </div>

                <div class="glass-card" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px;">üìÇ Data Management</h3>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="exportData()">üì§ Export Data</button>
                        <button class="btn btn-secondary" onclick="importData()">üì• Import Data</button>
                        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
                </div>

                <div class="glass-card">
                    <h3 style="margin-bottom: 20px;">üè∑Ô∏è Custom Categories</h3>
                    <div class="form-group">
                        <input type="text" class="form-input" id="newCategory" placeholder="Enter new category name">
                        <button class="btn" onclick="addCustomCategory()" style="margin-top: 12px;">‚ûï Add Category</button>
                    </div>
                    <div id="customCategoriesList" style="margin-top: 20px;"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Authentication State
        let currentUser = null;
        let isFirstRegister = false;

        // App State
        let appState = {
            currentMonth: new Date(),
            expenses: [],
            budgets: {},
            partners: {
                partner1: 'Partner 1',
                partner2: 'Partner 2'
            },
            categories: [
                'Food/Dining', 'Groceries', 'Rent/Housing', 'Utilities', 
                'Transport', 'Entertainment', 'Subscriptions', 'Health', 
                'Shopping', 'Travel', 'Gifts', 'Insurance', 'Education',
                'Personal Care', 'Pets', 'Home Maintenance', 'Alcohol/Bars',
                'Coffee/Cafe', 'Fitness/Gym', 'Clothing', 'Electronics',
                'Charity/Donations', 'Parking', 'Phone/Internet', 'Other'
            ]
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            checkSession();
        });

        // Authentication Functions
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function checkSession() {
            const session = localStorage.getItem('finSyncSession');
            if (session) {
                currentUser = session;
                showApp();
            } else {
                showAuth();
            }
        }

        function showAuth() {
            document.getElementById('authOverlay').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            setupAuthListeners();
        }

        function showApp() {
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            document.getElementById('currentUserEmail').textContent = currentUser;
            loadData();
            initializeApp();
            updateDisplay();
        }

        function setupAuthListeners() {
            const loginToggle = document.getElementById('loginToggle');
            const registerToggle = document.getElementById('registerToggle');
            const authForm = document.getElementById('authForm');
            const partnerInputs = document.getElementById('partnerInputs');
            const authSubmit = document.getElementById('authSubmit');

            loginToggle.addEventListener('click', () => {
                loginToggle.classList.add('active');
                registerToggle.classList.remove('active');
                partnerInputs.classList.remove('show');
                authSubmit.textContent = 'Login';
            });

            registerToggle.addEventListener('click', () => {
                registerToggle.classList.add('active');
                loginToggle.classList.remove('active');
                partnerInputs.classList.add('show');
                authSubmit.textContent = 'Register';
            });

            authForm.addEventListener('submit', handleAuth);
        }

        async function handleAuth(e) {
            e.preventDefault();
            
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const isRegister = document.getElementById('registerToggle').classList.contains('active');

            if (isRegister) {
                const partner1Name = document.getElementById('partner1Input').value;
                const partner2Name = document.getElementById('partner2Input').value;
                
                if (!partner1Name || !partner2Name) {
                    showToast('Please enter both partner names', 'error');
                    return;
                }
                
                await registerUser(email, password, partner1Name, partner2Name);
            } else {
                await loginUser(email, password);
            }
        }

        async function registerUser(email, password, partner1Name, partner2Name) {
            try {
                const users = JSON.parse(localStorage.getItem('finSyncUsers') || '[]');
                
                if (users.some(user => user.email === email)) {
                    showToast('Email already registered', 'error');
                    return;
                }

                const passwordHash = await hashPassword(password);
                const newUser = {
                    email,
                    passwordHash,
                    partner1Name,
                    partner2Name,
                    createdAt: new Date().toISOString()
                };

                users.push(newUser);
                localStorage.setItem('finSyncUsers', JSON.stringify(users));
                localStorage.setItem('finSyncSession', email);
                
                // Initialize user data
                appState.partners = {
                    partner1: partner1Name,
                    partner2: partner2Name
                };
                
                currentUser = email;
                isFirstRegister = true;
                saveData();
                showApp();
                
                // Show onboarding for new users
                setTimeout(() => showOnboarding(), 500);
                
                showToast('Account created successfully!', 'success');
            } catch (error) {
                showToast('Registration failed', 'error');
            }
        }

        async function loginUser(email, password) {
            try {
                const users = JSON.parse(localStorage.getItem('finSyncUsers') || '[]');
                const user = users.find(u => u.email === email);
                
                if (!user) {
                    showToast('User not found', 'error');
                    return;
                }

                const passwordHash = await hashPassword(password);
                if (user.passwordHash !== passwordHash) {
                    showToast('Invalid password', 'error');
                    return;
                }

                localStorage.setItem('finSyncSession', email);
                currentUser = email;
                showApp();
                showToast('Welcome back!', 'success');
            } catch (error) {
                showToast('Login failed', 'error');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('finSyncSession');
                currentUser = null;
                location.reload();
            }
        }

        // Onboarding Functions
        let currentOnboardingStep = 1;

        function showOnboarding() {
            const isOnboarded = localStorage.getItem(`finSyncOnboarded_${currentUser}`);
            if (!isOnboarded) {
                document.getElementById('onboardingOverlay').style.display = 'flex';
            }
        }

        function nextOnboardingStep() {
            const currentStepEl = document.querySelector(`.onboarding-step[data-step="${currentOnboardingStep}"]`);
            const nextStep = currentOnboardingStep + 1;

            // Handle step-specific actions
            if (currentOnboardingStep === 2) {
                const budget = parseFloat(document.getElementById('onboardingBudget').value);
                if (budget && budget > 0) {
                    appState.budgets.total = budget;
                    saveData();
                }
            } else if (currentOnboardingStep === 3) {
                const expense = document.getElementById('onboardingExpense').value;
                if (expense) {
                    // Use the existing natural language parser
                    document.getElementById('naturalInput').value = expense;
                    parseNaturalInput();
                    if (document.getElementById('amount').value) {
                        // Auto-submit the parsed expense
                        const form = document.getElementById('expenseForm');
                        if (form.checkValidity()) {
                            handleExpenseSubmit({ preventDefault: () => {} });
                        }
                    }
                }
            }

            if (nextStep <= 4) {
                currentStepEl.classList.remove('active');
                document.querySelector(`.onboarding-step[data-step="${nextStep}"]`).classList.add('active');
                document.querySelector(`.progress-dot[data-step="${currentOnboardingStep}"]`).classList.remove('active');
                document.querySelector(`.progress-dot[data-step="${nextStep}"]`).classList.add('active');
                currentOnboardingStep = nextStep;
            }
        }

        function prevOnboardingStep() {
            const currentStepEl = document.querySelector(`.onboarding-step[data-step="${currentOnboardingStep}"]`);
            const prevStep = currentOnboardingStep - 1;

            if (prevStep >= 1) {
                currentStepEl.classList.remove('active');
                document.querySelector(`.onboarding-step[data-step="${prevStep}"]`).classList.add('active');
                document.querySelector(`.progress-dot[data-step="${currentOnboardingStep}"]`).classList.remove('active');
                document.querySelector(`.progress-dot[data-step="${prevStep}"]`).classList.add('active');
                currentOnboardingStep = prevStep;
            }
        }

        function skipOnboarding() {
            completeOnboarding();
        }

        function completeOnboarding() {
            localStorage.setItem(`finSyncOnboarded_${currentUser}`, 'true');
            document.getElementById('onboardingOverlay').style.display = 'none';
            updateDisplay();
            showToast('Welcome to FinSync! üéâ', 'success');
        }

        // Toast Notifications
        function showToast(message, type = 'success') {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Data Management
        function saveData() {
            if (!currentUser) return;
            
            localStorage.setItem(`finSyncData_${currentUser}`, JSON.stringify({
                expenses: appState.expenses,
                budgets: appState.budgets,
                partners: appState.partners,
                categories: appState.categories
            }));
        }

        function loadData() {
            if (!currentUser) return;
            
            const saved = localStorage.getItem(`finSyncData_${currentUser}`);
            if (saved) {
                const data = JSON.parse(saved);
                appState.expenses = data.expenses || [];
                appState.budgets = data.budgets || {};
                appState.partners = data.partners || appState.partners;
                appState.categories = data.categories || appState.categories;
                
                // Migrate old expenses without isShared field
                let needsSave = false;
                appState.expenses.forEach(expense => {
                    if (expense.isShared === undefined) {
                        expense.isShared = true; // Default to shared for backward compatibility
                        needsSave = true;
                    }
                });
                
                if (needsSave) {
                    saveData();
                }
            } else {
                // Load partner names from registration if first time
                const users = JSON.parse(localStorage.getItem('finSyncUsers') || '[]');
                const user = users.find(u => u.email === currentUser);
                if (user) {
                    appState.partners = {
                        partner1: user.partner1Name,
                        partner2: user.partner2Name
                    };
                }
            }
        }

        function initializeApp() {
            // Set current date
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            
            // Initialize tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.tab-btn');
                    if (tabBtn && tabBtn.dataset.tab) switchTab(tabBtn.dataset.tab);
                });
            });

            // Initialize month navigation
            document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));

            // Initialize form
            document.getElementById('expenseForm').addEventListener('submit', handleExpenseSubmit);
            document.getElementById('splitType').addEventListener('change', handleSplitTypeChange);
            document.getElementById('isShared').addEventListener('change', handleSharedToggle);

            // Initialize filters
            document.getElementById('searchFilter').addEventListener('input', filterTransactions);
            document.getElementById('categoryFilter').addEventListener('change', filterTransactions);
            document.getElementById('personFilter').addEventListener('change', filterTransactions);
            document.getElementById('typeFilter').addEventListener('change', filterTransactions);
            document.getElementById('monthFilter').addEventListener('change', filterTransactions);

            // Load partner names
            document.getElementById('partner1Name').value = appState.partners.partner1;
            document.getElementById('partner2Name').value = appState.partners.partner2;

            populateSelectors();
            renderRecurringExpenses();

            // Drag & drop for receipt upload
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.borderColor = 'var(--accent-start)'; });
                uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.style.borderColor = ''; });
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '';
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const dt = new DataTransfer();
                        dt.items.add(file);
                        document.getElementById('receiptFile').files = dt.files;
                        handleReceiptFile({ target: { files: dt.files } });
                    } else {
                        showToast('Please drop an image file', 'error');
                    }
                });
            }
        }

        // Tab Management
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            // Update content when switching tabs
            if (tabId === 'analytics') renderCharts();
            if (tabId === 'transactions') renderTransactions();
            if (tabId === 'budget') renderBudget();
            if (tabId === 'settlement') renderSettlement();
            if (tabId === 'settings') renderCustomCategories();
        }

        // Month Navigation
        function changeMonth(direction) {
            appState.currentMonth = new Date(appState.currentMonth);
            appState.currentMonth.setMonth(appState.currentMonth.getMonth() + direction);
            updateDisplay();
        }

        function updateDisplay() {
            updateCurrentMonth();
            updateDashboard();
            generateAIInsights();
            populateSelectors();
        }

        function updateCurrentMonth() {
            const monthYear = appState.currentMonth.toLocaleDateString('en-US', { 
                month: 'long', 
                year: 'numeric' 
            });
            document.getElementById('currentMonth').textContent = monthYear;
        }

        // Expense Management
        function handleExpenseSubmit(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('amount').value);
            const category = document.getElementById('category').value;
            const whoPaid = document.getElementById('whoPaid').value;
            const splitType = document.getElementById('splitType').value;
            const date = document.getElementById('expenseDate').value;
            const notes = document.getElementById('notes').value;
            const isRecurring = document.getElementById('isRecurring').checked;
            const customSplit = document.getElementById('customSplit').value;
            const isShared = document.getElementById('isShared').checked;

            const expense = {
                id: Date.now(),
                amount,
                category,
                whoPaid,
                splitType,
                customSplit: splitType === 'custom' ? parseFloat(customSplit) : null,
                date,
                notes,
                isRecurring,
                isShared,
                timestamp: new Date()
            };

            addExpense(expense);
            document.getElementById('expenseForm').reset();
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('isShared').checked = true; // Reset to default
            updateDisplay();
            showToast(`${isShared ? 'Shared' : 'Individual'} expense added successfully! üí∞`, 'success');
        }

        function addExpense(expense) {
            appState.expenses.push(expense);
            saveData();
        }

        function deleteExpense(id) {
            if (confirm('Delete this expense?')) {
                appState.expenses = appState.expenses.filter(e => e.id !== id);
                saveData();
                updateDisplay();
                renderTransactions();
            }
        }

        function handleSplitTypeChange() {
            const splitType = document.getElementById('splitType').value;
            const customGroup = document.getElementById('customSplitGroup');
            customGroup.style.display = splitType === 'custom' ? 'block' : 'none';
        }

        function handleSharedToggle() {
            const isShared = document.getElementById('isShared').checked;
            const splitTypeGroup = document.getElementById('splitTypeGroup');
            const customGroup = document.getElementById('customSplitGroup');
            
            if (isShared) {
                splitTypeGroup.style.display = 'block';
                document.getElementById('splitType').required = true;
            } else {
                splitTypeGroup.style.display = 'none';
                customGroup.style.display = 'none';
                document.getElementById('splitType').required = false;
            }
        }

        // Natural Language Processing
        function parseNaturalInput() {
            const input = document.getElementById('naturalInput').value.toLowerCase();
            if (!input.trim()) {
                showToast('Please enter an expense description', 'error');
                return;
            }

            // Extract amount - handle various formats
            const amountMatch = input.match(/\$?(\d+(?:\.\d{1,2})?)/);
            if (amountMatch) {
                let amount = parseFloat(amountMatch[1]);
                if (!isNaN(amount) && amount > 0) {
                    document.getElementById('amount').value = amount.toFixed(2);
                }
            } else {
                // If no amount found, show error
                showToast('Please include an amount in your description (e.g., "$25" or "25.50")', 'error');
                return;
            }

            // Check for personal expense keywords
            const personalKeywords = ['personal', 'mine', 'just me', 'individual', 'my own', 'for me', 'myself', 'private'];
            const isPersonal = personalKeywords.some(keyword => input.includes(keyword));
            
            document.getElementById('isShared').checked = !isPersonal;
            handleSharedToggle(); // Update form visibility

            // Enhanced category keywords
            const categoryMap = {
                'groceries': 'Groceries',
                'grocery': 'Groceries', 
                'supermarket': 'Groceries',
                'costco': 'Groceries',
                'walmart': 'Groceries',
                'food': 'Food/Dining',
                'lunch': 'Food/Dining',
                'dinner': 'Food/Dining',
                'breakfast': 'Food/Dining',
                'restaurant': 'Food/Dining',
                'chipotle': 'Food/Dining',
                'mcdonalds': 'Food/Dining',
                'starbucks': 'Coffee/Cafe',
                'coffee': 'Coffee/Cafe',
                'cafe': 'Coffee/Cafe',
                'tim hortons': 'Coffee/Cafe',
                'tims': 'Coffee/Cafe',
                'pizza': 'Food/Dining',
                'gas': 'Transport',
                'fuel': 'Transport',
                'uber': 'Transport',
                'lyft': 'Transport',
                'taxi': 'Transport',
                'bus': 'Transport',
                'train': 'Transport',
                'parking': 'Parking',
                'rent': 'Rent/Housing',
                'mortgage': 'Rent/Housing',
                'utilities': 'Utilities',
                'electricity': 'Utilities',
                'water': 'Utilities',
                'hydro': 'Utilities',
                'internet': 'Phone/Internet',
                'phone': 'Phone/Internet',
                'mobile': 'Phone/Internet',
                'rogers': 'Phone/Internet',
                'bell': 'Phone/Internet',
                'fido': 'Phone/Internet',
                'movie': 'Entertainment',
                'cinema': 'Entertainment',
                'concert': 'Entertainment',
                'game': 'Entertainment',
                'netflix': 'Subscriptions',
                'spotify': 'Subscriptions',
                'disney': 'Subscriptions',
                'amazon prime': 'Subscriptions',
                'gym': 'Fitness/Gym',
                'fitness': 'Fitness/Gym',
                'yoga': 'Fitness/Gym',
                'crossfit': 'Fitness/Gym',
                'doctor': 'Health',
                'pharmacy': 'Health',
                'medicine': 'Health',
                'dentist': 'Health',
                'hospital': 'Health',
                'clothes': 'Clothing',
                'clothing': 'Clothing',
                'jacket': 'Clothing',
                'shoes': 'Clothing',
                'shopping': 'Shopping',
                'amazon': 'Shopping',
                'gift': 'Gifts',
                'present': 'Gifts',
                'insurance': 'Insurance',
                'car insurance': 'Insurance',
                'home insurance': 'Insurance',
                'tuition': 'Education',
                'course': 'Education',
                'textbook': 'Education',
                'school': 'Education',
                'haircut': 'Personal Care',
                'salon': 'Personal Care',
                'spa': 'Personal Care',
                'skincare': 'Personal Care',
                'vet': 'Pets',
                'pet': 'Pets',
                'dog': 'Pets',
                'cat': 'Pets',
                'repair': 'Home Maintenance',
                'plumber': 'Home Maintenance',
                'electrician': 'Home Maintenance',
                'bar': 'Alcohol/Bars',
                'beer': 'Alcohol/Bars',
                'wine': 'Alcohol/Bars',
                'lcbo': 'Alcohol/Bars',
                'liquor': 'Alcohol/Bars',
                'laptop': 'Electronics',
                'computer': 'Electronics',
                'iphone': 'Electronics',
                'apple store': 'Electronics',
                'donation': 'Charity/Donations',
                'charity': 'Charity/Donations'
            };

            // Find best category match
            let foundCategory = null;
            for (const [keyword, category] of Object.entries(categoryMap)) {
                if (input.includes(keyword)) {
                    foundCategory = category;
                    break;
                }
            }
            
            if (foundCategory) {
                document.getElementById('category').value = foundCategory;
            } else {
                document.getElementById('category').value = 'Other';
            }

            // Extract who paid
            const partner1Name = appState.partners.partner1.toLowerCase();
            const partner2Name = appState.partners.partner2.toLowerCase();
            
            if (input.includes(partner1Name) || input.includes('gary') || input.includes('me') || input.includes('i ')) {
                document.getElementById('whoPaid').value = 'partner1';
            } else if (input.includes(partner2Name)) {
                document.getElementById('whoPaid').value = 'partner2';
            } else {
                // Default to partner 1 if not specified
                document.getElementById('whoPaid').value = 'partner1';
            }

            // Extract split type
            if (input.includes('split') || input.includes('shared') || input.includes('together')) {
                document.getElementById('splitType').value = '50/50';
            } else {
                document.getElementById('splitType').value = '50/50'; // Default to split
            }

            // Set current date
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];

            // Extract notes from original input
            const words = document.getElementById('naturalInput').value.split(' ');
            const notes = words.filter(word => 
                !word.match(/\$?\d+/) && 
                !word.toLowerCase().includes(partner1Name) && 
                !word.toLowerCase().includes(partner2Name) &&
                !['split', 'shared', 'gary', 'me', 'i'].includes(word.toLowerCase())
            ).join(' ');
            
            if (notes.trim()) {
                document.getElementById('notes').value = notes.trim();
            }

            // Auto-submit if we have required fields
            const amount = document.getElementById('amount').value;
            const category = document.getElementById('category').value;
            
            if (amount && category) {
                // Simulate form submission
                setTimeout(() => {
                    const form = document.getElementById('expenseForm');
                    if (form.checkValidity()) {
                        handleExpenseSubmit({ preventDefault: () => {} });
                        showToast('Expense added successfully! üéâ', 'success');
                        
                        // Clear the natural input
                        document.getElementById('naturalInput').value = '';
                    } else {
                        showToast('Please fill in any missing required fields', 'warning');
                    }
                }, 100);
            } else {
                showToast('Parsed! Please fill in any missing fields and submit', 'success');
            }
        }

        // Dashboard Updates
        function updateDashboard() {
            const monthExpenses = getCurrentMonthExpenses();
            
            // Separate shared and individual expenses
            const sharedExpenses = monthExpenses.filter(exp => exp.isShared !== false);
            const individualExpenses = monthExpenses.filter(exp => exp.isShared === false);
            
            const totalSharedSpent = sharedExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const partner1Individual = individualExpenses.filter(exp => exp.whoPaid === 'partner1').reduce((sum, exp) => sum + exp.amount, 0);
            const partner2Individual = individualExpenses.filter(exp => exp.whoPaid === 'partner2').reduce((sum, exp) => sum + exp.amount, 0);
            const totalIndividualSpent = partner1Individual + partner2Individual;
            const totalSpent = totalSharedSpent + totalIndividualSpent;
            
            const totalBudget = appState.budgets.total || 0;
            const budgetRemaining = totalBudget - totalSpent;
            const balance = calculatePartnerBalance();

            // Update dashboard display
            document.getElementById('totalSpent').innerHTML = `
                <div><strong>$${totalSpent.toFixed(2)}</strong></div>
                <div style="font-size: 0.8em; color: var(--text-secondary); margin-top: 4px;">
                    üë• Shared: $${totalSharedSpent.toFixed(2)}<br>
                    üë§ ${appState.partners.partner1}: $${partner1Individual.toFixed(2)}<br>
                    üë§ ${appState.partners.partner2}: $${partner2Individual.toFixed(2)}
                </div>
            `;
            document.getElementById('budgetRemaining').textContent = `$${budgetRemaining.toFixed(2)}`;
            document.getElementById('partnerBalance').textContent = balance.amount;

            renderTopCategories();
        }

        function getCurrentMonthExpenses() {
            const currentMonth = appState.currentMonth.getMonth();
            const currentYear = appState.currentMonth.getFullYear();
            
            return appState.expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && 
                       expenseDate.getFullYear() === currentYear;
            });
        }

        function calculatePartnerBalance() {
            // Only consider shared expenses for balance calculation
            const sharedExpenses = getCurrentMonthExpenses().filter(exp => exp.isShared !== false);
            let partner1Total = 0;
            let partner2Total = 0;
            let partner1Paid = 0;
            let partner2Paid = 0;

            sharedExpenses.forEach(expense => {
                // Track who paid
                if (expense.whoPaid === 'partner1') {
                    partner1Paid += expense.amount;
                } else {
                    partner2Paid += expense.amount;
                }

                // Track who owes what based on split
                if (expense.splitType === '50/50') {
                    const half = expense.amount / 2;
                    partner1Total += half;
                    partner2Total += half;
                } else if (expense.splitType === 'custom' && expense.customSplit) {
                    partner1Total += (expense.amount * expense.customSplit / 100);
                    partner2Total += (expense.amount * (100 - expense.customSplit) / 100);
                } else if (expense.splitType === 'single') {
                    if (expense.whoPaid === 'partner1') {
                        partner1Total += expense.amount;
                    } else {
                        partner2Total += expense.amount;
                    }
                }
            });

            // How much partner1 overpaid (positive = partner2 owes partner1)
            const balance = partner1Paid - partner1Total;
            const owesWho = balance > 0 ? 
                `${appState.partners.partner2} owes ${appState.partners.partner1}` : 
                `${appState.partners.partner1} owes ${appState.partners.partner2}`;

            return {
                amount: `$${Math.abs(balance).toFixed(2)}`,
                label: Math.abs(balance) < 0.01 ? 'Balanced' : owesWho,
                rawBalance: balance
            };
        }

        function renderTopCategories() {
            const expenses = getCurrentMonthExpenses();
            const categoryTotals = {};

            expenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
            });

            const sorted = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const container = document.getElementById('topCategories');
            if (sorted.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><h3>No expenses yet</h3><p>Add some expenses to see your top categories</p></div>';
                return;
            }

            container.innerHTML = sorted.map(([category, amount]) => `
                <div class="budget-item">
                    <div class="budget-info">
                        <div class="budget-category">${category}</div>
                    </div>
                    <div class="budget-amount">$${amount.toFixed(2)}</div>
                </div>
            `).join('');
        }

        // AI Insights
        function generateAIInsights() {
            const insights = [];
            const currentExpenses = getCurrentMonthExpenses();
            
            // Separate shared and individual expenses for analysis
            const sharedExpenses = currentExpenses.filter(exp => exp.isShared !== false);
            const individualExpenses = currentExpenses.filter(exp => exp.isShared === false);
            
            const totalSpent = currentExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalSharedSpent = sharedExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalIndividualSpent = individualExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalBudget = appState.budgets.total || 0;
            
            // Shared vs Individual ratio insights
            if (totalSpent > 0) {
                const sharedRatio = (totalSharedSpent / totalSpent) * 100;
                if (sharedRatio < 30) {
                    insights.push({
                        text: `Only ${sharedRatio.toFixed(0)}% of spending is shared ‚Äî consider tracking more couple expenses`,
                        type: 'info'
                    });
                } else if (sharedRatio > 90) {
                    insights.push({
                        text: `Most expenses (${sharedRatio.toFixed(0)}%) are shared ‚Äî good teamwork!`,
                        type: 'success'
                    });
                }
            }
            
            // Individual spending imbalance
            const partner1Individual = individualExpenses.filter(exp => exp.whoPaid === 'partner1').reduce((sum, exp) => sum + exp.amount, 0);
            const partner2Individual = individualExpenses.filter(exp => exp.whoPaid === 'partner2').reduce((sum, exp) => sum + exp.amount, 0);
            
            if (partner1Individual > 0 && partner2Individual > 0) {
                const ratio = partner1Individual / partner2Individual;
                if (ratio > 2 || ratio < 0.5) {
                    insights.push({
                        text: `Individual spending differs significantly: ${appState.partners.partner1} $${partner1Individual.toFixed(0)}, ${appState.partners.partner2} $${partner2Individual.toFixed(0)}`,
                        type: 'info'
                    });
                }
            }
            
            // Previous month comparison
            const prevMonth = new Date(appState.currentMonth);
            prevMonth.setMonth(prevMonth.getMonth() - 1);
            const prevMonthExpenses = appState.expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === prevMonth.getMonth() && 
                       expenseDate.getFullYear() === prevMonth.getFullYear();
            });
            const prevMonthTotal = prevMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);

            if (prevMonthTotal > 0) {
                const change = ((totalSpent - prevMonthTotal) / prevMonthTotal * 100);
                if (Math.abs(change) > 10) {
                    insights.push({
                        text: `You spent ${Math.abs(change).toFixed(0)}% ${change > 0 ? 'more' : 'less'} this month vs last month`,
                        type: change > 0 ? 'warning' : 'success'
                    });
                }
            }

            // Partner balance insights
            const balance = calculatePartnerBalance();
            if (Math.abs(balance.rawBalance) > 100) {
                insights.push({
                    text: `${balance.rawBalance > 0 ? appState.partners.partner1 : appState.partners.partner2} has covered more expenses ‚Äî consider rebalancing`,
                    type: 'info'
                });
            }

            // Budget warnings
            if (totalBudget > 0) {
                const budgetUsage = (totalSpent / totalBudget) * 100;
                if (budgetUsage > 90) {
                    insights.push({
                        text: `You've used ${budgetUsage.toFixed(0)}% of your monthly budget`,
                        type: 'danger'
                    });
                } else if (budgetUsage > 75) {
                    const daysLeft = new Date(appState.currentMonth.getFullYear(), appState.currentMonth.getMonth() + 1, 0).getDate() - new Date().getDate();
                    const currentPace = totalSpent / new Date().getDate();
                    const projectedTotal = currentPace * new Date(appState.currentMonth.getFullYear(), appState.currentMonth.getMonth() + 1, 0).getDate();
                    if (projectedTotal > totalBudget) {
                        insights.push({
                            text: `At current pace, you'll exceed your budget by $${(projectedTotal - totalBudget).toFixed(0)}`,
                            type: 'warning'
                        });
                    }
                }
            }

            // Category insights
            const categoryTotals = {};
            currentExpenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
            });

            const topCategory = Object.entries(categoryTotals).sort(([,a], [,b]) => b - a)[0];
            if (topCategory && topCategory[1] > totalSpent * 0.3) {
                insights.push({
                    text: `${topCategory[0]} accounts for ${((topCategory[1] / totalSpent) * 100).toFixed(0)}% of your spending`,
                    type: 'info'
                });
            }

            // Subscription check
            const subscriptionExpenses = currentExpenses.filter(exp => exp.category === 'Subscriptions');
            if (subscriptionExpenses.length > 5) {
                insights.push({
                    text: `You have ${subscriptionExpenses.length} subscription expenses ‚Äî check for unused services`,
                    type: 'info'
                });
            }

            // Calculate health score with better edge case handling
            let healthScore = 100;
            
            // Budget usage penalty (only if budget is set)
            if (totalBudget > 0 && totalSpent > 0) {
                const budgetUsage = (totalSpent / totalBudget) * 100;
                if (budgetUsage > 100) healthScore -= 30;
                else if (budgetUsage > 90) healthScore -= 20;
                else if (budgetUsage > 75) healthScore -= 10;
            } else if (totalBudget === 0 && totalSpent > 0) {
                // Small penalty for no budget set
                healthScore -= 5;
            }
            
            // Partner balance penalty (only for shared expenses)
            if (balance.rawBalance !== undefined && Math.abs(balance.rawBalance) > 200) {
                healthScore -= 15;
            }
            
            // Danger insight penalty
            const dangerCount = insights.filter(i => i.type === 'danger').length;
            if (dangerCount > 0) healthScore -= (dangerCount * 15);

            healthScore = Math.max(0, Math.min(100, healthScore));

            // Update health score display
            const healthCircle = document.getElementById('healthCircle');
            const scoreElement = document.getElementById('healthScore');
            healthCircle.style.setProperty('--score', healthScore);
            scoreElement.textContent = healthScore;

            const healthClass = healthScore >= 80 ? 'excellent' : healthScore >= 60 ? 'good' : 'poor';
            healthCircle.className = `health-circle ${healthClass}`;

            // Render insights
            const container = document.getElementById('aiInsights');
            if (insights.length === 0) {
                container.innerHTML = '<div class="insight-item">Everything looks good! Your spending is on track.</div>';
            } else {
                container.innerHTML = insights.map(insight => `
                    <div class="insight-item ${insight.type || 'info'}">
                        ${insight.text}
                    </div>
                `).join('');
            }
        }

        // Transactions Management
        const CATEGORY_COLORS = {
            'Food/Dining': '#f59e0b', 'Groceries': '#10b981', 'Rent/Housing': '#6366f1',
            'Utilities': '#8b5cf6', 'Transport': '#3b82f6', 'Entertainment': '#ec4899',
            'Subscriptions': '#f97316', 'Health': '#ef4444', 'Shopping': '#14b8a6',
            'Travel': '#06b6d4', 'Gifts': '#d946ef', 'Insurance': '#64748b',
            'Education': '#0ea5e9', 'Personal Care': '#f472b6', 'Pets': '#a3e635',
            'Home Maintenance': '#78716c', 'Alcohol/Bars': '#be123c', 'Coffee/Cafe': '#92400e',
            'Fitness/Gym': '#16a34a', 'Clothing': '#7c3aed', 'Electronics': '#0891b2',
            'Charity/Donations': '#e879f9', 'Parking': '#475569', 'Phone/Internet': '#2563eb',
            'Other': '#6b7280'
        };

        function getCategoryColor(category) {
            return CATEGORY_COLORS[category] || '#6b7280';
        }

        function renderTransactions() {
            const container = document.getElementById('expensesList');
            const filteredExpenses = getFilteredExpenses();

            if (filteredExpenses.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí≥</div><h3>No transactions found</h3><p>Try adjusting your filters or add some expenses</p></div>';
                return;
            }

            container.innerHTML = filteredExpenses
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(expense => {
                    const isShared = expense.isShared !== false;
                    const paidByPartner1 = expense.whoPaid === 'partner1';
                    const borderColor = paidByPartner1 ? '#6366f1' : '#06b6d4';
                    const paidByName = appState.partners[expense.whoPaid] || 'Unknown';
                    const paidBadgeBg = paidByPartner1 ? 'rgba(99,102,241,0.2)' : 'rgba(6,182,212,0.2)';
                    const paidBadgeColor = paidByPartner1 ? '#818cf8' : '#22d3ee';
                    const sharedBg = isShared ? 'rgba(99,102,241,0.06)' : 'rgba(245,158,11,0.06)';
                    const sharedBadgeBg = isShared ? 'rgba(99,102,241,0.15)' : 'rgba(245,158,11,0.15)';
                    const sharedBadgeColor = isShared ? '#a5b4fc' : '#fbbf24';
                    const splitText = isShared ? 
                        (expense.splitType === '50/50' ? '50/50' : 
                         expense.splitType === 'custom' ? `${expense.customSplit}/${100-expense.customSplit}` : 
                         'Single') : 'Individual';
                    const catColor = getCategoryColor(expense.category);
                    
                    return `
                        <div style="background: ${sharedBg}; border-left: 4px solid ${borderColor}; border-radius: 12px; padding: 14px 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; flex-wrap: wrap;">
                                    <span style="background: ${sharedBadgeBg}; color: ${sharedBadgeColor}; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">${isShared ? 'üë• Shared' : 'üë§ Individual'}</span>
                                    <span style="background: rgba(255,255,255,0.05); color: ${catColor}; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 500; border: 1px solid ${catColor}40;">${expense.category}</span>
                                    <span style="background: ${paidBadgeBg}; color: ${paidBadgeColor}; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 500;">${paidByName}</span>
                                    <span style="color: var(--text-secondary); font-size: 12px;">${splitText}</span>
                                </div>
                                <div style="display: flex; align-items: baseline; gap: 8px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">${new Date(expense.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}</span>
                                    ${expense.notes ? `<span style="color: var(--text-secondary); font-size: 13px;">¬∑ ${expense.notes}</span>` : ''}
                                    ${expense.isRecurring ? '<span style="font-size: 12px;">üîÑ</span>' : ''}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="font-size: 18px; font-weight: 700; color: var(--text-primary); white-space: nowrap;">$${expense.amount.toFixed(2)}</div>
                                <div style="display: flex; gap: 4px;">
                                    <button class="btn btn-secondary btn-small" onclick="editExpense(${expense.id})">‚úèÔ∏è</button>
                                    <button class="btn btn-danger btn-small" onclick="deleteExpense(${expense.id})">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function getFilteredExpenses() {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const personFilter = document.getElementById('personFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;

            return appState.expenses.filter(expense => {
                // Migrate old expenses without isShared field
                if (expense.isShared === undefined) {
                    expense.isShared = true;
                }
                
                if (searchTerm && !expense.notes.toLowerCase().includes(searchTerm) && 
                    !expense.category.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                if (categoryFilter && expense.category !== categoryFilter) return false;
                if (personFilter && expense.whoPaid !== personFilter) return false;
                if (typeFilter) {
                    const isShared = expense.isShared !== false; // Default to true for backwards compatibility
                    if (typeFilter === 'shared' && !isShared) return false;
                    if (typeFilter === 'individual' && isShared) return false;
                }
                if (monthFilter) {
                    const expenseMonth = new Date(expense.date).toISOString().substring(0, 7);
                    if (expenseMonth !== monthFilter) return false;
                }
                return true;
            });
        }

        function filterTransactions() {
            renderTransactions();
        }

        function editExpense(id) {
            const expense = appState.expenses.find(e => e.id === id);
            if (!expense) return;

            // Fill form with expense data
            document.getElementById('amount').value = expense.amount;
            document.getElementById('category').value = expense.category;
            document.getElementById('whoPaid').value = expense.whoPaid;
            document.getElementById('splitType').value = expense.splitType;
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('notes').value = expense.notes || '';
            document.getElementById('isRecurring').checked = expense.isRecurring || false;
            document.getElementById('isShared').checked = expense.isShared !== false; // Default to true for backwards compatibility
            
            if (expense.customSplit) {
                document.getElementById('customSplit').value = expense.customSplit;
                document.getElementById('customSplitGroup').style.display = 'block';
            }

            // Update form visibility based on shared status
            handleSharedToggle();

            // Remove old expense and switch to add tab
            deleteExpense(id);
            switchTab('add-expense');
        }

        // Budget Management
        function saveBudgets() {
            const shared = parseFloat(document.getElementById('sharedBudget').value);
            const p1 = parseFloat(document.getElementById('partner1Budget').value);
            const p2 = parseFloat(document.getElementById('partner2Budget').value);
            if (!isNaN(shared)) appState.budgets.shared = shared;
            if (!isNaN(p1)) appState.budgets.partner1Total = p1;
            if (!isNaN(p2)) appState.budgets.partner2Total = p2;
            // Keep backward compat: total = shared (for dashboard)
            appState.budgets.total = (appState.budgets.shared || 0) + (appState.budgets.partner1Total || 0) + (appState.budgets.partner2Total || 0);
            saveData();
            updateDisplay();
            renderBudget();
            showToast('Budgets saved!', 'success');
        }

        // Migrate old budget format
        function migrateBudgets() {
            if (appState.budgets.total && !appState.budgets.shared && !appState.budgets.partner1Total) {
                appState.budgets.shared = appState.budgets.total;
                saveData();
            }
        }

        function renderBudget() {
            migrateBudgets();
            // Set budget inputs
            document.getElementById('sharedBudget').value = appState.budgets.shared || '';
            document.getElementById('partner1Budget').value = appState.budgets.partner1Total || '';
            document.getElementById('partner2Budget').value = appState.budgets.partner2Total || '';
            // Update partner titles
            document.getElementById('partner1BudgetTitle').textContent = 'üë§ ' + appState.partners.partner1 + "'s Personal Budget";
            document.getElementById('partner2BudgetTitle').textContent = 'üë§ ' + appState.partners.partner2 + "'s Personal Budget";
            // Update month display
            const budgetMonth = document.getElementById('budgetMonth');
            if (budgetMonth) budgetMonth.textContent = appState.currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Render category budgets
            const container = document.getElementById('budgetCategories');
            const currentExpenses = getCurrentMonthExpenses();
            const categorySpending = {};

            currentExpenses.forEach(expense => {
                categorySpending[expense.category] = (categorySpending[expense.category] || 0) + expense.amount;
            });

            const budgetItems = appState.categories.map(category => {
                const spent = categorySpending[category] || 0;
                const budget = appState.budgets[category] || 0;
                const percentage = budget > 0 ? (spent / budget) * 100 : 0;
                const isOverBudget = spent > budget && budget > 0;

                return `
                    <div class="budget-item">
                        <div class="budget-info">
                            <div class="budget-category">${category}</div>
                            <div class="budget-spent">$${spent.toFixed(2)} spent</div>
                            ${budget > 0 ? `
                                <div class="progress-bar">
                                    <div class="progress-fill ${isOverBudget ? 'danger' : percentage > 75 ? 'warning' : ''}" 
                                         style="width: ${Math.min(percentage, 100)}%"></div>
                                </div>
                            ` : ''}
                        </div>
                        <input type="number" class="form-input" style="width: 120px;" 
                               placeholder="Budget" value="${budget || ''}" 
                               onchange="setCategoryBudget('${category}', this.value)">
                    </div>
                `;
            }).join('');

            container.innerHTML = budgetItems;
        }

        function setCategoryBudget(category, value) {
            const budget = parseFloat(value) || 0;
            if (budget >= 0) {
                appState.budgets[category] = budget;
                saveData();
                renderBudget();
                updateDisplay();
            }
        }

        // Settlement Management
        function renderSettlement() {
            const balance = calculatePartnerBalance();
            const amount = document.getElementById('settlementAmount');
            const label = document.getElementById('settlementLabel');
            const button = document.getElementById('settleButton');

            amount.textContent = balance.amount;
            amount.className = `settlement-amount ${balance.rawBalance > 0 ? 'positive' : balance.rawBalance < 0 ? 'negative' : ''}`;
            label.textContent = balance.label;

            if (Math.abs(balance.rawBalance) < 0.01) {
                button.style.display = 'none';
            } else {
                button.style.display = 'inline-flex';
            }

            renderPaymentBreakdown();
        }

        function renderPaymentBreakdown() {
            // Only shared expenses matter for settlement breakdown
            const sharedExpenses = getCurrentMonthExpenses().filter(e => e.isShared !== false);
            const partner1Paid = sharedExpenses.filter(e => e.whoPaid === 'partner1').reduce((sum, e) => sum + e.amount, 0);
            const partner2Paid = sharedExpenses.filter(e => e.whoPaid === 'partner2').reduce((sum, e) => sum + e.amount, 0);
            const total = partner1Paid + partner2Paid;

            const container = document.getElementById('paymentBreakdown');
            const partner1Fair = total / 2;
            const partner2Fair = total / 2;

            container.innerHTML = `
                <div class="budget-item">
                    <div class="budget-info">
                        <div class="budget-category">${appState.partners.partner1} paid (shared expenses)</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${total > 0 ? (partner1Paid / total * 100) : 0}%"></div>
                        </div>
                        <div class="budget-spent">Fair share: $${partner1Fair.toFixed(2)}</div>
                    </div>
                    <div class="budget-amount">$${partner1Paid.toFixed(2)}</div>
                </div>
                <div class="budget-item">
                    <div class="budget-info">
                        <div class="budget-category">${appState.partners.partner2} paid (shared expenses)</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${total > 0 ? (partner2Paid / total * 100) : 0}%"></div>
                        </div>
                        <div class="budget-spent">Fair share: $${partner2Fair.toFixed(2)}</div>
                    </div>
                    <div class="budget-amount">$${partner2Paid.toFixed(2)}</div>
                </div>
                <div class="budget-item" style="border-top: 1px solid var(--glass-border); padding-top: 16px; margin-top: 8px;">
                    <div class="budget-info">
                        <div class="budget-category">Total shared expenses</div>
                    </div>
                    <div class="budget-amount">$${total.toFixed(2)}</div>
                </div>
            `;
        }

        function settleUp() {
            if (confirm('Mark all balances as settled? This will add a settlement transaction.')) {
                const balance = calculatePartnerBalance();
                if (Math.abs(balance.rawBalance) > 0.01) {
                    const settlementExpense = {
                        id: Date.now(),
                        amount: Math.abs(balance.rawBalance),
                        category: 'Settlement',
                        whoPaid: balance.rawBalance < 0 ? 'partner1' : 'partner2',
                        splitType: 'single',
                        date: new Date().toISOString().split('T')[0],
                        notes: 'Settlement payment',
                        isRecurring: false,
                        isShared: false,
                        timestamp: new Date()
                    };
                    
                    addExpense(settlementExpense);
                    updateDisplay();
                    renderSettlement();
                }
            }
        }

        // Charts
        let currentAnalyticsView = 'combined';

        function setAnalyticsView(view, btn) {
            currentAnalyticsView = view;
            // Update active button
            document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            renderCharts();
        }

        function getAnalyticsExpenses() {
            const expenses = getCurrentMonthExpenses();
            switch (currentAnalyticsView) {
                case 'shared': return expenses.filter(e => e.isShared !== false);
                case 'partner1': return expenses.filter(e => e.whoPaid === 'partner1');
                case 'partner2': return expenses.filter(e => e.whoPaid === 'partner2');
                default: return expenses;
            }
        }

        function renderCharts() {
            // Update analytics month display
            const analyticsMonth = document.getElementById('analyticsMonth');
            if (analyticsMonth) {
                analyticsMonth.textContent = appState.currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            }
            // Update partner button labels
            const p1btn = document.getElementById('viewPartner1Btn');
            const p2btn = document.getElementById('viewPartner2Btn');
            if (p1btn) p1btn.textContent = 'üë§ ' + appState.partners.partner1;
            if (p2btn) p2btn.textContent = 'üë§ ' + appState.partners.partner2;

            renderCategoryChart();
            renderPartnerChart();
            renderMonthlyChart();
            renderDailyChart();
        }

        function renderCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            // Destroy existing chart to prevent memory leaks
            if (window.categoryChart instanceof Chart) {
                window.categoryChart.destroy();
            }
            
            const expenses = getAnalyticsExpenses();
            const categoryTotals = {};

            expenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
            });

            let data = Object.entries(categoryTotals).map(([category, amount]) => ({
                label: category,
                amount: amount
            })).sort((a, b) => b.amount - a.amount);

            // Handle empty data
            if (data.length === 0) {
                data = [{ label: 'No expenses yet', amount: 1 }];
            }

            window.categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.label),
                    datasets: [{
                        data: data.map(d => d.amount),
                        backgroundColor: [
                            '#6366f1', '#06b6d4', '#10b981', '#f59e0b', '#ef4444',
                            '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#84cc16'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    }
                }
            });
        }

        function renderPartnerChart() {
            const ctx = document.getElementById('partnerChart').getContext('2d');
            
            // Destroy existing chart to prevent memory leaks
            if (window.partnerChart instanceof Chart) {
                window.partnerChart.destroy();
            }
            
            const expenses = getAnalyticsExpenses();
            
            // Separate shared and individual expenses
            const sharedExpenses = expenses.filter(e => e.isShared !== false);
            const individualExpenses = expenses.filter(e => e.isShared === false);
            
            const partner1Shared = sharedExpenses.filter(e => e.whoPaid === 'partner1').reduce((sum, e) => sum + e.amount, 0);
            const partner2Shared = sharedExpenses.filter(e => e.whoPaid === 'partner2').reduce((sum, e) => sum + e.amount, 0);
            const partner1Individual = individualExpenses.filter(e => e.whoPaid === 'partner1').reduce((sum, e) => sum + e.amount, 0);
            const partner2Individual = individualExpenses.filter(e => e.whoPaid === 'partner2').reduce((sum, e) => sum + e.amount, 0);

            const data = [];
            const labels = [];
            const colors = [];
            
            if (partner1Shared > 0) {
                data.push(partner1Shared);
                labels.push(`${appState.partners.partner1} (Shared)`);
                colors.push('#6366f1');
            }
            if (partner2Shared > 0) {
                data.push(partner2Shared);
                labels.push(`${appState.partners.partner2} (Shared)`);
                colors.push('#06b6d4');
            }
            if (partner1Individual > 0) {
                data.push(partner1Individual);
                labels.push(`${appState.partners.partner1} (Individual)`);
                colors.push('#8b5cf6');
            }
            if (partner2Individual > 0) {
                data.push(partner2Individual);
                labels.push(`${appState.partners.partner2} (Individual)`);
                colors.push('#14b8a6');
            }
            
            // Handle empty data
            if (data.length === 0) {
                data.push(1);
                labels.push('No expenses yet');
                colors.push('#4b5563');
            }

            window.partnerChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    }
                }
            });
        }

        function renderMonthlyChart() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            
            // Destroy existing chart to prevent memory leaks
            if (window.monthlyChart instanceof Chart) {
                window.monthlyChart.destroy();
            }
            
            const months = [];
            const totals = [];

            for (let i = 5; i >= 0; i--) {
                const month = new Date();
                month.setMonth(month.getMonth() - i);
                const monthExpenses = appState.expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getMonth() === month.getMonth() && 
                           expenseDate.getFullYear() === month.getFullYear();
                });
                
                months.push(month.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
                totals.push(monthExpenses.reduce((sum, e) => sum + e.amount, 0));
            }

            window.monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Monthly Spending',
                        data: totals,
                        backgroundColor: '#6366f1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#ffffff' },
                            grid: { color: '#374151' }
                        },
                        x: {
                            ticks: { color: '#ffffff' },
                            grid: { color: '#374151' }
                        }
                    }
                }
            });
        }

        function renderDailyChart() {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            // Destroy existing chart to prevent memory leaks
            if (window.dailyChart instanceof Chart) {
                window.dailyChart.destroy();
            }
            
            const expenses = getAnalyticsExpenses();
            
            const daysInMonth = new Date(appState.currentMonth.getFullYear(), appState.currentMonth.getMonth() + 1, 0).getDate();
            const dailyTotals = new Array(daysInMonth).fill(0);
            const cumulativeSpending = [];
            
            expenses.forEach(expense => {
                const day = new Date(expense.date).getDate();
                dailyTotals[day - 1] += expense.amount;
            });

            let cumulative = 0;
            for (let i = 0; i < daysInMonth; i++) {
                cumulative += dailyTotals[i];
                cumulativeSpending.push(cumulative);
            }

            const totalBudget = appState.budgets.total || 0;
            const budgetLine = totalBudget > 0 ? 
                new Array(daysInMonth).fill().map((_, i) => (totalBudget / daysInMonth) * (i + 1)) :
                new Array(daysInMonth).fill(0);

            window.dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: daysInMonth}, (_, i) => i + 1),
                    datasets: [
                        {
                            label: 'Cumulative Spending (All)',
                            data: cumulativeSpending,
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            fill: true
                        },
                        {
                            label: 'Budget Pace',
                            data: budgetLine,
                            borderColor: '#10b981',
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#ffffff' },
                            grid: { color: '#374151' }
                        },
                        x: {
                            ticks: { color: '#ffffff' },
                            grid: { color: '#374151' }
                        }
                    }
                }
            });
        }

        // Settings Management
        function savePartnerNames() {
            const partner1 = document.getElementById('partner1Name').value.trim();
            const partner2 = document.getElementById('partner2Name').value.trim();
            
            if (partner1) appState.partners.partner1 = partner1;
            if (partner2) appState.partners.partner2 = partner2;
            
            saveData();
            updateDisplay();
            
            // Update dropdowns
            const selects = document.querySelectorAll('#whoPaid, #personFilter');
            selects.forEach(select => {
                const options = select.querySelectorAll('option');
                if (options[0]) options[0].textContent = partner1 || 'Partner 1';
                if (options[1]) options[1].textContent = partner2 || 'Partner 2';
            });
        }

        function exportData() {
            const data = {
                expenses: appState.expenses,
                budgets: appState.budgets,
                partners: appState.partners,
                categories: appState.categories,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finsync-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('This will replace all current data. Continue?')) {
                        appState.expenses = data.expenses || [];
                        appState.budgets = data.budgets || {};
                        appState.partners = data.partners || appState.partners;
                        appState.categories = data.categories || appState.categories;
                        
                        saveData();
                        initializeApp();
                        updateDisplay();
                        
                        alert('Data imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing data. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('This will delete ALL data permanently. Are you sure?')) {
                if (confirm('Really sure? This cannot be undone!')) {
                    if (currentUser) {
                        localStorage.removeItem(`finSyncData_${currentUser}`);
                        localStorage.removeItem(`finSyncOnboarded_${currentUser}`);
                    }
                    appState.expenses = [];
                    appState.budgets = {};
                    location.reload();
                }
            }
        }

        function addCustomCategory() {
            const input = document.getElementById('newCategory');
            const category = input.value.trim();
            
            if (category && !appState.categories.includes(category)) {
                appState.categories.push(category);
                saveData();
                populateSelectors();
                renderCustomCategories();
                input.value = '';
            }
        }

        function removeCustomCategory(category) {
            if (confirm(`Remove category "${category}"? Existing expenses will keep this category.`)) {
                appState.categories = appState.categories.filter(c => c !== category);
                saveData();
                populateSelectors();
                renderCustomCategories();
            }
        }

        function renderCustomCategories() {
            const defaultCategories = [
                'Food/Dining', 'Groceries', 'Rent/Housing', 'Utilities', 
                'Transport', 'Entertainment', 'Subscriptions', 'Health', 
                'Shopping', 'Travel', 'Gifts', 'Other'
            ];
            
            const customCategories = appState.categories.filter(c => !defaultCategories.includes(c));
            const container = document.getElementById('customCategoriesList');
            
            if (customCategories.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No custom categories yet</p>';
                return;
            }
            
            container.innerHTML = customCategories.map(category => `
                <div class="budget-item">
                    <div class="budget-info">
                        <div class="budget-category">${category}</div>
                    </div>
                    <button class="btn btn-danger btn-small" onclick="removeCustomCategory('${category}')">Remove</button>
                </div>
            `).join('');
        }

        // Recurring Expenses
        function renderRecurringExpenses() {
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            const recurringExpenses = appState.expenses.filter(e => e.isRecurring && e.date && e.category);
            const monthlyRecurring = recurringExpenses.filter(e => {
                const expenseMonth = e.date.substring(0, 7);
                return expenseMonth !== currentMonth;
            });
            
            let added = false;
            monthlyRecurring.forEach(expense => {
                // More specific check to prevent duplicates
                const exists = appState.expenses.some(e => 
                    e.category === expense.category &&
                    e.amount === expense.amount &&
                    e.whoPaid === expense.whoPaid &&
                    e.date.substring(0, 7) === currentMonth &&
                    (e.notes || '').includes('Auto-generated')
                );
                
                if (!exists) {
                    const newExpense = {
                        ...expense,
                        id: Date.now() + Math.random(),
                        date: `${currentMonth}-01`,
                        notes: `${expense.notes || expense.category} (Auto-generated)`,
                        timestamp: new Date(),
                        isShared: expense.isShared !== false // Preserve shared status
                    };
                    
                    appState.expenses.push(newExpense);
                    added = true;
                }
            });
            
            if (added) {
                saveData();
            }
        }

        // Utility Functions
        function populateSelectors() {
            // Category selectors
            const categorySelects = document.querySelectorAll('#category, #categoryFilter');
            categorySelects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = select.id === 'categoryFilter' ? '<option value="">All Categories</option>' : '<option value="">Select category</option>';
                
                appState.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    select.appendChild(option);
                });
                
                if (currentValue) select.value = currentValue;
            });

            // Month filter
            const monthFilter = document.getElementById('monthFilter');
            const months = [...new Set(appState.expenses.map(e => e.date.substring(0, 7)))].sort().reverse();
            monthFilter.innerHTML = '<option value="">All Months</option>' + 
                months.map(month => `<option value="${month}">${new Date(month + '-01').toLocaleDateString('en-US', {month: 'long', year: 'numeric'})}</option>`).join('');

            // Update partner names in selectors
            document.querySelectorAll('#whoPaid option[value="partner1"]').forEach(option => {
                option.textContent = appState.partners.partner1;
            });
            document.querySelectorAll('#whoPaid option[value="partner2"]').forEach(option => {
                option.textContent = appState.partners.partner2;
            });
        }

        // Receipt Scanning Functions (server-side AI via api.gary-yong.com)
        const RECEIPT_API = 'https://api.gary-yong.com/receipt/scan';
        let scannedItems = [];
        let currentReceiptImage = null;

        function handleReceiptFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image file', 'error');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                showToast('File too large ‚Äî max 10MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentReceiptImage = e.target.result;
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('uploadArea').style.display = 'none';
                document.getElementById('receiptPreview').style.display = 'block';
                document.getElementById('scanResults').classList.remove('show');
                scannedItems = [];
            };
            reader.readAsDataURL(file);
        }

        function clearReceipt() {
            currentReceiptImage = null;
            scannedItems = [];
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('receiptPreview').style.display = 'none';
            document.getElementById('scanResults').classList.remove('show');
            document.getElementById('receiptFile').value = '';
        }

        async function scanReceipt() {
            if (!currentReceiptImage) {
                showToast('Please select an image first', 'error');
                return;
            }
            
            document.getElementById('receiptPreview').style.display = 'none';
            document.getElementById('scanLoading').style.display = 'block';
            document.getElementById('scanResults').classList.remove('show');
            
            try {
                const response = await fetch(RECEIPT_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: currentReceiptImage }),
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || `Server error ${response.status}`);
                }
                
                if (!result.success) {
                    throw new Error(result.error || 'No transactions found in this image');
                }
                
                const parsedData = result.data;
                const receiptDate = parsedData.date || new Date().toISOString().split('T')[0];
                
                scannedItems = parsedData.items.map((item, index) => ({
                    id: `scanned-${Date.now()}-${index}`,
                    description: item.description || item.name || 'Unknown item',
                    amount: parseFloat(item.amount) || 0,
                    category: mapToAppCategory(item.category || 'Other'),
                    date: receiptDate,
                    selected: true,
                    shared: true,
                    whoPaid: 'partner1'
                }));
                
                document.getElementById('scanLoading').style.display = 'none';
                document.getElementById('receiptPreview').style.display = 'block';
                showScanResults(parsedData);
                showToast(`Found ${scannedItems.length} transaction${scannedItems.length !== 1 ? 's' : ''}!`, 'success');
                
            } catch (error) {
                document.getElementById('scanLoading').style.display = 'none';
                document.getElementById('receiptPreview').style.display = 'block';
                console.error('Scan error:', error);
                showToast(`Scan failed: ${error.message}`, 'error');
            }
        }
        
        function mapToAppCategory(category) {
            // Map AI-suggested categories to exact app categories
            const mapping = {
                'food': 'Food/Dining', 'dining': 'Food/Dining', 'restaurant': 'Food/Dining',
                'grocery': 'Groceries', 'groceries': 'Groceries', 'supermarket': 'Groceries',
                'rent': 'Rent/Housing', 'housing': 'Rent/Housing', 'mortgage': 'Rent/Housing',
                'utilities': 'Utilities', 'utility': 'Utilities', 'bills': 'Utilities',
                'transport': 'Transport', 'transportation': 'Transport', 'gas': 'Transport', 'fuel': 'Transport',
                'entertainment': 'Entertainment', 'fun': 'Entertainment',
                'subscriptions': 'Subscriptions', 'subscription': 'Subscriptions',
                'health': 'Health', 'medical': 'Health', 'pharmacy': 'Health',
                'shopping': 'Shopping', 'clothes': 'Shopping', 'clothing': 'Shopping',
                'travel': 'Travel', 'hotel': 'Travel', 'flight': 'Travel',
                'gifts': 'Gifts', 'gift': 'Gifts',
            };
            
            // Check exact match first
            if (appState.categories.includes(category)) return category;
            
            // Check mapping
            const lower = category.toLowerCase();
            if (mapping[lower]) return mapping[lower];
            
            // Partial match
            for (const [key, val] of Object.entries(mapping)) {
                if (lower.includes(key) || key.includes(lower)) return val;
            }
            
            return 'Other';
        }

        function showScanResults(data) {
            const results = document.getElementById('scanResults');
            const list = document.getElementById('scanResultsList');
            
            list.innerHTML = scannedItems.map(item => `
                <div class="scan-result-item ${item.selected ? 'selected' : ''}" data-item-id="${item.id}">
                    <div class="result-header">
                        <input type="checkbox" class="result-checkbox" ${item.selected ? 'checked' : ''} 
                               onchange="toggleItemSelection('${item.id}')">
                        <strong>Item ${scannedItems.findIndex(i => i.id === item.id) + 1}</strong>
                    </div>
                    <div class="result-fields">
                        <div class="result-field">
                            <label>Description</label>
                            <input type="text" value="${item.description}" 
                                   onchange="updateItemField('${item.id}', 'description', this.value)">
                        </div>
                        <div class="result-field">
                            <label>Amount</label>
                            <input type="number" step="0.01" value="${item.amount}" 
                                   onchange="updateItemField('${item.id}', 'amount', parseFloat(this.value))">
                        </div>
                        <div class="result-field">
                            <label>Category</label>
                            <select onchange="updateItemField('${item.id}', 'category', this.value)">
                                ${appState.categories.map(cat => 
                                    `<option value="${cat}" ${cat === item.category ? 'selected' : ''}>${cat}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="result-field">
                            <label>Who Paid</label>
                            <select onchange="updateItemField('${item.id}', 'whoPaid', this.value)">
                                <option value="partner1" ${item.whoPaid === 'partner1' ? 'selected' : ''}>${appState.partners.partner1}</option>
                                <option value="partner2" ${item.whoPaid === 'partner2' ? 'selected' : ''}>${appState.partners.partner2}</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <label class="shared-toggle">
                            <input type="checkbox" ${item.shared ? 'checked' : ''} 
                                   onchange="updateItemField('${item.id}', 'shared', this.checked)">
                            <span>üë• Shared expense</span>
                        </label>
                    </div>
                </div>
            `).join('');
            
            updateScanSummary();
            results.classList.add('show');
        }

        function toggleItemSelection(itemId) {
            const item = scannedItems.find(i => i.id === itemId);
            if (item) {
                item.selected = !item.selected;
                const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
                itemElement.classList.toggle('selected', item.selected);
                updateScanSummary();
            }
        }

        function updateItemField(itemId, field, value) {
            const item = scannedItems.find(i => i.id === itemId);
            if (item) {
                item[field] = value;
                updateScanSummary();
            }
        }

        function updateScanSummary() {
            const selectedItems = scannedItems.filter(item => item.selected);
            const total = selectedItems.reduce((sum, item) => sum + item.amount, 0);
            
            document.getElementById('summaryTotal').textContent = `$${total.toFixed(2)}`;
            document.getElementById('summaryCount').textContent = 
                `${selectedItems.length} item${selectedItems.length !== 1 ? 's' : ''} selected`;
        }

        function addSelectedExpenses() {
            const selectedItems = scannedItems.filter(item => item.selected);
            
            if (selectedItems.length === 0) {
                showToast('Please select at least one item to add', 'warning');
                return;
            }
            
            let addedCount = 0;
            
            selectedItems.forEach(item => {
                const expense = {
                    id: Date.now() + Math.random(),
                    amount: item.amount,
                    category: item.category,
                    whoPaid: item.whoPaid,
                    splitType: item.shared ? '50/50' : 'single',
                    customSplit: null,
                    date: item.date || new Date().toISOString().split('T')[0],
                    notes: item.description,
                    isRecurring: false,
                    isShared: item.shared,
                    timestamp: new Date()
                };
                
                addExpense(expense);
                addedCount++;
            });
            
            updateDisplay();
            
            // Clear results and input
            scannedItems = [];
            document.getElementById('scanResults').classList.remove('show');
            document.getElementById('transactionCodeInput').value = '';
            
            showToast(`Added ${addedCount} expense${addedCount !== 1 ? 's' : ''}! üéâ`, 'success');
            switchTab('transactions');
        }

        // Initialize charts after page load
        setTimeout(renderCharts, 100);
    </script>
</body>
</html>