<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinSync - Smart Budgeting, Together or Solo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #0a0a1a;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-start: #6366f1;
            --accent-end: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --glass-bg: rgba(255, 255, 255, 0.02);
            --glass-border: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* Background Pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(6, 182, 212, 0.1) 0%, transparent 50%);
            z-index: -1;
            pointer-events: none;
        }

        /* Glass Card */
        .glass-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            padding: 24px;
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        /* Layout */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-header h1 {
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 28px;
            font-weight: 700;
            text-align: center;
        }

        .tab-nav {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        .app-content {
            flex: 1;
            padding: 0 20px 40px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .month-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 32px;
        }

        .month-nav button {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .month-nav button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .current-month {
            font-size: 24px;
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-start);
            background: rgba(255, 255, 255, 0.08);
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            background: #1a1a2e;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
        }

        .form-select option,
        select option {
            background: #1a1a2e;
            color: #ffffff;
        }

        .btn {
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            box-shadow: none;
        }

        .btn-danger {
            background: var(--danger);
        }

        /* Quick Add Form */
        .quick-add {
            margin-bottom: 32px;
        }

        .natural-input {
            font-size: 18px;
            padding: 16px 20px;
            margin-bottom: 16px;
        }

        .quick-add-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        /* Expense List */
        .expense-list {
            border-radius: 16px;
            overflow: hidden;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
        }

        .expense-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: between;
            align-items: center;
            gap: 16px;
        }

        .expense-item:last-child {
            border-bottom: none;
        }

        .expense-details {
            flex: 1;
        }

        .expense-amount {
            font-weight: 600;
            font-size: 18px;
        }

        .expense-meta {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }

        .expense-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 8px;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        /* AI Insights */
        .insights-panel {
            margin-bottom: 32px;
        }

        .insight-item {
            padding: 16px;
            margin-bottom: 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            border-left: 4px solid var(--accent-start);
        }

        .insight-item.warning {
            border-left-color: var(--warning);
        }

        .insight-item.danger {
            border-left-color: var(--danger);
        }

        .health-score {
            text-align: center;
            margin-bottom: 20px;
        }

        .health-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            position: relative;
        }

        .health-circle.excellent {
            background: conic-gradient(var(--success) 0deg, var(--success) calc(var(--score) * 3.6deg), var(--glass-bg) calc(var(--score) * 3.6deg));
        }

        .health-circle.good {
            background: conic-gradient(var(--warning) 0deg, var(--warning) calc(var(--score) * 3.6deg), var(--glass-bg) calc(var(--score) * 3.6deg));
        }

        .health-circle.poor {
            background: conic-gradient(var(--danger) 0deg, var(--danger) calc(var(--score) * 3.6deg), var(--glass-bg) calc(var(--score) * 3.6deg));
        }

        /* Settlement */
        .settlement-card {
            text-align: center;
            margin-bottom: 24px;
        }

        .settlement-amount {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .settlement-amount.positive {
            color: var(--success);
        }

        .settlement-amount.negative {
            color: var(--danger);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        /* Progress Bars */
        .progress-bar {
            background: var(--glass-bg);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 0.3s ease;
            background: linear-gradient(90deg, var(--accent-start), var(--accent-end));
        }

        .progress-fill.warning {
            background: var(--warning);
        }

        .progress-fill.danger {
            background: var(--danger);
        }

        /* Budget Items */
        .budget-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .budget-item:last-child {
            border-bottom: none;
        }

        .budget-info {
            flex: 1;
        }

        .budget-category {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .budget-spent {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .budget-amount {
            font-weight: 600;
            min-width: 80px;
            text-align: right;
        }

        /* Mobile Navigation */
        .tab-text {
            margin-left: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-header h1 {
                font-size: 24px;
            }
            
            .tab-nav {
                padding: 16px;
                gap: 8px;
            }
            
            .tab-btn {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .tab-text {
                display: none;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .expense-item {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .expense-actions {
                justify-content: center;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--glass-border);
            border-radius: 50%;
            border-top-color: var(--accent-start);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-input {
            flex: 1;
            min-width: 200px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--glass-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Login/Register System */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(20px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            backdrop-filter: blur(40px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            transform: translateY(20px);
            animation: slideUp 0.5s ease forwards 0.2s;
        }

        @keyframes slideUp {
            to {
                transform: translateY(0);
            }
        }

        .auth-header {
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 16px;
        }

        .auth-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .auth-toggle button {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .auth-toggle button.active {
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            color: white;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .auth-input {
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--accent-start);
            background: rgba(255, 255, 255, 0.1);
        }

        .auth-btn {
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 8px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* (partner-inputs removed ‚Äî registration simplified) */

        /* Onboarding System */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(10, 10, 26, 0.98);
            backdrop-filter: blur(20px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .onboarding-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 48px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            backdrop-filter: blur(40px);
            position: relative;
        }

        .onboarding-progress {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
        }

        .onboarding-step {
            display: none;
        }

        .onboarding-step.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        .onboarding-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .onboarding-text {
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .onboarding-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .skip-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-secondary);
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .skip-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            backdrop-filter: blur(20px);
            z-index: 2000;
            transform: translateX(400px);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: rgba(239, 68, 68, 0.9);
        }

        .toast.warning {
            background: rgba(245, 158, 11, 0.9);
        }

        .toast.info {
            background: rgba(99, 102, 241, 0.9);
        }

        /* Receipt Scanning Styles */
        .upload-area {
            border: 2px dashed var(--glass-border);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 24px;
        }

        .upload-area:hover {
            border-color: var(--accent-start);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--accent-start);
            background: rgba(99, 102, 241, 0.1);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--text-secondary);
        }

        .upload-text {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .upload-hint {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 8px;
            opacity: 0.7;
        }

        .image-preview {
            margin-bottom: 24px;
            text-align: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .scan-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 32px;
        }

        .scan-loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .scan-loading.show {
            display: block;
        }

        .scan-results {
            display: none;
        }

        .scan-results.show {
            display: block;
        }

        .scan-result-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .scan-result-item.selected {
            border-color: var(--accent-start);
            background: rgba(99, 102, 241, 0.05);
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .result-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .result-fields {
            display: grid;
            grid-template-columns: 2fr 1fr 1.5fr 1fr;
            gap: 12px;
            align-items: center;
        }

        .result-field {
            display: flex;
            flex-direction: column;
        }

        .result-field label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .result-field input,
        .result-field select {
            padding: 8px 12px;
            background: #1a1a2e;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .result-field select option {
            background: #1a1a2e;
            color: #ffffff;
        }

        .result-field input:focus,
        .result-field select:focus {
            outline: none;
            border-color: var(--accent-start);
        }

        .shared-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }

        .shared-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .scan-summary {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }

        .summary-total {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-start);
            margin-bottom: 8px;
        }

        .summary-count {
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .api-key-input {
            position: relative;
        }

        .api-key-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
        }

        .api-status {
            margin-top: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .api-status.set {
            color: var(--success);
        }

        .api-status.not-set {
            color: var(--warning);
        }

        @media (max-width: 768px) {
            .result-fields {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .upload-area {
                padding: 30px 15px;
            }
            
            .upload-icon {
                font-size: 36px;
            }
        }

        /* Mobile-friendly household/space selection */
        @media (max-width: 600px) {
            #householdOverlay .auth-card {
                max-width: 100%;
                width: 100%;
                max-height: 100vh;
                height: 100%;
                border-radius: 0;
                padding: 24px 16px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
            }
            #householdOverlay .auth-header {
                font-size: 28px;
                margin-bottom: 4px;
            }
            #householdOverlay .auth-subtitle {
                font-size: 14px;
                margin-bottom: 12px;
            }
            #householdOverlay #householdList h3 {
                font-size: 15px;
                margin-bottom: 8px;
            }
            #householdOverlay #householdOptions .auth-btn {
                padding: 14px 14px;
            }
            #householdOverlay #householdOptions .auth-btn span:first-child {
                font-size: 22px !important;
            }
            #householdOverlay #householdOptions strong {
                font-size: 14px !important;
            }
            #householdOverlay #householdOptions .auth-btn span span {
                font-size: 12px !important;
            }
        }
    </style>
</head>
<body>
    <!-- Login/Register Overlay -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-card">
            <h1 class="auth-header">FinSync</h1>
            <p class="auth-subtitle">Smart Budgeting, Together or Solo</p>
            
            <div class="auth-toggle">
                <button type="button" class="active" id="loginToggle">Login</button>
                <button type="button" id="registerToggle">Register</button>
            </div>

            <form class="auth-form" id="authForm">
                <input type="text" class="auth-input" id="registerNameInput" placeholder="Your Name" style="display: none;">
                <input type="email" class="auth-input" id="authEmail" placeholder="Email" required>
                <input type="password" class="auth-input" id="authPassword" placeholder="Password" required>
                
                <button type="submit" class="auth-btn" id="authSubmit">Login</button>
                <div id="forgotPasswordLink" style="text-align: center; margin-top: 12px;">
                    <a href="#" onclick="showResetPassword(); return false;" style="color: #818cf8; font-size: 14px; text-decoration: none;">Forgot Password?</a>
                </div>
            </form>

            <!-- Password Reset Form -->
            <form class="auth-form" id="resetForm" style="display: none;">
                <p style="color: #94a3b8; font-size: 14px; margin-bottom: 16px; text-align: center;">Enter your email to verify your account, then set a new password.</p>
                <input type="email" class="auth-input" id="resetEmail" placeholder="Email" required>
                <div id="resetNewPasswordFields" style="display: none;">
                    <input type="password" class="auth-input" id="resetNewPassword" placeholder="New Password">
                    <input type="password" class="auth-input" id="resetConfirmPassword" placeholder="Confirm New Password">
                </div>
                <button type="submit" class="auth-btn" id="resetSubmit">Verify Email</button>
                <div style="text-align: center; margin-top: 12px;">
                    <a href="#" onclick="cancelReset(); return false;" style="color: #818cf8; font-size: 14px; text-decoration: none;">‚Üê Back to Login</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Household Selection Overlay -->
    <div class="auth-overlay" id="householdOverlay" style="display: none;">
        <div class="auth-card" style="max-width: 500px;">
            <h1 class="auth-header">FinSync</h1>
            <p class="auth-subtitle" id="householdWelcome">Welcome! How would you like to budget?</p>

            <!-- Household list (if user has households) -->
            <div id="householdList" style="display: none; margin-bottom: 20px;">
                <h3 style="color: var(--text-primary); margin-bottom: 12px;">Your Spaces</h3>
                <div id="householdListItems"></div>
                <div style="border-top: 1px solid var(--glass-border); margin-top: 16px; padding-top: 16px;">
                    <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 8px;">Or create/join another space:</p>
                </div>
            </div>

            <!-- 3 Option Cards -->
            <div id="householdOptions" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px;">
                <button type="button" class="auth-btn" id="optionPersonal" style="display: flex; align-items: center; gap: 12px; text-align: left; padding: 18px 20px; background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.3);">
                    <span style="font-size: 28px;">üßë</span>
                    <span><strong style="display: block; font-size: 16px;">Personal Budget</strong><span style="font-size: 13px; opacity: 0.8; font-weight: 400;">Track your own spending ‚Äî quick setup</span></span>
                </button>
                <button type="button" class="auth-btn" id="optionCreate" style="display: flex; align-items: center; gap: 12px; text-align: left; padding: 18px 20px; background: rgba(99,102,241,0.15); border: 1px solid rgba(99,102,241,0.3);">
                    <span style="font-size: 28px;">üë•</span>
                    <span><strong style="display: block; font-size: 16px;">Create Shared Space</strong><span style="font-size: 13px; opacity: 0.8; font-weight: 400;">Budget with roommates, partners, or friends</span></span>
                </button>
                <button type="button" class="auth-btn" id="optionJoin" style="display: flex; align-items: center; gap: 12px; text-align: left; padding: 18px 20px; background: rgba(6,182,212,0.15); border: 1px solid rgba(6,182,212,0.3);">
                    <span style="font-size: 28px;">üîó</span>
                    <span><strong style="display: block; font-size: 16px;">Join a Space</strong><span style="font-size: 13px; opacity: 0.8; font-weight: 400;">Enter an invite code to join someone's space</span></span>
                </button>
            </div>

            <!-- Create Household Form (hidden until option selected) -->
            <form class="auth-form" id="createHouseholdForm" style="display: none;">
                <input type="text" class="auth-input" id="householdName" placeholder="Space Name (e.g. Roommates, Family)">
                <input type="text" class="auth-input" id="householdPartnerName" placeholder="Your Display Name">
                <button type="submit" class="auth-btn">üè† Create Space</button>
                <button type="button" class="skip-btn" onclick="showHouseholdOptions()">‚Üê Back</button>
            </form>

            <!-- Join Household Form (hidden until option selected) -->
            <form class="auth-form" id="joinHouseholdForm" style="display: none;">
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px; text-align: center;">Ask the space owner for their 6-character invite code</p>
                <input type="text" class="auth-input" id="joinInviteCode" placeholder="e.g. A1B2C3" maxlength="6" autocomplete="off" style="text-transform: uppercase; letter-spacing: 4px; text-align: center; font-size: 22px; font-weight: 700;">
                <input type="text" class="auth-input" id="joinPartnerName" placeholder="Your Display Name (how others see you)">
                <div id="joinError" style="display: none; color: #f87171; font-size: 13px; text-align: center; margin-bottom: 8px;"></div>
                <button type="submit" class="auth-btn" id="joinSubmitBtn">üîó Join Space</button>
                <button type="button" class="skip-btn" onclick="showHouseholdOptions()">‚Üê Back</button>
            </form>

            <!-- Invite Code Display (after creating) -->
            <div id="inviteCodeDisplay" style="display: none; text-align: center; padding: 20px 0;">
                <p style="color: var(--text-secondary); margin-bottom: 4px;">üéâ Space created! Share this code:</p>
                <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 12px;">Others can join with this code at gary-yong.com/budget.html</p>
                <div style="background: rgba(99,102,241,0.15); border: 2px dashed rgba(99,102,241,0.4); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
                    <span id="inviteCodeText" style="font-size: 28px; font-weight: 700; letter-spacing: 4px; color: #818cf8; user-select: all;"></span>
                </div>
                <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 16px;">
                    <button type="button" class="auth-btn" style="flex: 1; max-width: 160px; font-size: 14px; padding: 10px;" onclick="copyNewSpaceCode()">üìã Copy Code</button>
                    <button type="button" class="auth-btn" style="flex: 1; max-width: 160px; font-size: 14px; padding: 10px; background: rgba(255,255,255,0.1);" onclick="shareNewSpaceInvite()">üì§ Share</button>
                </div>
                <button class="auth-btn" id="enterSpaceBtn" onclick="enterCurrentHousehold()" style="background: linear-gradient(135deg, var(--accent-start), var(--accent-end));">Enter Space ‚Üí</button>
            </div>

            <div style="text-align: center; margin-top: 12px;">
                <a href="#" onclick="logout(); return false;" style="color: #818cf8; font-size: 14px; text-decoration: none;">‚Üê Logout</a>
            </div>
        </div>
    </div>

    <!-- Onboarding Overlay -->
    <div class="onboarding-overlay" id="onboardingOverlay" style="display: none;">
        <div class="onboarding-card">
            <div class="onboarding-progress">
                <div class="progress-dot active" data-step="1"></div>
                <div class="progress-dot" data-step="2"></div>
                <div class="progress-dot" data-step="3"></div>
                <div class="progress-dot" data-step="4"></div>
            </div>

            <!-- Step 1: Welcome -->
            <div class="onboarding-step active" data-step="1">
                <h2 class="onboarding-title">Welcome to FinSync! üéâ</h2>
                <p class="onboarding-text">Your new favorite way to manage finances. Track expenses, set budgets, and stay on top of your spending.</p>
                <div class="onboarding-actions">
                    <button class="skip-btn" onclick="skipOnboarding()">Skip</button>
                    <button class="auth-btn" onclick="nextOnboardingStep()">Get Started</button>
                </div>
            </div>

            <!-- Step 2: Budget -->
            <div class="onboarding-step" data-step="2">
                <h2 class="onboarding-title">Set Your Budget üí∞</h2>
                <p class="onboarding-text">How much do you plan to spend this month?</p>
                <input type="number" class="auth-input" id="onboardingBudget" placeholder="Monthly Budget (e.g., 2000)" style="margin-bottom: 24px;">
                <div class="onboarding-actions">
                    <button class="skip-btn" onclick="prevOnboardingStep()">Back</button>
                    <button class="auth-btn" onclick="nextOnboardingStep()">Continue</button>
                </div>
            </div>

            <!-- Step 3: First Expense -->
            <div class="onboarding-step" data-step="3">
                <h2 class="onboarding-title">Add Your First Expense üìù</h2>
                <p class="onboarding-text">Try our natural language input! Just describe your expense.</p>
                <input type="text" class="auth-input" id="onboardingExpense" placeholder="Try: 'lunch at chipotle $18' or 'groceries $45 split'" style="margin-bottom: 24px;">
                <div class="onboarding-actions">
                    <button class="skip-btn" onclick="prevOnboardingStep()">Back</button>
                    <button class="auth-btn" onclick="nextOnboardingStep()">Add Expense</button>
                </div>
            </div>

            <!-- Step 4: Complete -->
            <div class="onboarding-step" data-step="4">
                <h2 class="onboarding-title">You're All Set! üöÄ</h2>
                <p class="onboarding-text">Welcome to FinSync! Your budget is set and you're ready to start tracking. Happy budgeting!</p>
                <div class="onboarding-actions">
                    <button class="auth-btn" onclick="completeOnboarding()">Start Using FinSync</button>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer" style="display: none;">
        <header class="app-header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap;">
                <h1>FinSync</h1>
                <div id="spaceSwitcher" style="display: none; position: relative;">
                    <button id="spaceSwitcherBtn" style="background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border); color: var(--text-primary); padding: 6px 14px; border-radius: 10px; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-family: inherit;">
                        <span id="currentSpaceName" style="max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">My Space</span>
                        <span style="font-size: 10px;">‚ñº</span>
                    </button>
                    <div id="spaceSwitcherDropdown" style="display: none; position: absolute; top: calc(100% + 6px); right: 0; min-width: 220px; background: #1a1a2e; border: 1px solid var(--glass-border); border-radius: 12px; overflow: hidden; z-index: 200; box-shadow: 0 8px 30px rgba(0,0,0,0.5);">
                    </div>
                </div>
            </div>
        </header>

        <nav class="tab-nav">
            <button class="tab-btn active" data-tab="dashboard">üìä<span class="tab-text"> Dashboard</span></button>
            <button class="tab-btn" data-tab="add-expense">‚ûï<span class="tab-text"> Add Expense</span></button>
            <button class="tab-btn" data-tab="scan-receipt">üì∑<span class="tab-text"> Scan</span></button>
            <button class="tab-btn" data-tab="transactions">üí≥<span class="tab-text"> Transactions</span></button>
            <button class="tab-btn" data-tab="budget">üí∞<span class="tab-text"> Budget</span></button>
            <button class="tab-btn" data-tab="analytics">üìà<span class="tab-text"> Analytics</span></button>
            <button class="tab-btn" data-tab="settlement">ü§ù<span class="tab-text"> Settlement</span></button>
            <button class="tab-btn" data-tab="settings">‚öôÔ∏è<span class="tab-text"> Settings</span></button>
        </nav>

        <main class="app-content">
            <!-- Dashboard Tab -->
            <div class="tab-content active" id="dashboard">
                <div class="month-nav">
                    <button id="prevMonth">‚Äπ</button>
                    <div class="current-month" id="currentMonth">February 2026</div>
                    <button id="nextMonth">‚Ä∫</button>
                </div>

                <div class="dashboard-grid">
                    <div class="glass-card stat-card">
                        <div class="stat-value" id="totalSpent">$0</div>
                        <div class="stat-label">Total Spent</div>
                    </div>
                    <div class="glass-card stat-card">
                        <div class="stat-value" id="budgetRemaining">$0</div>
                        <div class="stat-label">Budget Remaining</div>
                    </div>
                    <div class="glass-card stat-card">
                        <div class="stat-value" id="partnerBalance">$0</div>
                        <div class="stat-label">Balance</div>
                    </div>
                </div>

                <div class="glass-card insights-panel">
                    <h3 style="margin-bottom: 20px;">ü§ñ AI Insights</h3>
                    <div class="health-score">
                        <div class="health-circle excellent" id="healthCircle" style="--score: 85">
                            <span id="healthScore">85</span>
                        </div>
                        <div class="stat-label">Budget Health Score</div>
                    </div>
                    <div id="aiInsights"></div>
                </div>

                <div class="glass-card">
                    <h3 style="margin-bottom: 20px;">üìà Top Categories</h3>
                    <div id="topCategories"></div>
                </div>
            </div>

            <!-- Add Expense Tab -->
            <div class="tab-content" id="add-expense">
                <div class="glass-card quick-add">
                    <h3 style="margin-bottom: 20px;">üí¨ Quick Add</h3>
                    <input type="text" class="form-input natural-input" id="naturalInput" 
                           placeholder="Try: 'lunch at chipotle $18 gary' or 'groceries $45 split'">
                    <button class="btn" onclick="parseNaturalInput()">Parse & Add</button>
                </div>

                <div class="glass-card">
                    <h3 style="margin-bottom: 20px;">üìù Manual Entry</h3>
                    <form id="expenseForm">
                        <div class="quick-add-grid">
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-input" id="amount" placeholder="0.00" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <div style="position: relative;">
                                    <input type="text" class="form-input" id="category" list="categoryDatalist" placeholder="Select or type new category" required autocomplete="off">
                                    <datalist id="categoryDatalist"></datalist>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Who Paid</label>
                                <select class="form-select" id="whoPaid" required>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="isShared" checked style="margin-right: 8px;">
                                    Shared expense
                                </label>
                            </div>
                            <div class="form-group" id="splitTypeGroup">
                                <label class="form-label">Split Type</label>
                                <select class="form-select" id="splitType" required>
                                    <option value="50/50">50/50</option>
                                    <option value="custom">Custom %</option>
                                    <option value="single">One Person</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group" id="customSplitGroup" style="display: none;">
                            <label class="form-label">Your Percentage</label>
                            <input type="number" class="form-input" id="customSplit" min="0" max="100" value="50">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input" id="expenseDate" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <input type="text" class="form-input" id="notes" placeholder="Optional notes">
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="isRecurring">
                                <span>Recurring expense</span>
                            </label>
                        </div>

                        <button type="submit" class="btn">üíæ Add Expense</button>
                    </form>
                </div>
            </div>

            <!-- Scan Receipt Tab -->
            <div class="tab-content" id="scan-receipt">
                <div class="glass-card" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px;">üì∑ Scan Receipt</h3>
                    
                    <!-- Upload Area -->
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('receiptFile').click()">
                        <div style="font-size: 48px; margin-bottom: 12px;">üì∑</div>
                        <div style="font-size: 16px; margin-bottom: 8px;">Click to select or drag & drop your receipt</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">Supports JPG, PNG, WebP ‚Ä¢ Max 10MB</div>
                    </div>
                    
                    <input type="file" id="receiptFile" accept="image/*" style="display: none;" onchange="handleReceiptFile(event)">
                    
                    <!-- Image Preview -->
                    <div id="receiptPreview" style="display: none;">
                        <img id="previewImage" style="width: 100%; max-height: 400px; object-fit: contain; border-radius: 12px; margin-bottom: 16px;" alt="Receipt preview">
                        <div style="display: flex; gap: 12px;">
                            <button class="btn" onclick="scanReceipt()">üîç Scan Receipt</button>
                            <button class="btn btn-secondary" onclick="clearReceipt()">‚ùå Remove</button>
                        </div>
                    </div>
                    
                    <!-- Loading -->
                    <div id="scanLoading" style="display: none; text-align: center; padding: 40px 0;">
                        <div class="loading" style="margin: 0 auto 16px;"></div>
                        <div>ü©∫ Dr.Molt is analyzing your receipt...</div>
                        <div style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">This may take a few seconds</div>
                    </div>
                </div>
                    
                <!-- Results -->
                <div class="scan-results" id="scanResults">
                    <div class="glass-card">
                        <h3 style="margin-bottom: 20px;">üìã Review & Edit</h3>
                        
                        <div id="scanResultsList"></div>

                        <div class="scan-summary" id="scanSummary" style="margin-top: 20px;">
                            <div class="summary-total" id="summaryTotal">$0.00</div>
                            <div class="summary-count" id="summaryCount">0 items selected</div>
                            <button class="btn" id="addSelectedBtn" onclick="addSelectedExpenses()">‚ûï Add Selected Items</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div class="tab-content" id="transactions">
                <div class="filters">
                    <input type="text" class="form-input filter-input" id="searchFilter" placeholder="üîç Search transactions...">
                    <select class="form-select" id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                    <select class="form-select" id="personFilter">
                        <option value="">All People</option>
                    </select>
                    <select class="form-select" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="shared">Shared</option>
                        <option value="individual">Individual</option>
                    </select>
                    <select class="form-select" id="monthFilter">
                        <option value="">All Months</option>
                    </select>
                </div>

                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button class="btn btn-secondary" onclick="exportTransactions('csv')" style="font-size: 14px;">üì• Export CSV</button>
                    <button class="btn btn-secondary" onclick="exportTransactions('excel')" style="font-size: 14px;">üìä Export Excel</button>
                </div>

                <div class="glass-card">
                    <div id="expensesList"></div>
                </div>
            </div>

            <!-- Budget Tab -->
            <div class="tab-content" id="budget">
                <div class="month-nav">
                    <button onclick="changeMonth(-1)">‚Äπ</button>
                    <div class="current-month" id="budgetMonth">February 2026</div>
                    <button onclick="changeMonth(1)">‚Ä∫</button>
                </div>

                <div class="glass-card" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px;">üë• Group Budget</h3>
                    <div class="form-group">
                        <label class="form-label">Monthly Shared Budget</label>
                        <input type="number" class="form-input" id="sharedBudget" placeholder="Enter shared budget" step="0.01">
                        <button class="btn" onclick="saveBudgets()" style="margin-top: 12px;">Save</button>
                    </div>
                </div>

                <div id="memberBudgetCards"></div>

                <div class="glass-card">
                    <h3 style="margin-bottom: 20px;">üìä Category Budgets</h3>
                    <div id="budgetCategories"></div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="tab-content" id="analytics">
                <div class="month-nav">
                    <button onclick="changeMonth(-1)">‚Äπ</button>
                    <div class="current-month" id="analyticsMonth">February 2026</div>
                    <button onclick="changeMonth(1)">‚Ä∫</button>
                </div>

                <div id="analyticsViewButtons" style="display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; justify-content: center;">
                    <button class="tab-btn active" data-view="combined" onclick="setAnalyticsView('combined', this)">üìä Combined</button>
                    <button class="tab-btn" data-view="shared" onclick="setAnalyticsView('shared', this)">üë• Shared Only</button>
                </div>

                <div class="chart-grid">
                    <div class="glass-card">
                        <h3 style="margin-bottom: 20px;">ü•ß Spending by Category</h3>
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    <div class="glass-card">
                        <h3 style="margin-bottom: 20px;">üë• Member Split</h3>
                        <div class="chart-container">
                            <canvas id="partnerChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="chart-grid">
                    <div class="glass-card">
                        <h3 style="margin-bottom: 20px;">üìà Monthly Comparison</h3>
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                    <div class="glass-card">
                        <h3 style="margin-bottom: 20px;">üìÖ Daily Spending</h3>
                        <div class="chart-container">
                            <canvas id="dailyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settlement Tab -->
            <div class="tab-content" id="settlement">
                <div class="glass-card settlement-card">
                    <h3 style="margin-bottom: 20px;">ü§ù Settlement Summary</h3>
                    <div class="settlement-amount" id="settlementAmount">$0.00</div>
                    <div class="stat-label" id="settlementLabel">No settlement needed</div>
                    <button class="btn" onclick="settleUp()" style="margin-top: 20px;" id="settleButton">‚úÖ Mark as Settled</button>
                </div>

                <div class="glass-card">
                    <h3 style="margin-bottom: 20px;">üìä Payment Breakdown</h3>
                    <div id="paymentBreakdown"></div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settings">
                <div class="glass-card" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px;">üîê Account</h3>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px;">
                        <span style="color: var(--text-secondary);">Logged in as: <strong id="currentUserEmail"></strong></span>
                    </div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="logout()">üö™ Logout</button>
                        <button class="btn" onclick="openSpaceManager()">üè† Manage Spaces</button>
                    </div>
                </div>

                <!-- Shared Space Info (API mode only) -->
                <div class="glass-card" id="householdInfoCard" style="margin-bottom: 24px; display: none;">
                    <h3 style="margin-bottom: 20px;">üè† Space Info</h3>
                    <div style="margin-bottom: 12px;">
                        <span style="color: var(--text-secondary);">Space: </span>
                        <strong id="settingsHouseholdName" style="color: var(--text-primary);"></strong>
                    </div>

                    <!-- Members list -->
                    <div style="margin-bottom: 16px;">
                        <span style="color: var(--text-secondary); display: block; margin-bottom: 8px;">Members:</span>
                        <div id="settingsMembersList"></div>
                    </div>

                    <!-- Invite Section -->
                    <div style="background: rgba(99,102,241,0.08); border: 1px solid rgba(99,102,241,0.2); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 10px;">üì® Invite someone to this space:</p>
                        <div style="display: flex; align-items: center; gap: 8px; justify-content: center; margin-bottom: 12px;">
                            <span id="settingsInviteCode" style="font-size: 24px; font-weight: 700; letter-spacing: 4px; color: #818cf8; background: rgba(99,102,241,0.15); padding: 6px 16px; border-radius: 8px; user-select: all;"></span>
                        </div>
                        <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-small" onclick="copyInviteCode()" id="copyCodeBtn" style="font-size: 13px; padding: 8px 16px;">üìã Copy Code</button>
                            <button class="btn btn-small btn-secondary" onclick="shareInvite()" id="shareInviteBtn" style="font-size: 13px; padding: 8px 16px;">üîó Share Link</button>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="openSpaceManager()" style="font-size: 13px;">üîÑ Switch Space</button>
                        <button class="btn btn-secondary" onclick="regenerateInviteCode()" id="regenCodeBtn" style="font-size: 13px;">üîë New Code</button>
                    </div>
                </div>

                <div class="glass-card" style="margin-bottom: 24px;" id="memberNamesCard">
                    <h3 style="margin-bottom: 20px;">üë• Member Names</h3>
                    <div id="memberNameInputs"></div>
                    <button class="btn" onclick="savePartnerNames()">üíæ Save Names</button>
                </div>

                <div class="glass-card" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px;">üìÇ Data Management</h3>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="exportData()">üì§ Export Data</button>
                        <button class="btn btn-secondary" onclick="importData()">üì• Import Data</button>
                        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
                </div>

                <div class="glass-card">
                    <h3 style="margin-bottom: 20px;">üè∑Ô∏è Custom Categories</h3>
                    <div class="form-group">
                        <input type="text" class="form-input" id="newCategory" placeholder="Enter new category name">
                        <button class="btn" onclick="addCustomCategory()" style="margin-top: 12px;">‚ûï Add Category</button>
                    </div>
                    <div id="customCategoriesList" style="margin-top: 20px;"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Authentication State
        let currentUser = null;
        let isFirstRegister = false;

        // App State
        let appState = {
            currentMonth: new Date(),
            expenses: [],
            budgets: {},
            partners: {
                partner1: 'Partner 1',
                partner2: 'Partner 2'
            },
            categories: [
                'Food/Dining', 'Groceries', 'Rent/Housing', 'Utilities', 
                'Transport', 'Entertainment', 'Subscriptions', 'Health', 
                'Shopping', 'Travel', 'Gifts', 'Insurance', 'Education',
                'Personal Care', 'Pets', 'Home Maintenance', 'Alcohol/Bars',
                'Coffee/Cafe', 'Fitness/Gym', 'Clothing', 'Electronics',
                'Charity/Donations', 'Parking', 'Phone/Internet', 'Other'
            ]
        };

        // Initialize App
        // Check for invite link: ?invite=XXXXXX
        let _pendingInviteCode = null;
        (function() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('invite') || params.get('code');
            if (code && /^[A-Fa-f0-9]{6}$/.test(code.trim())) {
                _pendingInviteCode = code.trim().toUpperCase();
                // Clean URL without reload
                window.history.replaceState({}, '', window.location.pathname);
            }
        })();

        document.addEventListener('DOMContentLoaded', function() {
            checkSession();
        });

        // API Configuration
        const API_BASE = 'https://api.gary-yong.com/budget/api';

        async function apiFetch(path, options = {}) {
            const token = localStorage.getItem('finSyncToken');
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            if (token) headers['Authorization'] = 'Bearer ' + token;
            const res = await fetch(API_BASE + path, { ...options, headers });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Request failed');
            return data;
        }

        // Authentication Functions
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function checkSession() {
            const token = localStorage.getItem('finSyncToken');
            const session = localStorage.getItem('finSyncSession');
            if (token && session) {
                currentUser = session;
                showApp();
            } else {
                // No valid session ‚Äî must authenticate
                // Clean up any stale data
                localStorage.removeItem('finSyncSession');
                localStorage.removeItem('finSyncToken');
                localStorage.removeItem('finSyncHouseholdId');
                showAuth();
            }
        }

        let authListenersReady = false;

        function showAuth() {
            document.getElementById('authOverlay').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            if (!authListenersReady) {
                setupAuthListeners();
                setupResetListener();
                authListenersReady = true;
            }
        }

        // Current household state
        let currentHouseholdId = null;
        let currentHouseholdData = null;
        let useApi = false; // true when user has token + household

        async function showApp() {
            const token = localStorage.getItem('finSyncToken');
            const savedHousehold = localStorage.getItem('finSyncHouseholdId');

            if (!token) {
                // No API token ‚Äî must register/login properly first
                // Clear stale session and send to auth
                localStorage.removeItem('finSyncSession');
                localStorage.removeItem('finSyncHouseholdId');
                currentUser = null;
                showAuth();
                showToast('Please register or log in to continue', 'info');
                return;
            }

            if (token && savedHousehold) {
                // Verify the token is still valid
                try {
                    await apiFetch('/auth/me');
                    // If user arrived via invite link, redirect to join flow instead of main app
                    if (_pendingInviteCode) {
                        const data = await apiFetch('/households');
                        window._allHouseholds = data.households || [];
                        showHouseholdSetup(data.households || []);
                        return;
                    }
                    currentHouseholdId = savedHousehold;
                    useApi = true;
                    showMainApp();
                } catch (err) {
                    // Token expired or invalid ‚Äî re-authenticate
                    localStorage.removeItem('finSyncToken');
                    localStorage.removeItem('finSyncSession');
                    localStorage.removeItem('finSyncHouseholdId');
                    currentUser = null;
                    showAuth();
                    showToast('Session expired. Please log in again.', 'info');
                }
            } else {
                // Has token but no household ‚Äî check if they belong to one
                checkHouseholds();
            }
        }

        async function checkHouseholds() {
            try {
                const data = await apiFetch('/households');
                if (data.households && data.households.length > 0) {
                    if (data.households.length === 1) {
                        // Single household ‚Äî auto-select
                        const h = data.households[0];
                        currentHouseholdId = h.id;
                        currentHouseholdData = h;
                        localStorage.setItem('finSyncHouseholdId', h.id);
                        useApi = true;
                        showMainApp();
                    } else {
                        // Multiple households ‚Äî show picker
                        window._allHouseholds = data.households;
                        showHouseholdSetup(data.households);
                    }
                } else {
                    showHouseholdSetup();
                }
            } catch (err) {
                console.error('Check households failed:', err);
                // Fallback to localStorage mode
                useApi = false;
                showMainApp();
            }
        }

        function showHouseholdSetup(households) {
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('householdOverlay').style.display = 'flex';

            const userName = localStorage.getItem('finSyncUserName') || '';
            document.getElementById('householdWelcome').textContent = userName ? `Welcome, ${userName}! How would you like to budget?` : 'Welcome! How would you like to budget?';
            if (userName) document.getElementById('householdPartnerName').value = userName;
            if (userName) document.getElementById('joinPartnerName').value = userName;

            // If user already has households, show them as selectable list
            if (households && households.length > 0) {
                const listDiv = document.getElementById('householdList');
                const itemsDiv = document.getElementById('householdListItems');
                listDiv.style.display = 'block';
                itemsDiv.innerHTML = households.map(h => {
                    const memberNames = (h.members || []).map(m => m.partner_name || m.name).join(', ');
                    return `<button type="button" class="auth-btn" style="width: 100%; margin-bottom: 8px; text-align: left; padding: 14px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);" onclick="selectHousehold(${h.id})">
                        <strong>${h.name}</strong>
                        <span style="display: block; font-size: 12px; opacity: 0.7; margin-top: 2px;">${memberNames || 'Just you'}</span>
                    </button>`;
                }).join('');
            } else {
                document.getElementById('householdList').style.display = 'none';
            }

            showHouseholdOptions();
            setupHouseholdListeners();

            // If user arrived via invite link, auto-open join form
            if (_pendingInviteCode) {
                document.getElementById('householdOptions').style.display = 'none';
                document.getElementById('joinHouseholdForm').style.display = 'flex';
                document.getElementById('createHouseholdForm').style.display = 'none';
                document.getElementById('inviteCodeDisplay').style.display = 'none';
                document.getElementById('joinInviteCode').value = _pendingInviteCode;
                // Auto-focus the display name field since code is pre-filled
                setTimeout(() => document.getElementById('joinPartnerName').focus(), 100);
                _pendingInviteCode = null; // consume it
            }
        }

        function showHouseholdOptions() {
            document.getElementById('householdOptions').style.display = 'flex';
            document.getElementById('createHouseholdForm').style.display = 'none';
            document.getElementById('joinHouseholdForm').style.display = 'none';
            document.getElementById('inviteCodeDisplay').style.display = 'none';
        }

        function selectHousehold(householdId) {
            currentHouseholdId = householdId;
            localStorage.setItem('finSyncHouseholdId', householdId);
            useApi = true;
            enterCurrentHousehold();
        }

        let _creatingSpace = false;
        async function createPersonalBudget() {
            if (_creatingSpace) return;
            _creatingSpace = true;
            const btn = document.getElementById('optionPersonal');
            if (btn) { btn.disabled = true; btn.style.opacity = '0.5'; }
            const userName = localStorage.getItem('finSyncUserName') || 'My';
            const spaceName = userName + "'s Budget";
            try {
                const data = await apiFetch('/households', {
                    method: 'POST',
                    body: JSON.stringify({ name: spaceName, partnerName: userName })
                });
                currentHouseholdId = data.household.id;
                localStorage.setItem('finSyncHouseholdId', data.household.id);
                useApi = true;
                showToast('Personal budget created! üéâ', 'success');
                enterCurrentHousehold();
            } catch (err) {
                showToast(err.message || 'Failed to create personal budget', 'error');
            } finally {
                _creatingSpace = false;
                if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
            }
        }

        function copyNewSpaceCode() {
            const code = document.getElementById('inviteCodeText').textContent;
            if (!code) return;
            navigator.clipboard.writeText(code).then(() => {
                showToast('Invite code copied!', 'success');
            }).catch(() => {
                const ta = document.createElement('textarea');
                ta.value = code;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast('Invite code copied!', 'success');
            });
        }

        function shareNewSpaceInvite() {
            const code = document.getElementById('inviteCodeText').textContent;
            const link = getInviteLink(code);
            const shareText = "Join my FinSync budget space!\n\n" + link;

            if (navigator.share) {
                navigator.share({ title: 'Join my FinSync space', text: shareText, url: link }).catch(() => {});
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    showToast('Invite link copied!', 'success');
                }).catch(() => { copyNewSpaceCode(); });
            }
        }

        let householdListenersReady = false;
        function setupHouseholdListeners() {
            if (householdListenersReady) return;
            householdListenersReady = true;

            const createForm = document.getElementById('createHouseholdForm');
            const joinForm = document.getElementById('joinHouseholdForm');

            // Personal Budget option
            document.getElementById('optionPersonal').addEventListener('click', () => {
                createPersonalBudget();
            });

            // Create Shared Space option
            document.getElementById('optionCreate').addEventListener('click', () => {
                document.getElementById('householdOptions').style.display = 'none';
                createForm.style.display = 'flex';
                joinForm.style.display = 'none';
                document.getElementById('inviteCodeDisplay').style.display = 'none';
            });

            // Join Space option
            document.getElementById('optionJoin').addEventListener('click', () => {
                document.getElementById('householdOptions').style.display = 'none';
                joinForm.style.display = 'flex';
                createForm.style.display = 'none';
                document.getElementById('inviteCodeDisplay').style.display = 'none';
            });

            let _creatingShared = false;
            createForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (_creatingShared) return;
                const name = document.getElementById('householdName').value.trim();
                const partnerName = document.getElementById('householdPartnerName').value.trim();
                if (!name) { showToast('Please enter a space name', 'error'); return; }
                if (!partnerName) { showToast('Please enter your display name', 'error'); return; }

                _creatingShared = true;
                const submitBtn = createForm.querySelector('button[type="submit"]');
                if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Creating...'; }
                try {
                    const data = await apiFetch('/households', {
                        method: 'POST',
                        body: JSON.stringify({ name, partnerName })
                    });
                    currentHouseholdId = data.household.id;
                    localStorage.setItem('finSyncHouseholdId', data.household.id);
                    useApi = true;

                    // Show invite code
                    document.getElementById('inviteCodeText').textContent = data.household.invite_code;
                    createForm.style.display = 'none';
                    document.getElementById('householdOptions').style.display = 'none';
                    document.getElementById('inviteCodeDisplay').style.display = 'block';

                    showToast('Space created! Share the code with your group.', 'success');
                } catch (err) {
                    showToast(err.message || 'Failed to create space', 'error');
                } finally {
                    _creatingShared = false;
                    if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'üè† Create Space'; }
                }
            });

            let _joiningSpace = false;
            joinForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (_joiningSpace) return;
                const joinError = document.getElementById('joinError');
                joinError.style.display = 'none';
                const inviteCode = document.getElementById('joinInviteCode').value.trim().toUpperCase();
                const partnerName = document.getElementById('joinPartnerName').value.trim();

                // Client-side validation
                if (!inviteCode) { joinError.textContent = 'Please enter an invite code'; joinError.style.display = 'block'; return; }
                if (inviteCode.length !== 6) { joinError.textContent = 'Invite codes are 6 characters long'; joinError.style.display = 'block'; return; }
                if (!/^[A-F0-9]{6}$/.test(inviteCode)) { joinError.textContent = 'Invalid code format ‚Äî should be 6 hex characters (0-9, A-F)'; joinError.style.display = 'block'; return; }
                if (!partnerName) { joinError.textContent = 'Enter a display name so others know who you are'; joinError.style.display = 'block'; return; }

                _joiningSpace = true;
                const submitBtn = document.getElementById('joinSubmitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Joining...';
                try {
                    const data = await apiFetch('/households/join', {
                        method: 'POST',
                        body: JSON.stringify({ inviteCode, partnerName })
                    });
                    currentHouseholdId = data.household.id;
                    localStorage.setItem('finSyncHouseholdId', data.household.id);
                    useApi = true;
                    showToast('Joined "' + (data.household.name || 'space') + '"! üéâ', 'success');
                    enterCurrentHousehold();
                } catch (err) {
                    const msg = err.message || 'Failed to join space';
                    if (msg.includes('Invalid invite code')) {
                        joinError.textContent = 'Invalid invite code ‚Äî double-check with the space owner';
                    } else if (msg.includes('Already a member')) {
                        joinError.textContent = "You're already a member of this space!";
                    } else {
                        joinError.textContent = msg;
                    }
                    joinError.style.display = 'block';
                } finally {
                    _joiningSpace = false;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üîó Join Space';
                }
            });
        }

        async function openSpaceManager() {
            // Show space setup with all existing spaces
            try {
                const data = await apiFetch('/households');
                window._allHouseholds = data.households || [];
                showHouseholdSetup(data.households || []);
            } catch (err) {
                showHouseholdSetup();
            }
        }

        function enterCurrentHousehold() {
            document.getElementById('householdOverlay').style.display = 'none';
            showMainApp();
        }

        async function showMainApp() {
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('householdOverlay').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            document.getElementById('currentUserEmail').textContent = currentUser;

            if (useApi && currentHouseholdId) {
                await loadDataFromApi();
            } else {
                loadData();
            }
            initializeApp();
            renderSpaceSwitcher();
            adaptUIForSpaceType();
            updateDisplay();
        }

        function renderSpaceSwitcher() {
            const switcher = document.getElementById('spaceSwitcher');
            const allHouseholds = window._allHouseholds || [];
            
            if (!useApi || allHouseholds.length < 1) {
                switcher.style.display = 'none';
                return;
            }

            switcher.style.display = 'block';
            const currentName = window._householdName || 'My Space';
            document.getElementById('currentSpaceName').textContent = currentName;

            const dropdown = document.getElementById('spaceSwitcherDropdown');
            dropdown.innerHTML = allHouseholds.map(h => {
                const isActive = h.id == currentHouseholdId;
                const memberNames = (h.members || []).map(m => m.partner_name || m.name).join(', ');
                return `<button type="button" style="width: 100%; text-align: left; padding: 12px 16px; background: ${isActive ? 'rgba(99,102,241,0.15)' : 'transparent'}; border: none; color: var(--text-primary); cursor: pointer; font-family: inherit; border-bottom: 1px solid var(--glass-border); transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.background='${isActive ? 'rgba(99,102,241,0.15)' : 'transparent'}'" onclick="switchSpace(${h.id})">
                    <strong style="font-size: 14px;">${isActive ? '‚úì ' : ''}${h.name}</strong>
                    <span style="display: block; font-size: 11px; color: var(--text-secondary); margin-top: 2px;">${memberNames || 'Solo'}</span>
                </button>`;
            }).join('') + `<button type="button" style="width: 100%; text-align: center; padding: 10px; background: transparent; border: none; color: #818cf8; cursor: pointer; font-family: inherit; font-size: 13px;" onclick="openSpaceSetup()">+ New Space</button>` + `<div style="border-top: 1px solid var(--glass-border); padding: 8px 16px;">
                <button type="button" style="width: 100%; text-align: center; padding: 8px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #f87171; cursor: pointer; font-family: inherit; font-size: 12px; border-radius: 8px;" onclick="deleteCurrentSpace()">üóëÔ∏è Delete Current Space</button>
            </div>`;

            // Toggle dropdown on click
            const btn = document.getElementById('spaceSwitcherBtn');
            btn.onclick = (e) => {
                e.stopPropagation();
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            };
            document.addEventListener('click', () => { dropdown.style.display = 'none'; }, { once: false });
        }

        async function switchSpace(householdId) {
            if (householdId == currentHouseholdId) return;
            currentHouseholdId = householdId;
            localStorage.setItem('finSyncHouseholdId', householdId);
            useApi = true;
            document.getElementById('spaceSwitcherDropdown').style.display = 'none';
            
            await loadDataFromApi();
            renderSpaceSwitcher();
            adaptUIForSpaceType();
            updateDisplay();
            renderTransactions();
            showToast('Switched to ' + (window._householdName || 'space'), 'success');
        }

        async function deleteCurrentSpace() {
            document.getElementById('spaceSwitcherDropdown').style.display = 'none';
            const spaceName = window._householdName || 'this space';
            if (!confirm(`Delete "${spaceName}"?\n\nThis will permanently remove all expenses, budgets, and data in this space. This cannot be undone.`)) return;
            if (!confirm(`Are you sure? Type OK to confirm you want to delete "${spaceName}" and all its data.`)) return;
            try {
                await apiFetch('/households/' + currentHouseholdId, { method: 'DELETE' });
                showToast('Space deleted', 'success');
                // Remove from local list and switch to another space
                window._allHouseholds = (window._allHouseholds || []).filter(h => h.id != currentHouseholdId);
                if (window._allHouseholds.length > 0) {
                    await switchSpace(window._allHouseholds[0].id);
                } else {
                    localStorage.removeItem('finSyncHouseholdId');
                    currentHouseholdId = null;
                    openSpaceManager();
                }
            } catch (err) {
                showToast(err.message || 'Failed to delete space', 'error');
            }
        }

        function openSpaceSetup() {
            document.getElementById('spaceSwitcherDropdown').style.display = 'none';
            // Reset household overlay state
            householdListenersReady = false;
            showHouseholdSetup(window._allHouseholds || []);
        }

        function adaptUIForSpaceType() {
            const solo = window._isSoloSpace;
            const balanceCard = document.getElementById('partnerBalance')?.closest('.glass-card');
            const settlementTab = document.querySelector('[data-tab="settlement"]');
            const sharedToggle = document.getElementById('isShared')?.closest('.form-group');
            const splitTypeGroup = document.getElementById('splitTypeGroup');
            const whoPaidGroup = document.getElementById('whoPaid')?.closest('.form-group');

            if (solo) {
                // Hide balance card
                if (balanceCard) balanceCard.style.display = 'none';
                // Hide settlement tab
                if (settlementTab) settlementTab.style.display = 'none';
                // Hide shared toggle and split type for solo
                if (sharedToggle) sharedToggle.style.display = 'none';
                if (splitTypeGroup) splitTypeGroup.style.display = 'none';
                // Auto-set shared to false for solo
                const isSharedEl = document.getElementById('isShared');
                if (isSharedEl) isSharedEl.checked = false;
            } else {
                if (balanceCard) balanceCard.style.display = '';
                if (settlementTab) settlementTab.style.display = '';
                if (sharedToggle) sharedToggle.style.display = '';
                if (splitTypeGroup) splitTypeGroup.style.display = '';
            }
        }

        function setupAuthListeners() {
            const loginToggle = document.getElementById('loginToggle');
            const registerToggle = document.getElementById('registerToggle');
            const authForm = document.getElementById('authForm');
            const authSubmit = document.getElementById('authSubmit');
            const nameInput = document.getElementById('registerNameInput');

            loginToggle.addEventListener('click', () => {
                loginToggle.classList.add('active');
                registerToggle.classList.remove('active');
                nameInput.style.display = 'none';
                nameInput.required = false;
                authSubmit.textContent = 'Login';
                document.getElementById('forgotPasswordLink').style.display = 'block';
            });

            registerToggle.addEventListener('click', () => {
                registerToggle.classList.add('active');
                loginToggle.classList.remove('active');
                nameInput.style.display = 'block';
                nameInput.required = true;
                authSubmit.textContent = 'Register';
                document.getElementById('forgotPasswordLink').style.display = 'none';
            });

            authForm.addEventListener('submit', handleAuth);
        }

        async function handleAuth(e) {
            e.preventDefault();
            
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const isRegister = document.getElementById('registerToggle').classList.contains('active');

            if (isRegister) {
                const name = document.getElementById('registerNameInput').value.trim();
                if (!name) {
                    showToast('Please enter your name', 'error');
                    return;
                }
                await registerUser(email, password, name);
            } else {
                await loginUser(email, password);
            }
        }

        async function registerUser(email, password, name) {
            try {
                const data = await apiFetch('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ email, password, name })
                });

                localStorage.setItem('finSyncToken', data.token);
                localStorage.setItem('finSyncSession', email);
                localStorage.setItem('finSyncUserId', data.user.id);
                localStorage.setItem('finSyncUserName', data.user.name);
                
                // Also keep legacy localStorage for backward compat
                const users = JSON.parse(localStorage.getItem('finSyncUsers') || '[]');
                if (!users.some(u => u.email === email)) {
                    const passwordHash = await hashPassword(password);
                    users.push({ email, passwordHash, partner1Name: name, partner2Name: '', createdAt: new Date().toISOString() });
                    localStorage.setItem('finSyncUsers', JSON.stringify(users));
                }
                
                appState.partners = { partner1: name, partner2: '' };
                currentUser = email;
                isFirstRegister = true;
                saveData();
                
                // Go directly to household/space setup (not onboarding)
                showApp();
                showToast('Account created successfully!', 'success');
            } catch (error) {
                showToast(error.message || 'Registration failed', 'error');
            }
        }

        async function loginUser(email, password) {
            // Try API login first
            try {
                const data = await apiFetch('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                localStorage.setItem('finSyncToken', data.token);
                localStorage.setItem('finSyncSession', email);
                localStorage.setItem('finSyncUserId', data.user.id);
                localStorage.setItem('finSyncUserName', data.user.name);
                currentUser = email;
                showApp();
                showToast('Welcome back!', 'success');
                return;
            } catch (apiError) {
                console.log('API login failed, trying local:', apiError.message);
            }

            // Fallback to localStorage login
            try {
                const users = JSON.parse(localStorage.getItem('finSyncUsers') || '[]');
                const user = users.find(u => u.email === email);
                
                if (!user) {
                    showToast('User not found', 'error');
                    return;
                }

                const passwordHash = await hashPassword(password);
                if (user.passwordHash !== passwordHash) {
                    showToast('Invalid password', 'error');
                    return;
                }

                // Local login succeeded ‚Äî auto-migrate to API
                try {
                    const data = await apiFetch('/auth/register', {
                        method: 'POST',
                        body: JSON.stringify({ email, password, name: user.partner1Name || email.split('@')[0] })
                    });
                    localStorage.setItem('finSyncToken', data.token);
                    localStorage.setItem('finSyncUserId', data.user.id);
                    localStorage.setItem('finSyncUserName', data.user.name);
                } catch (migrationErr) {
                    console.log('API migration skipped:', migrationErr.message);
                }

                localStorage.setItem('finSyncSession', email);
                currentUser = email;
                showApp();
                showToast('Welcome back!', 'success');
            } catch (error) {
                showToast('Login failed', 'error');
            }
        }

        let resetVerifiedEmail = null;

        function showResetPassword() {
            document.getElementById('authForm').style.display = 'none';
            document.querySelector('.auth-toggle').style.display = 'none';
            document.getElementById('resetForm').style.display = 'block';
            document.getElementById('resetNewPasswordFields').style.display = 'none';
            document.getElementById('resetSubmit').textContent = 'Verify Email';
            document.getElementById('resetEmail').value = '';
            document.getElementById('resetEmail').disabled = false;
            resetVerifiedEmail = null;
        }

        function cancelReset() {
            document.getElementById('resetForm').style.display = 'none';
            document.getElementById('authForm').style.display = 'flex';
            document.querySelector('.auth-toggle').style.display = 'flex';
            resetVerifiedEmail = null;
        }

        function setupResetListener() {
            document.getElementById('resetForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!resetVerifiedEmail) {
                    // Step 1: Verify email exists (check API first, then local)
                    const email = document.getElementById('resetEmail').value;
                    let found = false;

                    // Check API
                    try {
                        await apiFetch('/auth/login', {
                            method: 'POST',
                            body: JSON.stringify({ email, password: '___verify_only___' })
                        });
                    } catch (err) {
                        // "Invalid password" means user exists; "User not found" means they don't
                        if (err.message === 'Invalid password') {
                            found = true;
                        } else {
                            // Check localStorage as fallback
                            const users = JSON.parse(localStorage.getItem('finSyncUsers') || '[]');
                            if (users.find(u => u.email === email)) found = true;
                        }
                    }

                    if (!found) {
                        showToast('No account found with that email', 'error');
                        return;
                    }
                    
                    resetVerifiedEmail = email;
                    document.getElementById('resetEmail').disabled = true;
                    document.getElementById('resetNewPasswordFields').style.display = 'block';
                    document.getElementById('resetSubmit').textContent = 'Reset Password';
                    showToast('Email verified! Set your new password.', 'success');
                } else {
                    // Step 2: Set new password
                    const newPassword = document.getElementById('resetNewPassword').value;
                    const confirmPassword = document.getElementById('resetConfirmPassword').value;
                    
                    if (newPassword.length < 1) {
                        showToast('Please enter a new password', 'error');
                        return;
                    }
                    
                    if (newPassword !== confirmPassword) {
                        showToast('Passwords do not match', 'error');
                        return;
                    }
                    
                    // Reset on API
                    try {
                        await apiFetch('/auth/reset-password', {
                            method: 'POST',
                            body: JSON.stringify({ email: resetVerifiedEmail, newPassword })
                        });
                    } catch (err) {
                        console.log('API reset failed, trying local:', err.message);
                    }

                    // Also reset in localStorage
                    const users = JSON.parse(localStorage.getItem('finSyncUsers') || '[]');
                    const userIdx = users.findIndex(u => u.email === resetVerifiedEmail);
                    if (userIdx !== -1) {
                        users[userIdx].passwordHash = await hashPassword(newPassword);
                        localStorage.setItem('finSyncUsers', JSON.stringify(users));
                    }
                    
                    const resetEmail = resetVerifiedEmail;
                    resetVerifiedEmail = null;
                    cancelReset();
                    
                    document.getElementById('authEmail').value = resetEmail || '';
                    document.getElementById('authPassword').value = '';
                    document.getElementById('authPassword').focus();
                    
                    showToast('Password reset successful! Please log in.', 'success');
                }
            });
        }

        function logout() {
            localStorage.removeItem('finSyncSession');
            localStorage.removeItem('finSyncToken');
            localStorage.removeItem('finSyncUserId');
            localStorage.removeItem('finSyncUserName');
            localStorage.removeItem('finSyncHouseholdId');
            currentUser = null;
            currentHouseholdId = null;
            currentHouseholdData = null;
            useApi = false;
            location.reload();
        }

        // Onboarding Functions
        let currentOnboardingStep = 1;

        function showOnboarding() {
            const isOnboarded = localStorage.getItem(`finSyncOnboarded_${currentUser}`);
            if (!isOnboarded) {
                document.getElementById('onboardingOverlay').style.display = 'flex';
            }
        }

        function nextOnboardingStep() {
            const currentStepEl = document.querySelector(`.onboarding-step[data-step="${currentOnboardingStep}"]`);
            const nextStep = currentOnboardingStep + 1;

            // Handle step-specific actions
            if (currentOnboardingStep === 2) {
                const budget = parseFloat(document.getElementById('onboardingBudget').value);
                if (budget && budget > 0) {
                    appState.budgets.total = budget;
                    saveData();
                }
            } else if (currentOnboardingStep === 3) {
                const expense = document.getElementById('onboardingExpense').value;
                if (expense) {
                    // Use the existing natural language parser
                    document.getElementById('naturalInput').value = expense;
                    parseNaturalInput();
                    if (document.getElementById('amount').value) {
                        // Auto-submit the parsed expense
                        const form = document.getElementById('expenseForm');
                        if (form.checkValidity()) {
                            handleExpenseSubmit({ preventDefault: () => {} });
                        }
                    }
                }
            }

            if (nextStep <= 4) {
                currentStepEl.classList.remove('active');
                document.querySelector(`.onboarding-step[data-step="${nextStep}"]`).classList.add('active');
                document.querySelector(`.progress-dot[data-step="${currentOnboardingStep}"]`).classList.remove('active');
                document.querySelector(`.progress-dot[data-step="${nextStep}"]`).classList.add('active');
                currentOnboardingStep = nextStep;
            }
        }

        function prevOnboardingStep() {
            const currentStepEl = document.querySelector(`.onboarding-step[data-step="${currentOnboardingStep}"]`);
            const prevStep = currentOnboardingStep - 1;

            if (prevStep >= 1) {
                currentStepEl.classList.remove('active');
                document.querySelector(`.onboarding-step[data-step="${prevStep}"]`).classList.add('active');
                document.querySelector(`.progress-dot[data-step="${currentOnboardingStep}"]`).classList.remove('active');
                document.querySelector(`.progress-dot[data-step="${prevStep}"]`).classList.add('active');
                currentOnboardingStep = prevStep;
            }
        }

        function skipOnboarding() {
            completeOnboarding();
        }

        function completeOnboarding() {
            localStorage.setItem(`finSyncOnboarded_${currentUser}`, 'true');
            document.getElementById('onboardingOverlay').style.display = 'none';
            updateDisplay();
            showToast('Welcome to FinSync! üéâ', 'success');
        }

        // Toast Notifications
        function showToast(message, type = 'success') {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Data Management
        function saveData() {
            if (!currentUser) return;
            // Always save to localStorage as cache
            localStorage.setItem(`finSyncData_${currentUser}`, JSON.stringify({
                expenses: appState.expenses,
                budgets: appState.budgets,
                partners: appState.partners,
                categories: appState.categories
            }));
        }

        async function loadDataFromApi() {
            try {
                const hData = await apiFetch('/households/' + currentHouseholdId);
                const household = hData.household;

                // Map members dynamically ‚Äî me first, then others by join order
                const myId = parseInt(localStorage.getItem('finSyncUserId'));
                const members = household.members || [];
                const me = members.find(m => m.user_id === myId);
                const others = members.filter(m => m.user_id !== myId);

                // Build dynamic partners map: partner1 = me, partner2..N = others
                appState.partners = {};
                window._memberMap = {};
                window._memberMapReverse = {};

                if (me) {
                    appState.partners['partner1'] = me.partner_name || 'Me';
                    window._memberMap['partner1'] = me.user_id;
                    window._memberMapReverse[me.user_id] = 'partner1';
                }

                others.forEach((m, i) => {
                    const key = 'partner' + (i + 2);
                    appState.partners[key] = m.partner_name || ('Member ' + (i + 2));
                    window._memberMap[key] = m.user_id;
                    window._memberMapReverse[m.user_id] = key;
                });

                // Track if solo
                window._isSoloSpace = members.length <= 1;

                // Load categories from household
                if (household.categories && household.categories.length > 0) {
                    appState.categories = household.categories;
                }

                // Load expenses
                const expData = await apiFetch('/households/' + currentHouseholdId + '/expenses');
                appState.expenses = (expData.expenses || []).map(e => ({
                    id: e.id,
                    amount: e.amount,
                    category: e.category,
                    whoPaid: window._memberMapReverse[e.paid_by] || 'partner1',
                    splitType: e.split_type || '50/50',
                    customSplit: e.custom_split,
                    date: e.date,
                    notes: e.notes || '',
                    isRecurring: !!e.is_recurring,
                    isShared: e.is_shared !== 0,
                    timestamp: e.created_at
                }));

                // Store invite code for settings display
                window._householdInviteCode = household.invite_code;
                window._householdName = household.name;
                window._householdMembers = members;

                // Also fetch all households for the space switcher
                try {
                    const allData = await apiFetch('/households');
                    window._allHouseholds = allData.households || [];
                } catch (e) { window._allHouseholds = []; }

                // Cache locally
                saveData();
            } catch (err) {
                console.error('API load failed, using cache:', err);
                loadData();
            }
        }

        function loadData() {
            if (!currentUser) return;
            
            // For localStorage users, determine solo vs shared from partner data
            const partnerKeys = Object.keys(appState.partners);
            const hasMultipleMembers = partnerKeys.length >= 2 && partnerKeys.some(k => k !== 'partner1' && appState.partners[k]);
            window._isSoloSpace = !hasMultipleMembers;

            const saved = localStorage.getItem(`finSyncData_${currentUser}`);
            if (saved) {
                const data = JSON.parse(saved);
                appState.expenses = data.expenses || [];
                appState.budgets = data.budgets || {};
                appState.partners = data.partners || appState.partners;
                appState.categories = data.categories || appState.categories;
                
                // Re-check solo after loading partners
                const pKeys = Object.keys(appState.partners);
                window._isSoloSpace = !(pKeys.length >= 2 && pKeys.some(k => k !== 'partner1' && appState.partners[k]));
                
                let needsSave = false;
                appState.expenses.forEach(expense => {
                    if (expense.isShared === undefined) {
                        expense.isShared = true;
                        needsSave = true;
                    }
                });
                if (needsSave) saveData();
            } else {
                const users = JSON.parse(localStorage.getItem('finSyncUsers') || '[]');
                const user = users.find(u => u.email === currentUser);
                if (user) {
                    appState.partners = {
                        partner1: user.partner1Name,
                        partner2: user.partner2Name
                    };
                }
            }
        }

        function initializeApp() {
            // Set current date
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            
            // Initialize tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.tab-btn');
                    if (tabBtn && tabBtn.dataset.tab) switchTab(tabBtn.dataset.tab);
                });
            });

            // Initialize month navigation
            document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));

            // Initialize form
            document.getElementById('expenseForm').addEventListener('submit', handleExpenseSubmit);
            document.getElementById('splitType').addEventListener('change', handleSplitTypeChange);
            document.getElementById('isShared').addEventListener('change', handleSharedToggle);

            // Initialize filters
            document.getElementById('searchFilter').addEventListener('input', filterTransactions);
            document.getElementById('categoryFilter').addEventListener('change', filterTransactions);
            document.getElementById('personFilter').addEventListener('change', filterTransactions);
            document.getElementById('typeFilter').addEventListener('change', filterTransactions);
            document.getElementById('monthFilter').addEventListener('change', filterTransactions);

            // Render dynamic member name inputs
            renderMemberNameInputs();

            populateSelectors();
            renderRecurringExpenses();

            // Drag & drop for receipt upload
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.borderColor = 'var(--accent-start)'; });
                uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.style.borderColor = ''; });
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '';
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const dt = new DataTransfer();
                        dt.items.add(file);
                        document.getElementById('receiptFile').files = dt.files;
                        handleReceiptFile({ target: { files: dt.files } });
                    } else {
                        showToast('Please drop an image file', 'error');
                    }
                });
            }
        }

        // Tab Management
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            // Update content when switching tabs
            if (tabId === 'analytics') renderCharts();
            if (tabId === 'transactions') renderTransactions();
            if (tabId === 'budget') renderBudget();
            if (tabId === 'settlement') renderSettlement();
            if (tabId === 'settings') { renderCustomCategories(); renderHouseholdInfo(); }
        }

        // Month Navigation
        function changeMonth(direction) {
            appState.currentMonth = new Date(appState.currentMonth);
            appState.currentMonth.setMonth(appState.currentMonth.getMonth() + direction);
            updateDisplay();
        }

        function updateDisplay() {
            updateCurrentMonth();
            updateDashboard();
            generateAIInsights();
            populateSelectors();
        }

        function updateCurrentMonth() {
            const monthYear = appState.currentMonth.toLocaleDateString('en-US', { 
                month: 'long', 
                year: 'numeric' 
            });
            document.getElementById('currentMonth').textContent = monthYear;
        }

        // Expense Management
        async function ensureCategory(category) {
            if (!category) return;
            if (!appState.categories.includes(category)) {
                appState.categories.push(category);
                saveData();
                populateSelectors();
                // Sync to API if available
                if (useApi && currentHouseholdId) {
                    try {
                        await apiFetch('/households/' + currentHouseholdId + '/categories', {
                            method: 'POST',
                            body: JSON.stringify({ name: category })
                        });
                    } catch (err) { console.error('API add category failed:', err); }
                }
            }
        }

        let _submittingExpense = false;
        async function handleExpenseSubmit(e) {
            e.preventDefault();
            if (_submittingExpense) return;
            
            const amount = parseFloat(document.getElementById('amount').value);
            const category = document.getElementById('category').value.trim();
            const whoPaid = document.getElementById('whoPaid').value;
            const splitType = document.getElementById('splitType').value;
            const date = document.getElementById('expenseDate').value;
            const notes = document.getElementById('notes').value;
            const isRecurring = document.getElementById('isRecurring').checked;
            const customSplit = document.getElementById('customSplit').value;
            const isShared = document.getElementById('isShared').checked;

            if (!category) {
                showToast('Please select or enter a category', 'error');
                return;
            }

            // Auto-add new category
            await ensureCategory(category);

            _submittingExpense = true;
            const formSubmitBtn = document.querySelector('#expenseForm button[type="submit"]');
            const origBtnText = formSubmitBtn.textContent;
            formSubmitBtn.disabled = true;
            formSubmitBtn.textContent = '‚è≥ Saving...';

            try {

            if (editingExpenseId !== null) {
                // Update existing expense
                if (useApi && currentHouseholdId) {
                    try {
                        await apiFetch('/households/' + currentHouseholdId + '/expenses/' + editingExpenseId, {
                            method: 'PUT',
                            body: JSON.stringify({
                                amount, category, date, notes, isRecurring, isShared,
                                paidBy: window._memberMap?.[whoPaid] || whoPaid,
                                splitType, customSplit: splitType === 'custom' ? parseFloat(customSplit) : null
                            })
                        });
                    } catch (err) { console.error('API update failed:', err); }
                }
                const idx = appState.expenses.findIndex(e => e.id === editingExpenseId);
                if (idx !== -1) {
                    appState.expenses[idx] = {
                        ...appState.expenses[idx],
                        amount, category, whoPaid, splitType,
                        customSplit: splitType === 'custom' ? parseFloat(customSplit) : null,
                        date, notes, isRecurring, isShared
                    };
                    saveData();
                }
                editingExpenseId = null;
                const submitBtn = document.querySelector('#expenseForm button[type="submit"]');
                submitBtn.textContent = 'üíæ Add Expense';
                const cancelBtn = document.getElementById('cancelEditBtn');
                if (cancelBtn) cancelBtn.remove();
                
                document.getElementById('expenseForm').reset();
                document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('isShared').checked = true;
                updateDisplay();
                showToast('Expense updated! ‚úÖ', 'success');
            } else /* add new */ {
                // Add new expense
                const expense = {
                    id: Date.now(),
                    amount, category, whoPaid, splitType,
                    customSplit: splitType === 'custom' ? parseFloat(customSplit) : null,
                    date, notes, isRecurring, isShared,
                    timestamp: new Date()
                };

                if (useApi && currentHouseholdId) {
                    try {
                        const data = await apiFetch('/households/' + currentHouseholdId + '/expenses', {
                            method: 'POST',
                            body: JSON.stringify({
                                amount, category, date, notes, isRecurring, isShared,
                                paidBy: window._memberMap?.[whoPaid] || whoPaid,
                                splitType, customSplit: expense.customSplit
                            })
                        });
                        if (data.expense) expense.id = data.expense.id;
                    } catch (err) { console.error('API add failed:', err); }
                }

                addExpense(expense);
                document.getElementById('expenseForm').reset();
                document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('isShared').checked = true;
                updateDisplay();
                showToast(`${isShared ? 'Shared' : 'Individual'} expense added successfully! üí∞`, 'success');
            }

            } finally {
                _submittingExpense = false;
                formSubmitBtn.disabled = false;
                formSubmitBtn.textContent = origBtnText;
            }
        }

        function addExpense(expense) {
            appState.expenses.push(expense);
            saveData();
        }

        let _deletingExpense = null;
        async function deleteExpense(id) {
            if (_deletingExpense === id) return;
            if (confirm('Delete this expense?')) {
                _deletingExpense = id;
                // Gray out the row being deleted
                const row = document.querySelector(`[data-expense-id="${id}"]`);
                if (row) { row.style.opacity = '0.4'; row.style.pointerEvents = 'none'; }
                if (useApi && currentHouseholdId) {
                    try {
                        await apiFetch('/households/' + currentHouseholdId + '/expenses/' + id, { method: 'DELETE' });
                    } catch (err) { console.error('API delete failed:', err); }
                }
                appState.expenses = appState.expenses.filter(e => e.id !== id);
                saveData();
                _deletingExpense = null;
                updateDisplay();
                renderTransactions();
                showToast('Expense deleted', 'success');
            }
        }

        function handleSplitTypeChange() {
            const splitType = document.getElementById('splitType').value;
            const customGroup = document.getElementById('customSplitGroup');
            customGroup.style.display = splitType === 'custom' ? 'block' : 'none';
        }

        function handleSharedToggle() {
            const isShared = document.getElementById('isShared').checked;
            const splitTypeGroup = document.getElementById('splitTypeGroup');
            const customGroup = document.getElementById('customSplitGroup');
            
            if (isShared) {
                splitTypeGroup.style.display = 'block';
                document.getElementById('splitType').required = true;
            } else {
                splitTypeGroup.style.display = 'none';
                customGroup.style.display = 'none';
                document.getElementById('splitType').required = false;
            }
        }

        // Natural Language Processing
        function parseNaturalInput() {
            const input = document.getElementById('naturalInput').value.toLowerCase();
            if (!input.trim()) {
                showToast('Please enter an expense description', 'error');
                return;
            }

            // Extract amount - handle various formats
            const amountMatch = input.match(/\$?(\d+(?:\.\d{1,2})?)/);
            if (amountMatch) {
                let amount = parseFloat(amountMatch[1]);
                if (!isNaN(amount) && amount > 0) {
                    document.getElementById('amount').value = amount.toFixed(2);
                }
            } else {
                // If no amount found, show error
                showToast('Please include an amount in your description (e.g., "$25" or "25.50")', 'error');
                return;
            }

            // Check for personal expense keywords
            const personalKeywords = ['personal', 'mine', 'just me', 'individual', 'my own', 'for me', 'myself', 'private'];
            const isPersonal = personalKeywords.some(keyword => input.includes(keyword));
            
            document.getElementById('isShared').checked = !isPersonal;
            handleSharedToggle(); // Update form visibility

            // Enhanced category keywords
            const categoryMap = {
                'groceries': 'Groceries',
                'grocery': 'Groceries', 
                'supermarket': 'Groceries',
                'costco': 'Groceries',
                'walmart': 'Groceries',
                'food': 'Food/Dining',
                'lunch': 'Food/Dining',
                'dinner': 'Food/Dining',
                'breakfast': 'Food/Dining',
                'restaurant': 'Food/Dining',
                'chipotle': 'Food/Dining',
                'mcdonalds': 'Food/Dining',
                'starbucks': 'Coffee/Cafe',
                'coffee': 'Coffee/Cafe',
                'cafe': 'Coffee/Cafe',
                'tim hortons': 'Coffee/Cafe',
                'tims': 'Coffee/Cafe',
                'pizza': 'Food/Dining',
                'gas': 'Transport',
                'fuel': 'Transport',
                'uber': 'Transport',
                'lyft': 'Transport',
                'taxi': 'Transport',
                'bus': 'Transport',
                'train': 'Transport',
                'parking': 'Parking',
                'rent': 'Rent/Housing',
                'mortgage': 'Rent/Housing',
                'utilities': 'Utilities',
                'electricity': 'Utilities',
                'water': 'Utilities',
                'hydro': 'Utilities',
                'internet': 'Phone/Internet',
                'phone': 'Phone/Internet',
                'mobile': 'Phone/Internet',
                'rogers': 'Phone/Internet',
                'bell': 'Phone/Internet',
                'fido': 'Phone/Internet',
                'movie': 'Entertainment',
                'cinema': 'Entertainment',
                'concert': 'Entertainment',
                'game': 'Entertainment',
                'netflix': 'Subscriptions',
                'spotify': 'Subscriptions',
                'disney': 'Subscriptions',
                'amazon prime': 'Subscriptions',
                'gym': 'Fitness/Gym',
                'fitness': 'Fitness/Gym',
                'yoga': 'Fitness/Gym',
                'crossfit': 'Fitness/Gym',
                'doctor': 'Health',
                'pharmacy': 'Health',
                'medicine': 'Health',
                'dentist': 'Health',
                'hospital': 'Health',
                'clothes': 'Clothing',
                'clothing': 'Clothing',
                'jacket': 'Clothing',
                'shoes': 'Clothing',
                'shopping': 'Shopping',
                'amazon': 'Shopping',
                'gift': 'Gifts',
                'present': 'Gifts',
                'insurance': 'Insurance',
                'car insurance': 'Insurance',
                'home insurance': 'Insurance',
                'tuition': 'Education',
                'course': 'Education',
                'textbook': 'Education',
                'school': 'Education',
                'haircut': 'Personal Care',
                'salon': 'Personal Care',
                'spa': 'Personal Care',
                'skincare': 'Personal Care',
                'vet': 'Pets',
                'pet': 'Pets',
                'dog': 'Pets',
                'cat': 'Pets',
                'repair': 'Home Maintenance',
                'plumber': 'Home Maintenance',
                'electrician': 'Home Maintenance',
                'bar': 'Alcohol/Bars',
                'beer': 'Alcohol/Bars',
                'wine': 'Alcohol/Bars',
                'lcbo': 'Alcohol/Bars',
                'liquor': 'Alcohol/Bars',
                'laptop': 'Electronics',
                'computer': 'Electronics',
                'iphone': 'Electronics',
                'apple store': 'Electronics',
                'donation': 'Charity/Donations',
                'charity': 'Charity/Donations'
            };

            // Find best category match
            let foundCategory = null;
            for (const [keyword, category] of Object.entries(categoryMap)) {
                if (input.includes(keyword)) {
                    foundCategory = category;
                    break;
                }
            }
            
            if (foundCategory) {
                document.getElementById('category').value = foundCategory;
            } else {
                document.getElementById('category').value = 'Other';
            }

            // Extract who paid ‚Äî check all member names
            let foundPayer = 'partner1'; // default
            const partnerKeys = Object.keys(appState.partners);
            for (const key of partnerKeys) {
                const name = (appState.partners[key] || '').toLowerCase();
                if (name && input.includes(name)) {
                    foundPayer = key;
                    break;
                }
            }
            if (input.includes('me') || input.includes('i ')) {
                foundPayer = 'partner1'; // partner1 is always "me"
            }
            document.getElementById('whoPaid').value = foundPayer;

            // Extract split type
            if (input.includes('split') || input.includes('shared') || input.includes('together')) {
                document.getElementById('splitType').value = '50/50';
            } else {
                document.getElementById('splitType').value = '50/50'; // Default to split
            }

            // Set current date
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];

            // Extract notes from original input
            const allMemberNames = Object.values(appState.partners).map(n => n.toLowerCase()).filter(Boolean);
            const words = document.getElementById('naturalInput').value.split(' ');
            const notes = words.filter(word => 
                !word.match(/\$?\d+/) && 
                !allMemberNames.some(name => word.toLowerCase().includes(name)) &&
                !['split', 'shared', 'me', 'i'].includes(word.toLowerCase())
            ).join(' ');
            
            if (notes.trim()) {
                document.getElementById('notes').value = notes.trim();
            }

            // Auto-submit if we have required fields
            const amount = document.getElementById('amount').value;
            const category = document.getElementById('category').value;
            
            if (amount && category) {
                // Simulate form submission
                setTimeout(() => {
                    const form = document.getElementById('expenseForm');
                    if (form.checkValidity()) {
                        handleExpenseSubmit({ preventDefault: () => {} });
                        // handleExpenseSubmit shows its own toast
                        
                        // Clear the natural input
                        document.getElementById('naturalInput').value = '';
                    } else {
                        showToast('Please fill in any missing required fields', 'warning');
                    }
                }, 100);
            } else {
                showToast('Parsed! Please fill in any missing fields and submit', 'success');
            }
        }

        // Dashboard Updates
        function updateDashboard() {
            const monthExpenses = getCurrentMonthExpenses();
            const solo = window._isSoloSpace;
            
            // Separate shared and individual expenses
            const sharedExpenses = monthExpenses.filter(exp => exp.isShared !== false);
            const individualExpenses = monthExpenses.filter(exp => exp.isShared === false);
            
            const totalSharedSpent = sharedExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalSpent = monthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            
            const totalBudget = appState.budgets.total || 0;
            const budgetRemaining = totalBudget - totalSpent;

            // Build per-member breakdown
            let memberBreakdownHtml = '';
            if (!solo) {
                memberBreakdownHtml += `üë• Shared: $${totalSharedSpent.toFixed(2)}<br>`;
                Object.keys(appState.partners).forEach(key => {
                    const indiv = individualExpenses.filter(exp => exp.whoPaid === key).reduce((sum, exp) => sum + exp.amount, 0);
                    memberBreakdownHtml += `üë§ ${appState.partners[key]}: $${indiv.toFixed(2)}<br>`;
                });
            }

            document.getElementById('totalSpent').innerHTML = `
                <div><strong>$${totalSpent.toFixed(2)}</strong></div>
                ${memberBreakdownHtml ? `<div style="font-size: 0.8em; color: var(--text-secondary); margin-top: 4px;">${memberBreakdownHtml}</div>` : ''}
            `;
            document.getElementById('budgetRemaining').textContent = `$${budgetRemaining.toFixed(2)}`;
            
            if (!solo) {
                const balance = calculatePartnerBalance();
                document.getElementById('partnerBalance').textContent = balance.amount;
            }

            renderTopCategories();
        }

        function getCurrentMonthExpenses() {
            const currentMonth = appState.currentMonth.getMonth();
            const currentYear = appState.currentMonth.getFullYear();
            
            return appState.expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && 
                       expenseDate.getFullYear() === currentYear;
            });
        }

        function calculatePartnerBalance() {
            // Only consider shared expenses for balance calculation
            const sharedExpenses = getCurrentMonthExpenses().filter(exp => exp.isShared !== false);
            let partner1Total = 0;
            let partner2Total = 0;
            let partner1Paid = 0;
            let partner2Paid = 0;

            sharedExpenses.forEach(expense => {
                // Track who paid
                if (expense.whoPaid === 'partner1') {
                    partner1Paid += expense.amount;
                } else {
                    partner2Paid += expense.amount;
                }

                // Track who owes what based on split
                if (expense.splitType === '50/50') {
                    const half = expense.amount / 2;
                    partner1Total += half;
                    partner2Total += half;
                } else if (expense.splitType === 'custom' && expense.customSplit) {
                    partner1Total += (expense.amount * expense.customSplit / 100);
                    partner2Total += (expense.amount * (100 - expense.customSplit) / 100);
                } else if (expense.splitType === 'single') {
                    if (expense.whoPaid === 'partner1') {
                        partner1Total += expense.amount;
                    } else {
                        partner2Total += expense.amount;
                    }
                }
            });

            // How much partner1 overpaid (positive = partner2 owes partner1)
            const balance = partner1Paid - partner1Total;
            const owesWho = balance > 0 ? 
                `${appState.partners.partner2} owes ${appState.partners.partner1}` : 
                `${appState.partners.partner1} owes ${appState.partners.partner2}`;

            return {
                amount: `$${Math.abs(balance).toFixed(2)}`,
                label: Math.abs(balance) < 0.01 ? 'Balanced' : owesWho,
                rawBalance: balance
            };
        }

        function renderTopCategories() {
            const expenses = getCurrentMonthExpenses();
            const categoryTotals = {};

            expenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
            });

            const sorted = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const container = document.getElementById('topCategories');
            if (sorted.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><h3>No expenses yet</h3><p>Add some expenses to see your top categories</p></div>';
                return;
            }

            container.innerHTML = sorted.map(([category, amount]) => `
                <div class="budget-item">
                    <div class="budget-info">
                        <div class="budget-category">${category}</div>
                    </div>
                    <div class="budget-amount">$${amount.toFixed(2)}</div>
                </div>
            `).join('');
        }

        // AI Insights
        function generateAIInsights() {
            const insights = [];
            const currentExpenses = getCurrentMonthExpenses();
            
            // Separate shared and individual expenses for analysis
            const sharedExpenses = currentExpenses.filter(exp => exp.isShared !== false);
            const individualExpenses = currentExpenses.filter(exp => exp.isShared === false);
            
            const totalSpent = currentExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalSharedSpent = sharedExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalIndividualSpent = individualExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalBudget = appState.budgets.total || 0;
            
            // Shared vs Individual ratio insights
            if (totalSpent > 0) {
                const sharedRatio = (totalSharedSpent / totalSpent) * 100;
                if (!window._isSoloSpace && sharedRatio < 30) {
                    insights.push({
                        text: `Only ${sharedRatio.toFixed(0)}% of spending is shared ‚Äî consider tracking more group expenses`,
                        type: 'info'
                    });
                } else if (!window._isSoloSpace && sharedRatio > 90) {
                    insights.push({
                        text: `Most expenses (${sharedRatio.toFixed(0)}%) are shared ‚Äî good teamwork!`,
                        type: 'success'
                    });
                }
            }
            
            // Individual spending imbalance (only for shared spaces)
            if (!window._isSoloSpace) {
                const memberIndivTotals = {};
                Object.keys(appState.partners).forEach(key => {
                    memberIndivTotals[key] = individualExpenses.filter(exp => exp.whoPaid === key).reduce((sum, exp) => sum + exp.amount, 0);
                });
                const indivAmounts = Object.values(memberIndivTotals).filter(v => v > 0);
                if (indivAmounts.length >= 2) {
                    const maxIndiv = Math.max(...indivAmounts);
                    const minIndiv = Math.min(...indivAmounts);
                    if (minIndiv > 0 && maxIndiv / minIndiv > 2) {
                        const breakdown = Object.keys(memberIndivTotals).map(key => 
                            `${appState.partners[key]} $${memberIndivTotals[key].toFixed(0)}`
                        ).join(', ');
                        insights.push({
                            text: `Individual spending differs significantly: ${breakdown}`,
                            type: 'info'
                        });
                    }
                }
            }
            
            // Previous month comparison
            const prevMonth = new Date(appState.currentMonth);
            prevMonth.setMonth(prevMonth.getMonth() - 1);
            const prevMonthExpenses = appState.expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === prevMonth.getMonth() && 
                       expenseDate.getFullYear() === prevMonth.getFullYear();
            });
            const prevMonthTotal = prevMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);

            if (prevMonthTotal > 0) {
                const change = ((totalSpent - prevMonthTotal) / prevMonthTotal * 100);
                if (Math.abs(change) > 10) {
                    insights.push({
                        text: `You spent ${Math.abs(change).toFixed(0)}% ${change > 0 ? 'more' : 'less'} this month vs last month`,
                        type: change > 0 ? 'warning' : 'success'
                    });
                }
            }

            // Partner balance insights (only for shared spaces)
            if (!window._isSoloSpace) {
                const balance = calculatePartnerBalance();
                if (Math.abs(balance.rawBalance) > 100) {
                    insights.push({
                        text: `${balance.rawBalance > 0 ? appState.partners.partner1 : (appState.partners.partner2 || 'Someone')} has covered more expenses ‚Äî consider rebalancing`,
                        type: 'info'
                    });
                }
            }

            // Budget warnings
            if (totalBudget > 0) {
                const budgetUsage = (totalSpent / totalBudget) * 100;
                if (budgetUsage > 90) {
                    insights.push({
                        text: `You've used ${budgetUsage.toFixed(0)}% of your monthly budget`,
                        type: 'danger'
                    });
                } else if (budgetUsage > 75) {
                    const daysLeft = new Date(appState.currentMonth.getFullYear(), appState.currentMonth.getMonth() + 1, 0).getDate() - new Date().getDate();
                    const currentPace = totalSpent / new Date().getDate();
                    const projectedTotal = currentPace * new Date(appState.currentMonth.getFullYear(), appState.currentMonth.getMonth() + 1, 0).getDate();
                    if (projectedTotal > totalBudget) {
                        insights.push({
                            text: `At current pace, you'll exceed your budget by $${(projectedTotal - totalBudget).toFixed(0)}`,
                            type: 'warning'
                        });
                    }
                }
            }

            // Category insights
            const categoryTotals = {};
            currentExpenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
            });

            const topCategory = Object.entries(categoryTotals).sort(([,a], [,b]) => b - a)[0];
            if (topCategory && topCategory[1] > totalSpent * 0.3) {
                insights.push({
                    text: `${topCategory[0]} accounts for ${((topCategory[1] / totalSpent) * 100).toFixed(0)}% of your spending`,
                    type: 'info'
                });
            }

            // Subscription check
            const subscriptionExpenses = currentExpenses.filter(exp => exp.category === 'Subscriptions');
            if (subscriptionExpenses.length > 5) {
                insights.push({
                    text: `You have ${subscriptionExpenses.length} subscription expenses ‚Äî check for unused services`,
                    type: 'info'
                });
            }

            // Calculate health score with better edge case handling
            let healthScore = 100;
            
            // Budget usage penalty (only if budget is set)
            if (totalBudget > 0 && totalSpent > 0) {
                const budgetUsage = (totalSpent / totalBudget) * 100;
                if (budgetUsage > 100) healthScore -= 30;
                else if (budgetUsage > 90) healthScore -= 20;
                else if (budgetUsage > 75) healthScore -= 10;
            } else if (totalBudget === 0 && totalSpent > 0) {
                // Small penalty for no budget set
                healthScore -= 5;
            }
            
            // Partner balance penalty (only for shared expenses)
            if (balance.rawBalance !== undefined && Math.abs(balance.rawBalance) > 200) {
                healthScore -= 15;
            }
            
            // Danger insight penalty
            const dangerCount = insights.filter(i => i.type === 'danger').length;
            if (dangerCount > 0) healthScore -= (dangerCount * 15);

            healthScore = Math.max(0, Math.min(100, healthScore));

            // Update health score display
            const healthCircle = document.getElementById('healthCircle');
            const scoreElement = document.getElementById('healthScore');
            healthCircle.style.setProperty('--score', healthScore);
            scoreElement.textContent = healthScore;

            const healthClass = healthScore >= 80 ? 'excellent' : healthScore >= 60 ? 'good' : 'poor';
            healthCircle.className = `health-circle ${healthClass}`;

            // Render insights
            const container = document.getElementById('aiInsights');
            if (insights.length === 0) {
                container.innerHTML = '<div class="insight-item">Everything looks good! Your spending is on track.</div>';
            } else {
                container.innerHTML = insights.map(insight => `
                    <div class="insight-item ${insight.type || 'info'}">
                        ${insight.text}
                    </div>
                `).join('');
            }
        }

        // Transactions Management
        const CATEGORY_COLORS = {
            'Food/Dining': '#f59e0b', 'Groceries': '#10b981', 'Rent/Housing': '#6366f1',
            'Utilities': '#8b5cf6', 'Transport': '#3b82f6', 'Entertainment': '#ec4899',
            'Subscriptions': '#f97316', 'Health': '#ef4444', 'Shopping': '#14b8a6',
            'Travel': '#06b6d4', 'Gifts': '#d946ef', 'Insurance': '#64748b',
            'Education': '#0ea5e9', 'Personal Care': '#f472b6', 'Pets': '#a3e635',
            'Home Maintenance': '#78716c', 'Alcohol/Bars': '#be123c', 'Coffee/Cafe': '#92400e',
            'Fitness/Gym': '#16a34a', 'Clothing': '#7c3aed', 'Electronics': '#0891b2',
            'Charity/Donations': '#e879f9', 'Parking': '#475569', 'Phone/Internet': '#2563eb',
            'Other': '#6b7280'
        };

        function getCategoryColor(category) {
            return CATEGORY_COLORS[category] || '#6b7280';
        }

        function renderTransactions() {
            const container = document.getElementById('expensesList');
            const filteredExpenses = getFilteredExpenses();

            if (filteredExpenses.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí≥</div><h3>No transactions found</h3><p>Try adjusting your filters or add some expenses</p></div>';
                return;
            }

            container.innerHTML = filteredExpenses
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(expense => {
                    const isShared = expense.isShared !== false;
                    const paidByPartner1 = expense.whoPaid === 'partner1';
                    const borderColor = paidByPartner1 ? '#6366f1' : '#06b6d4';
                    const paidByName = appState.partners[expense.whoPaid] || 'Unknown';
                    const paidBadgeBg = paidByPartner1 ? 'rgba(99,102,241,0.2)' : 'rgba(6,182,212,0.2)';
                    const paidBadgeColor = paidByPartner1 ? '#818cf8' : '#22d3ee';
                    const sharedBg = isShared ? 'rgba(99,102,241,0.06)' : 'rgba(245,158,11,0.06)';
                    const sharedBadgeBg = isShared ? 'rgba(99,102,241,0.15)' : 'rgba(245,158,11,0.15)';
                    const sharedBadgeColor = isShared ? '#a5b4fc' : '#fbbf24';
                    const splitText = isShared ? 
                        (expense.splitType === '50/50' ? '50/50' : 
                         expense.splitType === 'custom' ? `${expense.customSplit}/${100-expense.customSplit}` : 
                         'Single') : 'Individual';
                    const catColor = getCategoryColor(expense.category);
                    
                    return `
                        <div data-expense-id="${expense.id}" style="background: ${sharedBg}; border-left: 4px solid ${borderColor}; border-radius: 12px; padding: 14px 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; transition: opacity 0.3s;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; flex-wrap: wrap;">
                                    <span style="background: ${sharedBadgeBg}; color: ${sharedBadgeColor}; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">${isShared ? 'üë• Shared' : 'üë§ Individual'}</span>
                                    <span style="background: rgba(255,255,255,0.05); color: ${catColor}; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 500; border: 1px solid ${catColor}40;">${expense.category}</span>
                                    <span style="background: ${paidBadgeBg}; color: ${paidBadgeColor}; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 500;">${paidByName}</span>
                                    <span style="color: var(--text-secondary); font-size: 12px;">${splitText}</span>
                                </div>
                                <div style="display: flex; align-items: baseline; gap: 8px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">${new Date(expense.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}</span>
                                    ${expense.notes ? `<span style="color: var(--text-secondary); font-size: 13px;">¬∑ ${expense.notes}</span>` : ''}
                                    ${expense.isRecurring ? '<span style="font-size: 12px;">üîÑ</span>' : ''}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="font-size: 18px; font-weight: 700; color: var(--text-primary); white-space: nowrap;">$${expense.amount.toFixed(2)}</div>
                                <div style="display: flex; gap: 4px;">
                                    <button class="btn btn-secondary btn-small" onclick="editExpense(${expense.id})">‚úèÔ∏è</button>
                                    <button class="btn btn-danger btn-small" onclick="deleteExpense(${expense.id})">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function getFilteredExpenses() {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const personFilter = document.getElementById('personFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;

            return appState.expenses.filter(expense => {
                // Migrate old expenses without isShared field
                if (expense.isShared === undefined) {
                    expense.isShared = true;
                }
                
                if (searchTerm && !expense.notes.toLowerCase().includes(searchTerm) && 
                    !expense.category.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                if (categoryFilter && expense.category !== categoryFilter) return false;
                if (personFilter && expense.whoPaid !== personFilter) return false;
                if (typeFilter) {
                    const isShared = expense.isShared !== false; // Default to true for backwards compatibility
                    if (typeFilter === 'shared' && !isShared) return false;
                    if (typeFilter === 'individual' && isShared) return false;
                }
                if (monthFilter) {
                    const expenseMonth = new Date(expense.date).toISOString().substring(0, 7);
                    if (expenseMonth !== monthFilter) return false;
                }
                return true;
            });
        }

        function filterTransactions() {
            renderTransactions();
        }

        function exportTransactions(format) {
            const expenses = getFilteredExpenses().sort((a, b) => new Date(b.date) - new Date(a.date));
            if (expenses.length === 0) {
                showToast('No transactions to export', 'error');
                return;
            }

            const headers = ['Date', 'Category', 'Amount', 'Paid By', 'Type', 'Split', 'Notes', 'Recurring'];
            const rows = expenses.map(e => {
                const paidBy = appState.partners[e.whoPaid] || e.whoPaid;
                const isShared = e.isShared !== false;
                const split = isShared ? 
                    (e.splitType === '50/50' ? '50/50' : 
                     e.splitType === 'custom' ? `${e.customSplit}/${100-e.customSplit}` : 
                     'Single Payer') : 'N/A';
                return [
                    e.date,
                    e.category,
                    e.amount.toFixed(2),
                    paidBy,
                    isShared ? 'Shared' : 'Individual',
                    split,
                    (e.notes || '').replace(/"/g, '""'),
                    e.isRecurring ? 'Yes' : 'No'
                ];
            });

            if (format === 'csv') {
                const csv = [headers.join(','), ...rows.map(r => r.map(v => `"${v}"`).join(','))].join('\n');
                downloadFile(csv, 'transactions.csv', 'text/csv');
            } else {
                // Excel XML format (opens natively in Excel)
                let xml = '<?xml version="1.0"?>\n<?mso-application progid="Excel.Sheet"?>\n';
                xml += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"\n';
                xml += ' xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n';
                xml += '<Styles><Style ss:ID="header"><Font ss:Bold="1"/><Interior ss:Color="#4F46E5" ss:Pattern="Solid"/><Font ss:Color="#FFFFFF" ss:Bold="1"/></Style>';
                xml += '<Style ss:ID="currency"><NumberFormat ss:Format="$#,##0.00"/></Style></Styles>\n';
                xml += '<Worksheet ss:Name="Transactions"><Table>\n';
                // Header row
                xml += '<Row>';
                headers.forEach(h => { xml += `<Cell ss:StyleID="header"><Data ss:Type="String">${h}</Data></Cell>`; });
                xml += '</Row>\n';
                // Data rows
                rows.forEach(r => {
                    xml += '<Row>';
                    r.forEach((v, i) => {
                        if (i === 2) { // Amount column
                            xml += `<Cell ss:StyleID="currency"><Data ss:Type="Number">${v}</Data></Cell>`;
                        } else {
                            xml += `<Cell><Data ss:Type="String">${v.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</Data></Cell>`;
                        }
                    });
                    xml += '</Row>\n';
                });
                xml += '</Table></Worksheet></Workbook>';
                downloadFile(xml, 'transactions.xls', 'application/vnd.ms-excel');
            }
            showToast(`Exported ${expenses.length} transactions! üì•`, 'success');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType + ';charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        // Track which expense is being edited (null = adding new)
        let editingExpenseId = null;

        function editExpense(id) {
            const expense = appState.expenses.find(e => e.id === id);
            if (!expense) return;

            editingExpenseId = id;

            // Fill form with expense data
            document.getElementById('amount').value = expense.amount;
            document.getElementById('category').value = expense.category;
            document.getElementById('whoPaid').value = expense.whoPaid;
            document.getElementById('splitType').value = expense.splitType;
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('notes').value = expense.notes || '';
            document.getElementById('isRecurring').checked = expense.isRecurring || false;
            document.getElementById('isShared').checked = expense.isShared !== false;
            
            if (expense.customSplit) {
                document.getElementById('customSplit').value = expense.customSplit;
                document.getElementById('customSplitGroup').style.display = 'block';
            }

            handleSharedToggle();

            // Update button text and show cancel option
            const submitBtn = document.querySelector('#expenseForm button[type="submit"]');
            submitBtn.textContent = 'üíæ Update Expense';
            
            // Add cancel edit button if not already present
            if (!document.getElementById('cancelEditBtn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.id = 'cancelEditBtn';
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.textContent = '‚úñ Cancel Edit';
                cancelBtn.style.marginLeft = '8px';
                cancelBtn.onclick = cancelEdit;
                submitBtn.parentNode.insertBefore(cancelBtn, submitBtn.nextSibling);
            }

            switchTab('add-expense');
        }

        function cancelEdit() {
            editingExpenseId = null;
            document.getElementById('expenseForm').reset();
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('isShared').checked = true;
            handleSharedToggle();
            const submitBtn = document.querySelector('#expenseForm button[type="submit"]');
            submitBtn.textContent = 'üíæ Add Expense';
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) cancelBtn.remove();
        }

        // Budget Management
        let _savingBudgets = false;
        function saveBudgets() {
            if (_savingBudgets) return;
            _savingBudgets = true;
            const shared = parseFloat(document.getElementById('sharedBudget').value);
            if (!isNaN(shared)) appState.budgets.shared = shared;
            
            // Save per-member budgets dynamically
            let memberTotal = 0;
            Object.keys(appState.partners).forEach(key => {
                const input = document.getElementById('budget_' + key);
                if (input) {
                    const val = parseFloat(input.value);
                    if (!isNaN(val)) {
                        appState.budgets[key + 'Total'] = val;
                        memberTotal += val;
                    }
                }
            });
            
            // Keep backward compat: total = shared + all member budgets
            appState.budgets.total = (appState.budgets.shared || 0) + memberTotal;
            saveData();
            updateDisplay();
            renderBudget();
            showToast('Budgets saved! ‚úÖ', 'success');
            _savingBudgets = false;
        }

        // Migrate old budget format
        function migrateBudgets() {
            if (appState.budgets.total && !appState.budgets.shared && !appState.budgets.partner1Total) {
                appState.budgets.shared = appState.budgets.total;
                saveData();
            }
        }

        function renderBudget() {
            migrateBudgets();
            const solo = window._isSoloSpace;
            
            // Set budget inputs
            document.getElementById('sharedBudget').value = appState.budgets.shared || '';
            
            // Render per-member budget cards dynamically
            const memberCards = document.getElementById('memberBudgetCards');
            if (memberCards) {
                memberCards.innerHTML = Object.keys(appState.partners).map(key => {
                    const name = appState.partners[key];
                    const val = appState.budgets[key + 'Total'] || '';
                    return `<div class="glass-card" style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 20px;">üë§ ${name}'s Personal Budget</h3>
                        <div class="form-group">
                            <label class="form-label">Monthly Personal Budget</label>
                            <input type="number" class="form-input" id="budget_${key}" placeholder="Enter personal budget" step="0.01" value="${val}">
                            <button class="btn" onclick="saveBudgets()" style="margin-top: 12px;">Save</button>
                        </div>
                    </div>`;
                }).join('');
            }

            // Hide shared budget section for solo spaces
            const sharedBudgetCard = document.getElementById('sharedBudget')?.closest('.glass-card');
            if (sharedBudgetCard) {
                sharedBudgetCard.style.display = solo ? 'none' : '';
            }

            // Update month display
            const budgetMonth = document.getElementById('budgetMonth');
            if (budgetMonth) budgetMonth.textContent = appState.currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Render category budgets
            const container = document.getElementById('budgetCategories');
            const currentExpenses = getCurrentMonthExpenses();
            const categorySpending = {};

            currentExpenses.forEach(expense => {
                categorySpending[expense.category] = (categorySpending[expense.category] || 0) + expense.amount;
            });

            const budgetItems = appState.categories.map(category => {
                const spent = categorySpending[category] || 0;
                const budget = appState.budgets[category] || 0;
                const percentage = budget > 0 ? (spent / budget) * 100 : 0;
                const isOverBudget = spent > budget && budget > 0;

                return `
                    <div class="budget-item">
                        <div class="budget-info">
                            <div class="budget-category">${category}</div>
                            <div class="budget-spent">$${spent.toFixed(2)} spent</div>
                            ${budget > 0 ? `
                                <div class="progress-bar">
                                    <div class="progress-fill ${isOverBudget ? 'danger' : percentage > 75 ? 'warning' : ''}" 
                                         style="width: ${Math.min(percentage, 100)}%"></div>
                                </div>
                            ` : ''}
                        </div>
                        <input type="number" class="form-input" style="width: 120px;" 
                               placeholder="Budget" value="${budget || ''}" 
                               onchange="setCategoryBudget('${category}', this.value)">
                    </div>
                `;
            }).join('');

            container.innerHTML = budgetItems;
        }

        function setCategoryBudget(category, value) {
            const budget = parseFloat(value) || 0;
            if (budget >= 0) {
                appState.budgets[category] = budget;
                saveData();
                renderBudget();
                updateDisplay();
            }
        }

        // Settlement Management
        function renderSettlement() {
            const solo = window._isSoloSpace;
            const amount = document.getElementById('settlementAmount');
            const label = document.getElementById('settlementLabel');
            const button = document.getElementById('settleButton');
            const breakdownDiv = document.getElementById('paymentBreakdown');

            if (solo) {
                amount.textContent = '‚Äî';
                amount.className = 'settlement-amount';
                label.textContent = 'Settlement is for shared spaces';
                button.style.display = 'none';
                breakdownDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Add members to your space to see settlement details.</p>';
                return;
            }

            const balance = calculatePartnerBalance();
            amount.textContent = balance.amount;
            amount.className = `settlement-amount ${balance.rawBalance > 0 ? 'positive' : balance.rawBalance < 0 ? 'negative' : ''}`;
            label.textContent = balance.label;

            if (Math.abs(balance.rawBalance) < 0.01) {
                button.style.display = 'none';
            } else {
                button.style.display = 'inline-flex';
            }

            renderPaymentBreakdown();
        }

        function renderPaymentBreakdown() {
            // Only shared expenses matter for settlement breakdown
            const sharedExpenses = getCurrentMonthExpenses().filter(e => e.isShared !== false);
            const partnerKeys = Object.keys(appState.partners);
            const numMembers = partnerKeys.length;

            // Calculate what each member paid
            const paidByMember = {};
            partnerKeys.forEach(key => { paidByMember[key] = 0; });
            sharedExpenses.forEach(e => {
                if (paidByMember[e.whoPaid] !== undefined) paidByMember[e.whoPaid] += e.amount;
            });

            const total = Object.values(paidByMember).reduce((a, b) => a + b, 0);
            const fairShare = numMembers > 0 ? total / numMembers : 0;

            const container = document.getElementById('paymentBreakdown');
            let html = '';

            partnerKeys.forEach(key => {
                const paid = paidByMember[key] || 0;
                html += `
                    <div class="budget-item">
                        <div class="budget-info">
                            <div class="budget-category">${appState.partners[key]} paid (shared expenses)</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${total > 0 ? (paid / total * 100) : 0}%"></div>
                            </div>
                            <div class="budget-spent">Fair share: $${fairShare.toFixed(2)}</div>
                        </div>
                        <div class="budget-amount">$${paid.toFixed(2)}</div>
                    </div>
                `;
            });

            html += `
                <div class="budget-item" style="border-top: 1px solid var(--glass-border); padding-top: 16px; margin-top: 8px;">
                    <div class="budget-info">
                        <div class="budget-category">Total shared expenses</div>
                    </div>
                    <div class="budget-amount">$${total.toFixed(2)}</div>
                </div>
            `;

            container.innerHTML = html;
        }

        let _settling = false;
        function settleUp() {
            if (_settling) return;
            if (confirm('Mark all balances as settled? This will add a settlement transaction.')) {
                const balance = calculatePartnerBalance();
                if (Math.abs(balance.rawBalance) > 0.01) {
                    _settling = true;
                    const btn = document.getElementById('settleButton');
                    if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Settling...'; }
                    const settlementExpense = {
                        id: Date.now(),
                        amount: Math.abs(balance.rawBalance),
                        category: 'Settlement',
                        whoPaid: balance.rawBalance < 0 ? 'partner1' : 'partner2',
                        splitType: 'single',
                        date: new Date().toISOString().split('T')[0],
                        notes: 'Settlement payment',
                        isRecurring: false,
                        isShared: false,
                        timestamp: new Date()
                    };
                    
                    addExpense(settlementExpense);
                    updateDisplay();
                    renderSettlement();
                    showToast('Settled! ü§ù', 'success');
                    _settling = false;
                    if (btn) { btn.disabled = false; btn.textContent = '‚úÖ Mark as Settled'; }
                } else {
                    showToast('No balance to settle!', 'info');
                }
            }
        }

        // Charts
        let currentAnalyticsView = 'combined';

        function setAnalyticsView(view, btn) {
            currentAnalyticsView = view;
            // Update active button
            document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            renderCharts();
        }

        function getAnalyticsExpenses() {
            const expenses = getCurrentMonthExpenses();
            if (currentAnalyticsView === 'combined') return expenses;
            if (currentAnalyticsView === 'shared') return expenses.filter(e => e.isShared !== false);
            // Any partner key (partner1, partner2, partner3, etc.)
            if (currentAnalyticsView.startsWith('partner')) {
                return expenses.filter(e => e.whoPaid === currentAnalyticsView);
            }
            return expenses;
        }

        function renderCharts() {
            // Update analytics month display
            const analyticsMonth = document.getElementById('analyticsMonth');
            if (analyticsMonth) {
                analyticsMonth.textContent = appState.currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            }

            // Dynamically build per-member view buttons
            const btnContainer = document.getElementById('analyticsViewButtons');
            if (btnContainer) {
                // Keep combined + shared buttons, add per-member
                let html = `<button class="tab-btn ${currentAnalyticsView === 'combined' ? 'active' : ''}" data-view="combined" onclick="setAnalyticsView('combined', this)">üìä Combined</button>`;
                if (!window._isSoloSpace) {
                    html += `<button class="tab-btn ${currentAnalyticsView === 'shared' ? 'active' : ''}" data-view="shared" onclick="setAnalyticsView('shared', this)">üë• Shared Only</button>`;
                }
                Object.keys(appState.partners).forEach(key => {
                    html += `<button class="tab-btn ${currentAnalyticsView === key ? 'active' : ''}" data-view="${key}" onclick="setAnalyticsView('${key}', this)">üë§ ${appState.partners[key]}</button>`;
                });
                btnContainer.innerHTML = html;
            }

            renderCategoryChart();
            renderPartnerChart();
            renderMonthlyChart();
            renderDailyChart();
        }

        function renderCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            // Destroy existing chart to prevent memory leaks
            if (window.categoryChart instanceof Chart) {
                window.categoryChart.destroy();
            }
            
            const expenses = getAnalyticsExpenses();
            const categoryTotals = {};

            expenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
            });

            let data = Object.entries(categoryTotals).map(([category, amount]) => ({
                label: category,
                amount: amount
            })).sort((a, b) => b.amount - a.amount);

            // Handle empty data
            if (data.length === 0) {
                data = [{ label: 'No expenses yet', amount: 1 }];
            }

            window.categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.label),
                    datasets: [{
                        data: data.map(d => d.amount),
                        backgroundColor: [
                            '#6366f1', '#06b6d4', '#10b981', '#f59e0b', '#ef4444',
                            '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#84cc16'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    }
                }
            });
        }

        function renderPartnerChart() {
            const ctx = document.getElementById('partnerChart').getContext('2d');
            
            // Destroy existing chart to prevent memory leaks
            if (window.partnerChart instanceof Chart) {
                window.partnerChart.destroy();
            }
            
            const expenses = getAnalyticsExpenses();
            
            // Separate shared and individual expenses
            const sharedExpenses = expenses.filter(e => e.isShared !== false);
            const individualExpenses = expenses.filter(e => e.isShared === false);
            
            const partnerKeys = Object.keys(appState.partners);
            const sharedColors = ['#6366f1', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
            const indivColors = ['#8b5cf6', '#14b8a6', '#84cc16', '#f97316', '#d946ef', '#0ea5e9', '#f472b6'];

            const data = [];
            const labels = [];
            const colors = [];

            partnerKeys.forEach((key, i) => {
                const sharedAmt = sharedExpenses.filter(e => e.whoPaid === key).reduce((sum, e) => sum + e.amount, 0);
                const indivAmt = individualExpenses.filter(e => e.whoPaid === key).reduce((sum, e) => sum + e.amount, 0);
                if (sharedAmt > 0) {
                    data.push(sharedAmt);
                    labels.push(`${appState.partners[key]} (Shared)`);
                    colors.push(sharedColors[i % sharedColors.length]);
                }
                if (indivAmt > 0) {
                    data.push(indivAmt);
                    labels.push(`${appState.partners[key]} (Individual)`);
                    colors.push(indivColors[i % indivColors.length]);
                }
            });
            
            // Handle empty data
            if (data.length === 0) {
                data.push(1);
                labels.push('No expenses yet');
                colors.push('#4b5563');
            }

            window.partnerChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    }
                }
            });
        }

        function renderMonthlyChart() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            
            // Destroy existing chart to prevent memory leaks
            if (window.monthlyChart instanceof Chart) {
                window.monthlyChart.destroy();
            }
            
            const months = [];
            const totals = [];

            for (let i = 5; i >= 0; i--) {
                const month = new Date();
                month.setMonth(month.getMonth() - i);
                const monthExpenses = appState.expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getMonth() === month.getMonth() && 
                           expenseDate.getFullYear() === month.getFullYear();
                });
                
                months.push(month.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
                totals.push(monthExpenses.reduce((sum, e) => sum + e.amount, 0));
            }

            window.monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Monthly Spending',
                        data: totals,
                        backgroundColor: '#6366f1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#ffffff' },
                            grid: { color: '#374151' }
                        },
                        x: {
                            ticks: { color: '#ffffff' },
                            grid: { color: '#374151' }
                        }
                    }
                }
            });
        }

        function renderDailyChart() {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            // Destroy existing chart to prevent memory leaks
            if (window.dailyChart instanceof Chart) {
                window.dailyChart.destroy();
            }
            
            const expenses = getAnalyticsExpenses();
            
            const daysInMonth = new Date(appState.currentMonth.getFullYear(), appState.currentMonth.getMonth() + 1, 0).getDate();
            const dailyTotals = new Array(daysInMonth).fill(0);
            const cumulativeSpending = [];
            
            expenses.forEach(expense => {
                const day = new Date(expense.date).getDate();
                dailyTotals[day - 1] += expense.amount;
            });

            let cumulative = 0;
            for (let i = 0; i < daysInMonth; i++) {
                cumulative += dailyTotals[i];
                cumulativeSpending.push(cumulative);
            }

            const totalBudget = appState.budgets.total || 0;
            const budgetLine = totalBudget > 0 ? 
                new Array(daysInMonth).fill().map((_, i) => (totalBudget / daysInMonth) * (i + 1)) :
                new Array(daysInMonth).fill(0);

            window.dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: daysInMonth}, (_, i) => i + 1),
                    datasets: [
                        {
                            label: 'Cumulative Spending (All)',
                            data: cumulativeSpending,
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            fill: true
                        },
                        {
                            label: 'Budget Pace',
                            data: budgetLine,
                            borderColor: '#10b981',
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#ffffff' },
                            grid: { color: '#374151' }
                        },
                        x: {
                            ticks: { color: '#ffffff' },
                            grid: { color: '#374151' }
                        }
                    }
                }
            });
        }

        // Settings Management
        function renderMemberNameInputs() {
            const container = document.getElementById('memberNameInputs');
            if (!container) return;
            container.innerHTML = '';
            Object.keys(appState.partners).forEach(key => {
                const div = document.createElement('div');
                div.className = 'form-group';
                const label = document.createElement('label');
                label.className = 'form-label';
                label.textContent = appState.partners[key] || key;
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-input';
                input.id = 'memberName_' + key;
                input.placeholder = 'Enter name';
                input.value = appState.partners[key] || '';
                div.appendChild(label);
                div.appendChild(input);
                container.appendChild(div);
            });
        }

        function savePartnerNames() {
            Object.keys(appState.partners).forEach(key => {
                const input = document.getElementById('memberName_' + key);
                if (input && input.value.trim()) {
                    appState.partners[key] = input.value.trim();
                }
            });
            
            saveData();
            populateSelectors();
            updateDisplay();
            showToast('Names saved!', 'success');
        }

        function exportData() {
            const data = {
                expenses: appState.expenses,
                budgets: appState.budgets,
                partners: appState.partners,
                categories: appState.categories,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finsync-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('This will replace all current data. Continue?')) {
                        appState.expenses = data.expenses || [];
                        appState.budgets = data.budgets || {};
                        appState.partners = data.partners || appState.partners;
                        appState.categories = data.categories || appState.categories;
                        
                        saveData();
                        initializeApp();
                        updateDisplay();
                        
                        alert('Data imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing data. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('This will delete ALL data permanently. Are you sure?')) {
                if (confirm('Really sure? This cannot be undone!')) {
                    if (currentUser) {
                        localStorage.removeItem(`finSyncData_${currentUser}`);
                        localStorage.removeItem(`finSyncOnboarded_${currentUser}`);
                    }
                    appState.expenses = [];
                    appState.budgets = {};
                    location.reload();
                }
            }
        }

        function addCustomCategory() {
            const input = document.getElementById('newCategory');
            const category = input.value.trim();
            
            if (category && !appState.categories.includes(category)) {
                appState.categories.push(category);
                saveData();
                populateSelectors();
                renderCustomCategories();
                input.value = '';
            }
        }

        function removeCustomCategory(category) {
            if (confirm(`Remove category "${category}"? Existing expenses will keep this category.`)) {
                appState.categories = appState.categories.filter(c => c !== category);
                saveData();
                populateSelectors();
                renderCustomCategories();
            }
        }

        function renderHouseholdInfo() {
            const card = document.getElementById('householdInfoCard');
            if (!useApi || !currentHouseholdId) {
                card.style.display = 'none';
                return;
            }
            card.style.display = 'block';
            document.getElementById('settingsHouseholdName').textContent = window._householdName || 'My Space';
            document.getElementById('settingsInviteCode').textContent = window._householdInviteCode || '‚Äî';
            const members = window._householdMembers || [];
            const myId = parseInt(localStorage.getItem('finSyncUserId'));
            const listEl = document.getElementById('settingsMembersList');
            const isOwner = members.some(m => m.user_id === myId && m.role === 'owner');
            if (members.length === 0) {
                listEl.innerHTML = '<span style="color: var(--text-secondary);">Just you</span>';
            } else {
                listEl.innerHTML = members.map(m => {
                    const isMe = m.user_id === myId;
                    const role = m.role === 'owner' ? 'üëë' : 'üë§';
                    const kickBtn = (isOwner && !isMe) ? `<button onclick="kickMember(${m.user_id}, '${(m.partner_name || m.name).replace(/'/g, "\\'")}')" style="background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); color: #f87171; padding: 3px 8px; border-radius: 6px; font-size: 11px; cursor: pointer; font-family: inherit; white-space: nowrap;">‚úï Remove</button>` : '';
                    return `<div style="display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: rgba(255,255,255,0.04); border-radius: 8px; margin-bottom: 4px;">
                        <span>${role}</span>
                        <span style="color: var(--text-primary); font-weight: ${isMe ? '600' : '400'}; flex: 1;">${m.partner_name || m.name}${isMe ? ' (you)' : ''}</span>
                        ${kickBtn}
                    </div>`;
                }).join('');
            }
        }

        function copyInviteCode() {
            const code = window._householdInviteCode;
            if (!code) { showToast('No invite code available', 'error'); return; }
            navigator.clipboard.writeText(code).then(() => {
                const btn = document.getElementById('copyCodeBtn');
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => { btn.textContent = 'üìã Copy Code'; }, 2000);
                showToast('Invite code copied!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const ta = document.createElement('textarea');
                ta.value = code;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast('Invite code copied!', 'success');
            });
        }

        function getInviteLink(code) {
            return 'https://gary-yong.com/budget.html?invite=' + code;
        }

        async function shareInvite() {
            const code = window._householdInviteCode;
            const spaceName = window._householdName || 'my budget space';
            const link = getInviteLink(code);
            const shareText = `Join my FinSync budget space "${spaceName}"!\n\n${link}`;

            if (navigator.share) {
                try {
                    await navigator.share({ title: 'Join my FinSync space', text: shareText, url: link });
                } catch (e) {
                    if (e.name !== 'AbortError') {
                        copyInviteLink();
                    }
                }
            } else {
                copyInviteLink();
            }
        }

        function copyInviteLink() {
            const code = window._householdInviteCode;
            const spaceName = window._householdName || 'my budget space';
            const link = getInviteLink(code);
            const msg = `Join my FinSync budget space "${spaceName}"!\n${link}`;
            navigator.clipboard.writeText(msg).then(() => {
                showToast('Invite link copied!', 'success');
            }).catch(() => {
                copyInviteCode();
            });
        }

        async function regenerateInviteCode() {
            if (!confirm('Generate a new invite code? The old code will stop working.')) return;
            const btn = document.getElementById('regenCodeBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';
            try {
                const data = await apiFetch('/households/' + currentHouseholdId + '/regenerate-code', { method: 'POST' });
                window._householdInviteCode = data.invite_code;
                document.getElementById('settingsInviteCode').textContent = data.invite_code;
                showToast('New invite code generated!', 'success');
            } catch (err) {
                showToast(err.message || 'Failed to regenerate code', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîë New Code';
            }
        }

        async function kickMember(userId, displayName) {
            if (!confirm(`Remove "${displayName}" from this space? They'll lose access to all shared data.`)) return;
            try {
                await apiFetch('/households/' + currentHouseholdId + '/members/' + userId, { method: 'DELETE' });
                showToast(displayName + ' has been removed', 'success');
                // Refresh data to update member list
                await loadDataFromApi();
                renderHouseholdInfo();
                renderSpaceSwitcher();
                adaptUIForSpaceType();
                updateDisplay();
            } catch (err) {
                showToast(err.message || 'Failed to remove member', 'error');
            }
        }

        function renderCustomCategories() {
            const defaultCategories = [
                'Food/Dining', 'Groceries', 'Rent/Housing', 'Utilities', 
                'Transport', 'Entertainment', 'Subscriptions', 'Health', 
                'Shopping', 'Travel', 'Gifts', 'Other'
            ];
            
            const customCategories = appState.categories.filter(c => !defaultCategories.includes(c));
            const container = document.getElementById('customCategoriesList');
            
            if (customCategories.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No custom categories yet</p>';
                return;
            }
            
            container.innerHTML = customCategories.map(category => `
                <div class="budget-item">
                    <div class="budget-info">
                        <div class="budget-category">${category}</div>
                    </div>
                    <button class="btn btn-danger btn-small" onclick="removeCustomCategory('${category}')">Remove</button>
                </div>
            `).join('');
        }

        // Recurring Expenses
        function renderRecurringExpenses() {
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            const recurringExpenses = appState.expenses.filter(e => e.isRecurring && e.date && e.category);
            const monthlyRecurring = recurringExpenses.filter(e => {
                const expenseMonth = e.date.substring(0, 7);
                return expenseMonth !== currentMonth;
            });
            
            let added = false;
            monthlyRecurring.forEach(expense => {
                // More specific check to prevent duplicates
                const exists = appState.expenses.some(e => 
                    e.category === expense.category &&
                    e.amount === expense.amount &&
                    e.whoPaid === expense.whoPaid &&
                    e.date.substring(0, 7) === currentMonth &&
                    (e.notes || '').includes('Auto-generated')
                );
                
                if (!exists) {
                    const newExpense = {
                        ...expense,
                        id: Date.now() + Math.random(),
                        date: `${currentMonth}-01`,
                        notes: `${expense.notes || expense.category} (Auto-generated)`,
                        timestamp: new Date(),
                        isShared: expense.isShared !== false // Preserve shared status
                    };
                    
                    appState.expenses.push(newExpense);
                    added = true;
                }
            });
            
            if (added) {
                saveData();
            }
        }

        // Utility Functions
        function populateSelectors() {
            // Category datalist (for the text input)
            const datalist = document.getElementById('categoryDatalist');
            if (datalist) {
                datalist.innerHTML = '';
                appState.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    datalist.appendChild(option);
                });
            }

            // Category filter dropdown (stays as select)
            const categoryFilter = document.getElementById('categoryFilter');
            if (categoryFilter) {
                const currentValue = categoryFilter.value;
                categoryFilter.innerHTML = '<option value="">All Categories</option>';
                appState.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });
                if (currentValue) categoryFilter.value = currentValue;
            }

            // Month filter
            const monthFilter = document.getElementById('monthFilter');
            const months = [...new Set(appState.expenses.map(e => e.date.substring(0, 7)))].sort().reverse();
            monthFilter.innerHTML = '<option value="">All Months</option>' + 
                months.map(month => `<option value="${month}">${new Date(month + '-01').toLocaleDateString('en-US', {month: 'long', year: 'numeric'})}</option>`).join('');

            // Dynamically populate whoPaid selector from all members
            const whoPaidSelect = document.getElementById('whoPaid');
            if (whoPaidSelect) {
                const currentVal = whoPaidSelect.value;
                whoPaidSelect.innerHTML = '';
                const partnerKeys = Object.keys(appState.partners);
                partnerKeys.forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = appState.partners[key];
                    whoPaidSelect.appendChild(option);
                });
                // Restore selection or default to partner1
                if (currentVal && partnerKeys.includes(currentVal)) {
                    whoPaidSelect.value = currentVal;
                } else if (partnerKeys.length > 0) {
                    whoPaidSelect.value = partnerKeys[0];
                }
                // Hide selector for solo spaces
                const whoPaidGroup = whoPaidSelect.closest('.form-group');
                if (whoPaidGroup) {
                    whoPaidGroup.style.display = partnerKeys.length <= 1 ? 'none' : '';
                }
            }

            // Dynamically populate person filter
            const personFilter = document.getElementById('personFilter');
            if (personFilter) {
                const currentVal = personFilter.value;
                personFilter.innerHTML = '<option value="">All People</option>';
                Object.keys(appState.partners).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = appState.partners[key];
                    personFilter.appendChild(option);
                });
                if (currentVal) personFilter.value = currentVal;
            }
        }

        // Receipt Scanning Functions (server-side AI via api.gary-yong.com)
        const RECEIPT_API = 'https://api.gary-yong.com/receipt/scan';
        let scannedItems = [];
        let currentReceiptImage = null;

        function handleReceiptFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image file', 'error');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                showToast('File too large ‚Äî max 10MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentReceiptImage = e.target.result;
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('uploadArea').style.display = 'none';
                document.getElementById('receiptPreview').style.display = 'block';
                document.getElementById('scanResults').classList.remove('show');
                scannedItems = [];
            };
            reader.readAsDataURL(file);
        }

        function clearReceipt() {
            currentReceiptImage = null;
            scannedItems = [];
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('receiptPreview').style.display = 'none';
            document.getElementById('scanResults').classList.remove('show');
            document.getElementById('receiptFile').value = '';
        }

        let _scanning = false;
        async function scanReceipt() {
            if (_scanning) return;
            if (!currentReceiptImage) {
                showToast('Please select an image first', 'error');
                return;
            }
            
            _scanning = true;
            document.getElementById('receiptPreview').style.display = 'none';
            document.getElementById('scanLoading').style.display = 'block';
            document.getElementById('scanResults').classList.remove('show');
            
            try {
                const response = await fetch(RECEIPT_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: currentReceiptImage }),
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || `Server error ${response.status}`);
                }
                
                if (!result.success) {
                    throw new Error(result.error || 'No transactions found in this image');
                }
                
                const parsedData = result.data;
                const receiptDate = parsedData.date || new Date().toISOString().split('T')[0];
                
                scannedItems = parsedData.items.map((item, index) => ({
                    id: `scanned-${Date.now()}-${index}`,
                    description: item.description || item.name || 'Unknown item',
                    amount: parseFloat(item.amount) || 0,
                    category: mapToAppCategory(item.category || 'Other'),
                    date: receiptDate,
                    selected: true,
                    shared: true,
                    whoPaid: 'partner1'
                }));
                
                document.getElementById('scanLoading').style.display = 'none';
                document.getElementById('receiptPreview').style.display = 'block';
                showScanResults(parsedData);
                showToast(`Found ${scannedItems.length} transaction${scannedItems.length !== 1 ? 's' : ''}!`, 'success');
                
            } catch (error) {
                document.getElementById('scanLoading').style.display = 'none';
                document.getElementById('receiptPreview').style.display = 'block';
                console.error('Scan error:', error);
                showToast(`Scan failed: ${error.message}`, 'error');
            } finally {
                _scanning = false;
            }
        }
        
        function mapToAppCategory(category) {
            // Map AI-suggested categories to exact app categories
            const mapping = {
                'food': 'Food/Dining', 'dining': 'Food/Dining', 'restaurant': 'Food/Dining',
                'grocery': 'Groceries', 'groceries': 'Groceries', 'supermarket': 'Groceries',
                'rent': 'Rent/Housing', 'housing': 'Rent/Housing', 'mortgage': 'Rent/Housing',
                'utilities': 'Utilities', 'utility': 'Utilities', 'bills': 'Utilities',
                'transport': 'Transport', 'transportation': 'Transport', 'gas': 'Transport', 'fuel': 'Transport',
                'entertainment': 'Entertainment', 'fun': 'Entertainment',
                'subscriptions': 'Subscriptions', 'subscription': 'Subscriptions',
                'health': 'Health', 'medical': 'Health', 'pharmacy': 'Health',
                'shopping': 'Shopping', 'clothes': 'Shopping', 'clothing': 'Shopping',
                'travel': 'Travel', 'hotel': 'Travel', 'flight': 'Travel',
                'gifts': 'Gifts', 'gift': 'Gifts',
            };
            
            // Check exact match first
            if (appState.categories.includes(category)) return category;
            
            // Check mapping
            const lower = category.toLowerCase();
            if (mapping[lower]) return mapping[lower];
            
            // Partial match
            for (const [key, val] of Object.entries(mapping)) {
                if (lower.includes(key) || key.includes(lower)) return val;
            }
            
            return 'Other';
        }

        function showScanResults(data) {
            const results = document.getElementById('scanResults');
            const list = document.getElementById('scanResultsList');
            
            list.innerHTML = scannedItems.map(item => `
                <div class="scan-result-item ${item.selected ? 'selected' : ''}" data-item-id="${item.id}">
                    <div class="result-header">
                        <input type="checkbox" class="result-checkbox" ${item.selected ? 'checked' : ''} 
                               onchange="toggleItemSelection('${item.id}')">
                        <strong>Item ${scannedItems.findIndex(i => i.id === item.id) + 1}</strong>
                    </div>
                    <div class="result-fields">
                        <div class="result-field">
                            <label>Description</label>
                            <input type="text" value="${item.description}" 
                                   onchange="updateItemField('${item.id}', 'description', this.value)">
                        </div>
                        <div class="result-field">
                            <label>Amount</label>
                            <input type="number" step="0.01" value="${item.amount}" 
                                   onchange="updateItemField('${item.id}', 'amount', parseFloat(this.value))">
                        </div>
                        <div class="result-field">
                            <label>Category</label>
                            <select onchange="updateItemField('${item.id}', 'category', this.value)">
                                ${appState.categories.map(cat => 
                                    `<option value="${cat}" ${cat === item.category ? 'selected' : ''}>${cat}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="result-field">
                            <label>Who Paid</label>
                            <select onchange="updateItemField('${item.id}', 'whoPaid', this.value)">
                                ${Object.keys(appState.partners).map(key => 
                                    `<option value="${key}" ${item.whoPaid === key ? 'selected' : ''}>${appState.partners[key]}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <label class="shared-toggle">
                            <input type="checkbox" ${item.shared ? 'checked' : ''} 
                                   onchange="updateItemField('${item.id}', 'shared', this.checked)">
                            <span>üë• Shared expense</span>
                        </label>
                    </div>
                </div>
            `).join('');
            
            updateScanSummary();
            results.classList.add('show');
        }

        function toggleItemSelection(itemId) {
            const item = scannedItems.find(i => i.id === itemId);
            if (item) {
                item.selected = !item.selected;
                const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
                itemElement.classList.toggle('selected', item.selected);
                updateScanSummary();
            }
        }

        function updateItemField(itemId, field, value) {
            const item = scannedItems.find(i => i.id === itemId);
            if (item) {
                item[field] = value;
                updateScanSummary();
            }
        }

        function updateScanSummary() {
            const selectedItems = scannedItems.filter(item => item.selected);
            const total = selectedItems.reduce((sum, item) => sum + item.amount, 0);
            
            document.getElementById('summaryTotal').textContent = `$${total.toFixed(2)}`;
            document.getElementById('summaryCount').textContent = 
                `${selectedItems.length} item${selectedItems.length !== 1 ? 's' : ''} selected`;
        }

        let _addingSelected = false;
        async function addSelectedExpenses() {
            if (_addingSelected) return;
            const selectedItems = scannedItems.filter(item => item.selected);
            
            if (selectedItems.length === 0) {
                showToast('Please select at least one item to add', 'warning');
                return;
            }

            _addingSelected = true;
            const btn = document.getElementById('addSelectedBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Adding ' + selectedItems.length + ' item' + (selectedItems.length > 1 ? 's' : '') + '...';
            btn.style.opacity = '0.6';
            
            let addedCount = 0;
            
            for (const item of selectedItems) {
                // Auto-add new categories from scanned items
                await ensureCategory(item.category);

                const expense = {
                    id: Date.now() + Math.random(),
                    amount: item.amount,
                    category: item.category,
                    whoPaid: item.whoPaid,
                    splitType: item.shared ? '50/50' : 'single',
                    customSplit: null,
                    date: item.date || new Date().toISOString().split('T')[0],
                    notes: item.description,
                    isRecurring: false,
                    isShared: item.shared,
                    timestamp: new Date()
                };
                
                if (useApi && currentHouseholdId) {
                    try {
                        const data = await apiFetch('/households/' + currentHouseholdId + '/expenses', {
                            method: 'POST',
                            body: JSON.stringify({
                                amount: expense.amount, category: expense.category, date: expense.date,
                                notes: expense.notes, isRecurring: false, isShared: expense.isShared,
                                paidBy: window._memberMap?.[expense.whoPaid] || expense.whoPaid,
                                splitType: expense.splitType, customSplit: null
                            })
                        });
                        if (data.expense) expense.id = data.expense.id;
                    } catch (err) { console.error('API add scanned expense failed:', err); }
                }

                addExpense(expense);
                addedCount++;
            }
            
            updateDisplay();
            renderTransactions();
            
            // Clear results and input
            scannedItems = [];
            document.getElementById('scanResults').classList.remove('show');
            const codeInput = document.getElementById('transactionCodeInput');
            if (codeInput) codeInput.value = '';
            
            showToast(`Added ${addedCount} expense${addedCount !== 1 ? 's' : ''}! üéâ`, 'success');

            // Reset button state
            btn.disabled = false;
            btn.textContent = '‚ûï Add Selected Items';
            btn.style.opacity = '1';
            _addingSelected = false;

            // Switch to transactions tab so user can SEE the added items
            switchTab('transactions');
        }

        // Initialize charts after page load
        setTimeout(renderCharts, 100);
    </script>
</body>
</html>